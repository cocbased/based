<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B•A•S•E•D — Home</title>

  <link rel="apple-touch-icon" href="icon-180.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="favicon.png">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --tabbar-h: 92px;
      --tabbar-bg: rgba(12,12,12,0.96);
      --tabbar-border: rgba(255,255,255,0.10);

      --m-emoji-col: 30px;
      --m-name-col: 102px;

      --cards-max: 680px;

      /* ✅ UI colors used for scrollbar + dividers */
      --card-bg: #0b1829;
      --card-border: #2b3b55;
      --scroll-track: rgba(0,0,0,0.22);
      --scroll-thumb: var(--card-border);

      --sep-strong: rgba(255,255,255,0.16);
      --sep-soft: rgba(255,255,255,0.10);
    }

    html{ overflow-y: scroll; scrollbar-gutter: stable both-edges; }

    /* ✅ Non-PWA scrollbar styling (safe to apply globally; mobile/PWA mostly ignores) */
    html, body{
      scrollbar-color: var(--scroll-thumb) var(--scroll-track);
      scrollbar-width: thin;
    }
    /* WebKit scrollbars */
    ::-webkit-scrollbar{ width: 10px; height: 10px; }
    ::-webkit-scrollbar-track{ background: var(--scroll-track); }
    ::-webkit-scrollbar-thumb{
      background: var(--scroll-thumb);
      border-radius: 999px;
      border: 2px solid var(--scroll-track);
    }
    ::-webkit-scrollbar-thumb:hover{ filter: brightness(1.08); }

    /* Scroll containers */
    .members-wrap::-webkit-scrollbar,
    .cwl-table-wrap::-webkit-scrollbar,
    .war-chart-wrap::-webkit-scrollbar,
    .dragscroll::-webkit-scrollbar{
      height: 10px;
    }
    .members-wrap::-webkit-scrollbar-track,
    .cwl-table-wrap::-webkit-scrollbar-track,
    .war-chart-wrap::-webkit-scrollbar-track,
    .dragscroll::-webkit-scrollbar-track{
      background: var(--scroll-track);
      border-radius: 999px;
    }
    .members-wrap::-webkit-scrollbar-thumb,
    .cwl-table-wrap::-webkit-scrollbar-thumb,
    .war-chart-wrap::-webkit-scrollbar-thumb,
    .dragscroll::-webkit-scrollbar-thumb{
      background: var(--scroll-thumb);
      border-radius: 999px;
      border: 2px solid var(--scroll-track);
    }

    .topnav{ flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .topnav::-webkit-scrollbar{ display:none; }
    .topnav a{ flex: 0 0 auto; }
    .stage, #app{ min-height: 0; }

    body, body *{
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    input, textarea, select, option, button{
      -webkit-user-select: text;
      user-select: text;
      -webkit-touch-callout: default;
    }

    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
      justify-content:flex-start;
      text-align:center;
      padding:24px 16px;
      box-sizing:border-box;
      overscroll-behavior-x: none;
    }

    .app-icon{ width:90px; height:90px; margin-bottom:12px; border-radius:20px; object-fit:contain; }
    .logo{ width:100%; max-width:225px; height:auto; margin-bottom:16px; object-fit:contain; }

    .clan-tag-link{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      font-size:14px;
      display:inline-block;
      margin:8px 0 10px;
    }
    .clan-tag-link:hover{ text-decoration:underline; opacity:1; }

    .topnav{
      width:100%;
      max-width:560px;
      display:flex;
      justify-content:center;
      gap:10px;
      padding:10px 8px 18px;
      box-sizing:border-box;
    }
    .topnav a{
      text-decoration:none;
      color:#fff;
      opacity:0.82;
      font-size:13px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      white-space:nowrap;
    }
    .topnav a.active{
      opacity:1;
      font-weight:700;
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.08);
    }

    .stage{ width:100%; max-width:560px; position:relative; flex:1; display:flex; justify-content:center; }
    #app{ width:100%; max-width:560px; display:flex; flex-direction:column; align-items:center; flex:1; touch-action:auto; }

    .cards{
      width:100%;
      max-width: min(var(--cards-max), 100%);
      margin-bottom:24px;
      padding:12px 16px;
      border-radius:12px;
      background: var(--card-bg);
      border:1px solid var(--card-border);
      box-sizing:border-box;
      text-align:left;
      display:flex;
      flex-direction:column;
    }
    .cards-title{ margin:0 0 6px; font-size:16px; text-align:center; font-weight:700; }
    .section-title{
      margin:10px 0 6px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.75;
      text-align:center;
    }
    .divider{ height:1px; background:rgba(255,255,255,.12); margin:10px 0; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:14px; padding:2px 0; gap:12px; }
    .row-label{ font-weight:600; white-space:nowrap; }
    .row-value{ font-family:monospace; text-align:right; flex:1; }

    .clan-desc-block{ text-align:center; white-space: pre-line; line-height: 1.25; opacity: .95; padding: 2px 0 6px; }
    #rankings-block{ display:none; }

    .war-board{ text-align:center; margin-top:6px; }
    .war-timer{ font-family:monospace; font-weight:900; font-size:14px; margin:6px 0 10px; }
    .war-grid-3{ display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; }
    .war-vs{ font-weight:900; font-size:14px; opacity:.7; }
    .war-name{
      font-weight:800; font-size:13px; letter-spacing:.05em;
      text-transform:uppercase; margin-bottom:6px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .war-stat, .war-substat{
      font-family:monospace; font-weight:900; font-size:14px;
      display:flex; justify-content:center; align-items:center; gap:6px;
    }
    .war-stat{ margin-top:6px; }
    .war-substat{ margin-top:8px; opacity:.95; }
    .war-green{ color:#38d172; font-weight:900; }
    .record-green{ color:#38d172; font-weight:900; }

    .dragscroll{
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      cursor: grab;
    }
    .dragscroll.is-dragging{ cursor: grabbing; }
    .dragscroll, .dragscroll *{
      -webkit-user-select: none;
      user-select: none;
    }

    .war-chart-wrap{ margin-top: 12px; }
    .war-mode-title{
      margin: 10px 0 10px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.75;
      text-align:center;
    }

    .war-chart-block{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      border-radius: 10px;
      overflow: hidden;
      color:#fff;
    }
    .war-chart-block + .war-chart-block{ margin-top: 10px; }

    .war-chart-head{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .war-chart-clan{
      display:flex;
      align-items:center;
      gap: 8px;
      font-weight: 900;
      letter-spacing: .03em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width: 0;
      justify-content:center;
    }

    .war-sheet{ width:100%; display:block; }

    .war-sheet-row{
      display:grid;
      grid-template-columns: 26px minmax(0, 1fr) minmax(0, 1fr) 40px 64px 36px;
      align-items: stretch;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      min-height: 38px;
    }
    .war-sheet-row:last-child{ border-bottom:none; }

    .war-cell{
      padding: 8px 8px;
      font-size: 12.5px;
      overflow: hidden;
      text-overflow: ellipsis;
      display:flex;
      align-items:center;
      gap:6px;
      border-right: none !important;
      color:#fff;
      min-width: 0;
    }

    .war-cell.stack { white-space: normal; }
    .war-cell.mono{ font-family: monospace; white-space:nowrap; }
    .war-cell.center{ justify-content:center; text-align:center; }
    .war-cell.right{ justify-content:flex-end; text-align:right; }
    .war-cell.bold{ font-weight: 900; }
    .war-cell.numcol{ padding-right: 6px; opacity: .95; }

    .war-player{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .war-player .name{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .war-player .role{
      font-size:11px;
      opacity:.70;
      white-space:nowrap;
    }
    .war-name-role{
      font-size:11px;
      opacity:.70;
      font-weight:600;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .war-leader-underline{
      text-decoration: underline;
      text-underline-offset: 2px;
      font-weight: 900;
    }

    .war-role-emoji{
      font-size:14px;
      line-height:1;
      transform: translateY(1px);
      flex: 0 0 auto;
      opacity: .95;
    }

    .atk2{ display:flex; flex-direction:column; gap:4px; width:100%; min-width:0; }
    .atkline{
      display:flex;
      align-items:center;
      width:100%;
      font-family:monospace;
      font-size:11px;
      opacity:.95;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    .war-cell.defender{ justify-content:flex-end; text-align:right; }
    .war-cell.defender .atk2{ align-items:flex-end; }
    .war-cell.defender .atkline{ justify-content:flex-end; text-align:right; }

    .stars{ display:flex; align-items:center; justify-content:center; gap:4px; font-variant-numeric: tabular-nums; }
    .star{
      font-size:13px; line-height:1;
      color: rgba(255,215,0,0.95);
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
    }
    .star.dim{ color: rgba(255,255,255,0.18); text-shadow:none; }
    .muted{ opacity:.65; }

    .tiny-status{
      text-align:center;
      font-family:monospace;
      font-size:11px;
      opacity:.70;
      margin-top: 8px;
    }

    @media (max-width: 420px){
      .war-cell.defender{ justify-content: flex-start; text-align: left; }
      .war-cell.defender .atk2{ align-items: flex-start; }
      .war-cell.defender .atkline{
        justify-content: flex-start;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }

    /* Members */
    .members-headerbar{
      background: transparent; border:none; border-radius:0;
      padding:0; margin:0 0 8px;
      display:grid;
      grid-template-columns: auto 1fr auto;
      grid-template-rows: auto auto;
      column-gap: 12px;
      row-gap: 6px;
      align-items:center;
    }
    .members-leaderline{ grid-column:1/2; grid-row:1/2; justify-self:start; }
    .members-elderline{ grid-column:1/2; grid-row:2/3; justify-self:start; }
    .members-keyline{ display:flex; align-items:center; gap:10px; white-space:nowrap; }
    .key-emoji{ font-size:14px; line-height:1; }
    .key-text{ font-size:12px; line-height:1.2; }
    .legend-underline{ text-decoration: underline; text-underline-offset: 2px; font-weight: 400; }
    .members-scroll-inline{
      grid-column:1/-1;
      grid-row:2/3;
      display:flex;
      justify-content:center;
      text-align:center;
      font-size:10px;
      letter-spacing:.03em;
      opacity:.78;
      white-space: nowrap;
      line-height: 1;
      pointer-events:none;
    }
    .members-sortbtn-wrap{ grid-column:3/4; grid-row:1/3; justify-self:end; align-self:center; }

    .sort-btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 58px;
      height: 36px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .sort-btn select{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .sort-btn select option{ background:#0b1829; color:#fff; }

    .members-wrap{
      width:100%;
      margin-top:2px;
      overflow-x:auto;
      overflow-y:visible;
      -webkit-overflow-scrolling: touch;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }
    .members-table{
      width:100%;
      min-width: 720px;
      border-collapse: separate;
      border-spacing: 0;
      font-size:13px;
      table-layout: fixed;
    }
    .members-table thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #0b1829;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding: 10px 10px;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space: nowrap;
    }
    .members-table th:nth-child(1),
    .members-table td:nth-child(1){
      position: sticky;
      left: 0;
      z-index: 7;
      background: #0b1829;
      border-right: none;
    }
    .members-table thead th:nth-child(1){ z-index: 9; }

    .members-table th:nth-child(2),
    .members-table td:nth-child(2){
      position: sticky;
      left: var(--m-emoji-col);
      z-index: 6;
      background: #0b1829;
      border-right: 1px solid rgba(255,255,255,0.10);
    }
    .members-table thead th:nth-child(2){ z-index: 8; }

    .members-table tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .members-table tbody tr:last-child td{ border-bottom:none; }
    .members-table td.m-emoji,
    .members-table th.m-emoji{
      overflow: visible !important;
      text-overflow: clip !important;
      white-space: nowrap !important;
    }
    .m-emoji{ text-align:right; font-size:14px; padding: 10px 6px 10px 10px; letter-spacing:0; }
    .m-user-name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .m-user-name.m-leader{ font-weight:400; text-decoration: underline; text-underline-offset: 2px; }
    .m-num{ font-family: monospace; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:clip; }

    .links{
      width:100%;
      max-width:280px;
      margin: 12px auto 0;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }
    .link-btn{
      width:100%;
      text-align:center;
      display:block;
      padding:12px;
      font-size:16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background-color:#fff;
      color:#000;
      text-decoration:none;
      box-sizing:border-box;
    }
    .install-btn{
      background-color:#ffcc00;
      color:#000;
      border:2px solid #000;
      padding:12px 20px;
      font-weight:700;
      border-radius:12px;
    }

    .page-footer{
      margin-top:auto;
      width:100%;
      padding:18px 0 0;
      font-size:14px;
      opacity:.7;
      text-align:center;
    }

    body.has-pwa-tabs{
      padding-bottom: calc(var(--tabbar-h) + var(--safe-bottom) + 10px);
    }
    .pwa-tabbar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--tabbar-h);
      padding-bottom: var(--safe-bottom);
      background: var(--tabbar-bg);
      border-top: 1px solid var(--tabbar-border);
      z-index: 9999;
      display: none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      will-change: transform;
      transform: translate3d(0,0,0);
      transition: transform 180ms cubic-bezier(.2,.8,.2,1);
    }
    .pwa-tabbar.is-hidden{
      transform: translate3d(0, calc(var(--tabbar-h) + var(--safe-bottom) + 6px), 0);
      pointer-events: none;
    }
    .pwa-tabbar .tabs{
      height: 100%;
      max-width: 560px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      align-items: center;
      padding: 10px 10px 12px;
      box-sizing: border-box;
      gap: 8px;
    }
    .pwa-tabbar a{
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      color:#fff;
      opacity: 0.78;
      border-radius: 16px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .tab-inner{
      width: 100%;
      height: 100%;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 10px 6px;
      box-sizing: border-box;
    }
    .pwa-tabbar a .icon{ width: 22px; height: 22px; display:block; transform: translateY(-3px); }
    .pwa-tabbar a .icon img{
      width: 22px;
      height: 22px;
      display:block;
      object-fit:contain;
      -webkit-user-drag:none;
      user-select:none;
      pointer-events:none;
    }
    .pwa-tabbar a .label{ font-size: 11px; line-height: 1; opacity: 0.95; transform: translateY(-2px); font-weight: 500; }
    .pwa-tabbar a.active{ opacity: 1; }

    /* =========================
       ✅ CWL
       ========================= */
    .cwl-headerbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 6px;
    }
    .cwl-headerbar .left{
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space:nowrap;
    }
    .cwl-pill{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 140px;
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .06em;
      text-transform: uppercase;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .cwl-pill select{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .cwl-pill select option{ background:#0b1829; color:#fff; }

    .cwl-table-wrap{
      width:100%;
      overflow-x:auto;
      overflow-y:visible;
      -webkit-overflow-scrolling: touch;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }
    .cwl-table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size:12.5px;
      table-layout: fixed;
    }
    .cwl-table thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #0b1829;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding: 10px 10px;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space: nowrap;
      text-align:center;
    }
    .cwl-table tbody td{
      padding: 9px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align:center;
      font-family: monospace;
    }
    .cwl-table tbody tr:last-child td{ border-bottom:none; }

    .cwl-table .left{ text-align:left; font-family: inherit; }
    .cwl-table .right{ text-align:right; }
    .cwl-table .mono{ font-family: monospace; }
    .cwl-table .bold{ font-weight:900; }
    .cwl-table .muted{ opacity:.70; }

    .cwl-wide{ min-width: 1220px; }
    .cwl-league{ min-width: 560px; }

    .cwl-table th.sticky-1,
    .cwl-table td.sticky-1{
      position: sticky;
      left: 0;
      z-index: 7;
      background: #0b1829;
      text-align:center;
      font-family: monospace;
    }
    .cwl-table th.sticky-2,
    .cwl-table td.sticky-2{
      position: sticky;
      left: 64px;
      z-index: 6;
      background: #0b1829;
      text-align:left;
      font-family: inherit;
      border-right: 1px solid rgba(255,255,255,0.10);
    }
    .cwl-table thead th.sticky-1{ z-index: 9; }
    .cwl-table thead th.sticky-2{ z-index: 8; }

    .cwl-dayhead{
      background: rgba(255,255,255,0.03);
      border-left: 1px solid rgba(255,255,255,0.08);
      border-right: 1px solid rgba(255,255,255,0.08);
    }

    .cwl-note{
      opacity:.75;
      font-size:13px;
      text-align:center;
      padding: 6px 0 2px;
    }

    /* ✅ CWL: headerbar that mimics Members (SCROLL perfectly centered, even with sort on right) */
    .cwl-subheaderbar{
      background: transparent; border:none; border-radius:0;
      padding:0; margin:0 0 8px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      grid-template-rows: auto;
      column-gap: 12px;
      align-items:center;
    }
    .cwl-scroll-inline{
      grid-column:2/3;
      display:flex;
      justify-content:center;
      text-align:center;
      font-size:10px;
      letter-spacing:.03em;
      opacity:.78;
      white-space: nowrap;
      line-height: 1;
      pointer-events:none;
      padding: 2px 0 0;
      justify-self:center;
    }
    .cwl-sortbtn-wrap{
      grid-column:3/4;
      justify-self:end;
      align-self:center;
    }

    /* ✅ CWL: visual separators */
    .cwl-general-sep{
      border-right: 2px solid var(--sep-strong) !important;
    }
    .cwl-day-start{
      border-left: 2px solid var(--sep-strong) !important;
    }
    .cwl-day-end{
      border-right: 2px solid var(--sep-strong) !important;
    }
  </style>

  <script data-goatcounter="https://based.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>

<body>
  <img src="icontransparent.png" alt="B•A•S•E•D icon" class="app-icon" />
  <img src="logo.png" alt="B•A•S•E•D logo" class="logo" onerror="this.style.display='none';" />

  <a class="clan-tag-link"
     href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y"
     target="_blank" rel="noopener noreferrer">#2QQYJC08Y</a>

  <nav class="topnav" id="topNav" aria-label="Top navigation">
    <a href="#/home" data-route="home">Home</a>
    <a href="#/cwl" data-route="cwl">CWL</a>
    <a href="#/war" data-route="war">War</a>
    <a href="#/my-stats" data-route="mystats">My Stats</a>
    <a href="#/more" data-route="more">More</a>
  </nav>

  <div class="stage" id="stage">
    <div id="app" role="main" aria-live="polite"></div>
  </div>

  <nav class="pwa-tabbar" id="pwaTabbar" aria-label="Bottom navigation">
    <div class="tabs">
      <a href="#/home" data-route="home" data-img-key="home"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">Home</span></div></a>
      <a href="#/cwl" data-route="cwl" data-img-key="cwl"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">CWL</span></div></a>
      <a href="#/war" data-route="war" data-img-key="war"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">War</span></div></a>
      <a href="#/my-stats" data-route="mystats" data-img-key="my-stats"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">My Stats</span></div></a>
      <a href="#/more" data-route="more" data-img-key="more"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">More</span></div></a>
    </div>
  </nav>

  <script>
    (async function purgePwaCachesOnce(){
      const KEY = "based_pwa_cache_purged_v2";
      try{
        if(localStorage.getItem(KEY) === "1") return;

        if("caches" in window){
          try{
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }catch(e){}
        }

        if("serviceWorker" in navigator){
          try{
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all((regs||[]).map(r => r.unregister().catch(()=>{})));
          }catch(e){}
        }

        localStorage.setItem(KEY, "1");
        location.reload();
      }catch(e){}
    })();

    // =========================
    // Core helpers
    // =========================
    function isPwaInstalled(){
      const standaloneDisplay = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const iosStandalone = (typeof navigator !== "undefined") && ("standalone" in navigator) && navigator.standalone;
      return !!(standaloneDisplay || iosStandalone);
    }

    function normalizeRoute(hash){
      const raw = (hash || "").replace(/^#\/?/, "").trim().toLowerCase();
      if(!raw || raw === "index.html") return "home";
      if(raw === "home") return "home";
      if(raw === "cwl") return "cwl";
      if(raw === "war") return "war";
      if(raw === "my-stats" || raw === "mystats") return "mystats";
      if(raw === "more") return "more";
      return "home";
    }

    function setActiveNav(route){
      document.querySelectorAll("[data-route]").forEach(a => {
        a.classList.toggle("active", (a.getAttribute("data-route") || "") === route);
      });
    }

    const ICON_VER = "v1";
    const ICON_FILES = [
      "home-active.png","home-inactive.png",
      "cwl-active.png","cwl-inactive.png",
      "war-active.png","war-inactive.png",
      "my-stats-active.png","my-stats-inactive.png",
      "more-active.png","more-inactive.png"
    ];
    (function preloadTabIcons(){
      ICON_FILES.forEach(src => { const i = new Image(); i.src = `${src}?v=${ICON_VER}`; });
    })();

    function applyPwaImageIconStates(route){
      if(!isPwaInstalled()) return;
      const tabbar = document.getElementById("pwaTabbar");
      if(!tabbar) return;

      tabbar.querySelectorAll("a[data-img-key]").forEach(a => {
        const key = a.getAttribute("data-img-key");
        const img = a.querySelector(".icon img");
        if(!key || !img) return;

        const isActive = (a.getAttribute("data-route") === route);
        const file = isActive ? `${key}-active.png` : `${key}-inactive.png`;

        img.src = `${file}?v=${ICON_VER}`;
        img.loading = "eager";
        img.decoding = "async";
      });
    }

    // =========================
    // PWA tabbar hide-on-scroll
    // =========================
    let _pwaScrollBound = false;
    let _lastScrollY = 0;
    let _rafPending = false;

    function getScrollTop(){
      const se = document.scrollingElement || document.documentElement;
      return (typeof window.scrollY === "number") ? window.scrollY : (se ? se.scrollTop : 0);
    }

    function showPwaTabbar(){
      const tabbar = document.getElementById("pwaTabbar");
      if(tabbar) tabbar.classList.remove("is-hidden");
    }

    function hidePwaTabbar(){
      const tabbar = document.getElementById("pwaTabbar");
      if(tabbar) tabbar.classList.add("is-hidden");
    }

    function bindPwaTabbarAutoHide(){
      if(_pwaScrollBound) return;
      if(!isPwaInstalled()) return;

      const tabbar = document.getElementById("pwaTabbar");
      if(!tabbar || getComputedStyle(tabbar).display === "none") return;

      _pwaScrollBound = true;
      _lastScrollY = getScrollTop();
      showPwaTabbar();

      const onScroll = () => {
        if(_rafPending) return;
        _rafPending = true;

        requestAnimationFrame(() => {
          _rafPending = false;

          const y = getScrollTop();
          const dy = y - _lastScrollY;

          if(Math.abs(dy) < 6){
            _lastScrollY = y;
            return;
          }

          if(y <= 8){
            showPwaTabbar();
            _lastScrollY = y;
            return;
          }

          if(dy > 0) hidePwaTabbar();
          else showPwaTabbar();

          _lastScrollY = y;
        });
      };

      window.__pwaTabbarScrollHandler = onScroll;
      window.addEventListener("scroll", onScroll, { passive:true });
    }

    function unbindPwaTabbarAutoHide(){
      const fn = window.__pwaTabbarScrollHandler;
      if(fn){
        window.removeEventListener("scroll", fn);
        window.__pwaTabbarScrollHandler = null;
      }
      _pwaScrollBound = false;
      _rafPending = false;
    }

    // =========================
    // Drag-to-scroll for any .dragscroll
    // =========================
    function enableDragScroll(el){
      if(!el || el.dataset.dragscroll === "1") return;
      el.dataset.dragscroll = "1";

      let isDown = false;
      let startX = 0;
      let startLeft = 0;
      let moved = false;

      const onDown = (e) => {
        if(e.button !== 0) return;
        isDown = true;
        moved = false;
        startX = e.pageX;
        startLeft = el.scrollLeft;
        el.classList.add("is-dragging");
        e.preventDefault();
      };

      const onMove = (e) => {
        if(!isDown) return;
        const dx = e.pageX - startX;
        if(Math.abs(dx) > 3) moved = true;
        el.scrollLeft = startLeft - dx;
      };

      const onUp = () => {
        if(!isDown) return;
        isDown = false;
        el.classList.remove("is-dragging");
      };

      const onClickCapture = (e) => {
        if(moved){
          e.preventDefault();
          e.stopPropagation();
          moved = false;
        }
      };

      el.addEventListener("mousedown", onDown);
      window.addEventListener("mousemove", onMove);
      window.addEventListener("mouseup", onUp);
      el.addEventListener("mouseleave", onUp);
      el.addEventListener("click", onClickCapture, true);
    }

    function enableDragScrollEverywhere(){
      document.querySelectorAll(".dragscroll").forEach(enableDragScroll);
    }

    function setupNavUI(){
      const pwa = isPwaInstalled();
      const topNav = document.getElementById("topNav");
      const tabbar = document.getElementById("pwaTabbar");

      if(pwa){
        if(topNav) topNav.style.display = "none";
        if(tabbar) tabbar.style.display = "block";
        document.body.classList.add("has-pwa-tabs");

        unbindPwaTabbarAutoHide();
        bindPwaTabbarAutoHide();
      } else {
        if(topNav) topNav.style.display = "flex";
        if(tabbar) tabbar.style.display = "none";
        document.body.classList.remove("has-pwa-tabs");
        unbindPwaTabbarAutoHide();
      }
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function setText(id, text){ const el = document.getElementById(id); if(el) el.textContent = text; }

    // =========================
    // Templates
    // =========================
    const app = document.getElementById("app");

    function pageShellCards(title, subtitle){
      return `<div class="cards"><main class="page"><h1>${title}</h1><p>${subtitle}</p></main></div>`;
    }

    function renderMore(){
      return `
        <div class="cards">
          <h2 class="cards-title">In-Game Events</h2>

          <div class="row"><span class="row-label">Raid Weekend</span><span id="raid-timer" class="row-value">—</span></div>
          <div class="row"><span class="row-label">Clan Games</span><span id="clan-games-timer" class="row-value">—</span></div>
          <div class="row"><span class="row-label">Season End</span><span id="season-end-timer" class="row-value">—</span></div>
          <div class="row"><span class="row-label">League Reset</span><span id="league-reset-timer" class="row-value">—</span></div>

          <div class="divider"></div>

          <div class="links">
            <a class="link-btn" href="changelog.html" target="_blank" rel="noopener noreferrer">Changelog</a>
            <a class="link-btn" href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQJyBeqDwShAcLD0GMnIvNehs8P9eG3ApO6pltrMHe01bZVJn0k3bIxLobnjBpvqEQNDe_sFcRkZPE8/pubhtml" target="_blank" rel="noopener noreferrer">CWL Leaderboards</a>
            <a class="link-btn" href="https://discord.gg/8P96687dPr" target="_blank" rel="noopener noreferrer">Clan Discord</a>
            <a class="link-btn" href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y" target="_blank" rel="noopener noreferrer">Visit B•A•S•E•D</a>
            <a class="link-btn" href="https://www.clashofstats.com/clans/based-2QQYJC08Y/summary" target="_blank" rel="noopener noreferrer">Clan Stats</a>
            <a class="link-btn" href="https://store.supercell.com/" target="_blank" rel="noopener noreferrer">SuperCell Store</a>
            <a class="link-btn install-btn" href="https://www.youtube.com/watch?v=gIC30U39zpA" target="_blank" rel="noopener noreferrer">How to install B•A•S•E•D App</a>
          </div>

          <div class="page-footer">EST DECEMBER 2023</div>
        </div>
      `;
    }

    // ✅ FIX #1 (Home/War disappeared):
    // DO NOT overwrite your real renderHome/renderWarPage functions.
    // We call the globally-defined ones (from your original full file).
    function callGlobalRenderer(fnName, fallbackHtml){
      try{
        const fn = window[fnName];
        if(typeof fn === "function") return fn();
      }catch(e){}
      return fallbackHtml;
    }

    function renderCwlPage(){
      return `
        <div class="cards">
          <h2 class="cards-title" id="cwl-title">CWL</h2>

          <div class="cwl-headerbar">
            <div class="left">Season</div>
            <div class="cwl-pill">
              <span id="cwl-season-label">CURRENT</span>
              <select id="cwlSeasonSelect" aria-label="Select CWL season">
                <option value="current">Current</option>
              </select>
            </div>
          </div>

          <div class="row"><span class="row-label">League</span><span id="cwl-league-name" class="row-value">Loading…</span></div>
          <div class="row"><span class="row-label">Status</span><span id="cwl-state" class="row-value">Loading…</span></div>

          <div class="divider"></div>

          <div class="section-title">League Overview</div>

          <div class="cwl-subheaderbar" aria-label="CWL league overview header">
            <div></div>
            <div class="cwl-scroll-inline">← SCROLL →</div>
            <div></div>
          </div>

          <div class="cwl-table-wrap dragscroll" aria-label="CWL league overview">
            <table class="cwl-table cwl-league">
              <colgroup>
                <col style="width:64px;">
                <col style="width:112px;">
                <col style="width:120px;">
                <col style="width:90px;">
                <col style="width:140px;">
              </colgroup>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th class="left">Clan</th>
                  <th>Stars+Bonus</th>
                  <th>Wins</th>
                  <th>Destruction</th>
                </tr>
              </thead>
              <tbody id="cwl-leagueoverview-body">
                <tr><td colspan="5" style="opacity:.75; text-align:center; padding:12px;">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="section-title">Member Overview</div>

          <div class="cwl-subheaderbar" aria-label="CWL member overview header">
            <div></div>
            <div class="cwl-scroll-inline">← SCROLL →</div>
            <div class="cwl-sortbtn-wrap">
              <div class="sort-btn">
                SORT
                <select id="cwlMembersSortSelect" aria-label="Sort CWL members">
                  <option value="rank">Rank</option>
                  <option value="totalStars">Total Stars</option>
                  <option value="totalPct">Total %</option>
                  <option value="avgStars">AVG Stars</option>
                  <option value="avgPct">Avg %</option>
                </select>
              </div>
            </div>
          </div>

          <div class="cwl-table-wrap dragscroll" aria-label="CWL member overview">
            <table class="cwl-table cwl-wide">
              <colgroup>
                <col style="width:64px;">
                <col style="width:88px;">
                <col style="width:86px;">
                <col style="width:110px;">
                <col style="width:96px;">
                <col style="width:92px;">
                <col style="width:92px;">
                <col style="width:220px;"><col style="width:70px;"><col style="width:80px;">
                <col style="width:220px;"><col style="width:70px;"><col style="width:80px;">
                <col style="width:220px;"><col style="width:70px;"><col style="width:80px;">
                <col style="width:220px;"><col style="width:70px;"><col style="width:80px;">
                <col style="width:220px;"><col style="width:70px;"><col style="width:80px;">
                <col style="width:220px;"><col style="width:70px;"><col style="width:80px;">
                <col style="width:220px;"><col style="width:70px;"><col style="width:80px;">
              </colgroup>

              <thead id="cwl-members-head">
                <tr>
                  <th class="sticky-1">Avg Rk</th>
                  <th class="sticky-2">Name</th>
                  <th>Total★</th>
                  <th>Total%</th>
                  <th>Atk</th>
                  <th>Avg★</th>
                  <th class="cwl-general-sep">Avg%</th>

                  <th class="cwl-dayhead" colspan="3">Day 1</th>
                  <th class="cwl-dayhead" colspan="3">Day 2</th>
                  <th class="cwl-dayhead" colspan="3">Day 3</th>
                  <th class="cwl-dayhead" colspan="3">Day 4</th>
                  <th class="cwl-dayhead" colspan="3">Day 5</th>
                  <th class="cwl-dayhead" colspan="3">Day 6</th>
                  <th class="cwl-dayhead" colspan="3">Day 7</th>
                </tr>

                <tr>
                  <th class="sticky-1 muted">&nbsp;</th>
                  <th class="sticky-2 muted">&nbsp;</th>
                  <th class="muted">&nbsp;</th>
                  <th class="muted">&nbsp;</th>
                  <th class="muted">&nbsp;</th>
                  <th class="muted">&nbsp;</th>
                  <th class="muted cwl-general-sep">&nbsp;</th>

                  <th class="left muted cwl-day-start">Opp</th><th class="muted">★</th><th class="muted cwl-day-end">%</th>
                  <th class="left muted cwl-day-start">Opp</th><th class="muted">★</th><th class="muted cwl-day-end">%</th>
                  <th class="left muted cwl-day-start">Opp</th><th class="muted">★</th><th class="muted cwl-day-end">%</th>
                  <th class="left muted cwl-day-start">Opp</th><th class="muted">★</th><th class="muted cwl-day-end">%</th>
                  <th class="left muted cwl-day-start">Opp</th><th class="muted">★</th><th class="muted cwl-day-end">%</th>
                  <th class="left muted cwl-day-start">Opp</th><th class="muted">★</th><th class="muted cwl-day-end">%</th>
                  <th class="left muted cwl-day-start">Opp</th><th class="muted">★</th><th class="muted cwl-day-end">%</th>
                </tr>
              </thead>

              <tbody id="cwl-memberoverview-body">
                <tr><td colspan="28" style="opacity:.75; text-align:center; padding:12px;">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <div id="cwl-fetch-status" class="tiny-status">CWL fetch: —</div>
          <div id="cwl-index-status" class="tiny-status">CWL index fetch: —</div>
          <div id="clan-fetch-status-cwl" class="tiny-status">Clan stats fetch: —</div>
        </div>
      `;
    }

    function renderRouteContent(route){
      if(route === "home"){
        return callGlobalRenderer(
          "renderHome",
          `<div class="cards"><h2 class="cards-title">Home</h2><div class="muted">renderHome() not found (it must exist in your original file).</div></div>`
        );
      }
      if(route === "cwl") return renderCwlPage();
      if(route === "war"){
        return callGlobalRenderer(
          "renderWarPage",
          `<div class="cards"><h2 class="cards-title">War</h2><div class="muted">renderWarPage() not found (it must exist in your original file).</div></div>`
        );
      }
      if(route === "mystats") return pageShellCards("My Stats", "Coming Soon!");
      if(route === "more") return renderMore();
      return callGlobalRenderer("renderHome", `<div class="cards"><h2 class="cards-title">Home</h2></div>`);
    }

    // =========================
    // Data endpoints
    // =========================
    const RAW_WAR_URL_BASE        = "./war.json";
    const RAW_WAR_DETAIL_URL_BASE = "./war_detail.json";
    const RAW_CLAN_URL_BASE       = "./clan_stats.json";
    const RAW_MEMBERS_URL_BASE    = "./members.json";

    const RAW_CWL_CURRENT_URL_BASE = "./cwl_current.json";
    const RAW_CWL_INDEX_URL_BASE   = "./cwl_index.json";

    const RAW_FALLBACK_BASE = "https://raw.githubusercontent.com/cocbased/based/main/";
    const RAW_WAR_FALLBACK         = RAW_FALLBACK_BASE + "war.json";
    const RAW_WAR_DETAIL_FALLBACK  = RAW_FALLBACK_BASE + "war_detail.json";
    const RAW_CLAN_FALLBACK        = RAW_FALLBACK_BASE + "clan_stats.json";
    const RAW_MEMBERS_FALLBACK     = RAW_FALLBACK_BASE + "members.json";
    const RAW_CWL_CURRENT_FALLBACK = RAW_FALLBACK_BASE + "cwl_current.json";
    const RAW_CWL_INDEX_FALLBACK   = RAW_FALLBACK_BASE + "cwl_index.json";

    // =========================
    // State + intervals
    // =========================
    let homeIntervals = [];
    let warIntervals  = [];
    let moreIntervals = [];
    let cwlIntervals  = [];
    function clearIntervals(arr){ arr.forEach(id => clearInterval(id)); arr.length = 0; }

    let warData = null;
    let warFetched = false;

    let warDetail = null;
    let warDetailFetched = false;

    const LAST_WAR_STORAGE_KEY = "based_last_war_snapshot";
    let lastWarSnapshot = null;

    let clanStats = null;
    let membersData = null;
    let membersSortMode = "role";

    const CWL_SELECTED_KEY = "based_cwl_selected_season";
    let cwlIndex = null;
    let cwlCurrent = null;
    let cwlSelected = (localStorage.getItem(CWL_SELECTED_KEY) || "current");
    let cwlSelectedPayload = null;

    let cwlMembersSortMode = "rank";

    // =========================
    // Utilities
    // =========================
    function pad(n){ return String(n).padStart(2,"0"); }

    function loadLastWarSnapshot(){
      try{
        const raw = localStorage.getItem(LAST_WAR_STORAGE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object" && obj.state && obj.state !== "notInWar") return obj;
      } catch(e){}
      return null;
    }
    function saveLastWarSnapshot(w){
      try{ localStorage.setItem(LAST_WAR_STORAGE_KEY, JSON.stringify(w)); } catch(e){}
    }
    lastWarSnapshot = loadLastWarSnapshot();

    function stampTime(){
      const d = new Date();
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
    }

    // =========================
    // Robust JSON fetch + meta diagnostics
    // =========================
    const endpointState = new Map(); // key => { lastHash, unchangedStreak }

    function fnv1a32(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
      }
      return h >>> 0;
    }

    async function fetchJsonWithMeta(url, stateKey){
      const key = stateKey || url;
      const cb = Date.now();
      const rnd = Math.random().toString(16).slice(2);
      const busted = `${url}${url.includes("?") ? "&" : "?"}cb=${cb}&r=${rnd}`;

      const started = performance.now();
      const res = await fetch(busted, {
        cache: "no-store",
        headers: {
          "Cache-Control": "no-cache, no-store, must-revalidate",
          "Pragma": "no-cache"
        }
      });

      const text = await res.text();
      if(!res.ok) throw new Error(`${url} HTTP ${res.status}`);

      const hash = fnv1a32(text).toString(16).padStart(8,"0");
      const bytes = text.length;

      const st = endpointState.get(key) || { lastHash:null, unchangedStreak:0 };
      const unchanged = (st.lastHash === hash);
      st.unchangedStreak = unchanged ? (st.unchangedStreak + 1) : 0;
      st.lastHash = hash;
      endpointState.set(key, st);

      let data;
      try{
        data = JSON.parse(text);
      }catch(e){
        throw new Error(`${url} JSON parse error`);
      }

      const ms = Math.round(performance.now() - started);
      const meta = {
        ok: true,
        url: busted,
        hash,
        bytes,
        ms,
        unchanged,
        unchangedStreak: st.unchangedStreak,
        lastModified: res.headers.get("Last-Modified") || "",
        etag: res.headers.get("ETag") || ""
      };
      return { data, meta };
    }

    async function fetchJsonSmart(pagesUrl, rawFallbackUrl, stateKey){
      const primary = await fetchJsonWithMeta(pagesUrl, stateKey || pagesUrl);

      if(rawFallbackUrl){
        const st = endpointState.get(stateKey || pagesUrl);
        const shouldTryFallback = primary.meta.unchanged && st && st.unchangedStreak >= 3;

        if(shouldTryFallback){
          try{
            const fb = await fetchJsonWithMeta(rawFallbackUrl, (stateKey || pagesUrl) + "::raw");
            if(fb.meta.hash !== primary.meta.hash){
              fb.meta.via = "raw";
              return fb;
            }
          }catch(e){}
        }
      }

      primary.meta.via = "pages";
      return primary;
    }

    function formatMetaLine(label, meta){
      if(!meta) return `${label}: ${stampTime()} ❌`;
      const changedTxt = meta.unchanged ? "UNCHANGED" : "CHANGED";
      const lm = meta.lastModified ? ` · LM ${meta.lastModified}` : "";
      const via = meta.via ? ` · ${meta.via.toUpperCase()}` : "";
      return `${label}: ${stampTime()} ✅ ${changedTxt} · ${meta.bytes}B · #${meta.hash}${via}${lm}`;
    }

    // =========================
    // Fetchers (CWL index/current/history)
    // =========================
    async function fetchCwlIndex(){
      try{
        const { data, meta } = await fetchJsonSmart(RAW_CWL_INDEX_URL_BASE, RAW_CWL_INDEX_FALLBACK, "cwl_index.json");
        cwlIndex = data;
        setText("cwl-index-status", formatMetaLine("CWL index fetch", meta));
      }catch(e){
        cwlIndex = null;
        setText("cwl-index-status", `CWL index fetch: ${stampTime()} ❌ ${String(e.message || e)}`);
      }
      renderCwlSeasonSelect();
    }

    async function fetchCwlCurrent(){
      try{
        const { data, meta } = await fetchJsonSmart(RAW_CWL_CURRENT_URL_BASE, RAW_CWL_CURRENT_FALLBACK, "cwl_current.json");
        cwlCurrent = data;
        setText("cwl-fetch-status", formatMetaLine("CWL fetch", meta));
      }catch(e){
        cwlCurrent = null;
        setText("cwl-fetch-status", `CWL fetch: ${stampTime()} ❌ ${String(e.message || e)}`);
      }

      if(cwlSelected === "current"){
        cwlSelectedPayload = cwlCurrent;
        renderCwlContent();
      } else {
        renderCwlSeasonSelect();
      }
    }

    async function fetchCwlHistory(seasonKey){
      if(!seasonKey || seasonKey === "current") return;

      const pagesUrl = `./cwl_history/${encodeURIComponent(seasonKey)}.json`;
      const rawUrl   = `${RAW_FALLBACK_BASE}cwl_history/${encodeURIComponent(seasonKey)}.json`;

      try{
        const { data, meta } = await fetchJsonSmart(pagesUrl, rawUrl, `cwl_history:${seasonKey}`);
        cwlSelectedPayload = data;
        setText("cwl-fetch-status", formatMetaLine("CWL fetch", meta));
      }catch(e){
        cwlSelectedPayload = null;
        setText("cwl-fetch-status", `CWL fetch: ${stampTime()} ❌ ${String(e.message || e)}`);
      }
      renderCwlContent();
    }

    // =========================
    // CWL render helpers
    // =========================
    function pick(obj, keys){
      for(const k of keys){
        const v = obj?.[k];
        if(v !== undefined && v !== null && v !== "") return v;
      }
      return null;
    }
    function pickNum(obj, keys){
      const v = pick(obj, keys);
      const n = (typeof v === "number") ? v : Number(v);
      return isFinite(n) ? n : null;
    }

    function ensureCwlSelectBound(){
      const sel = document.getElementById("cwlSeasonSelect");
      if(!sel) return;
      if(sel.dataset.bound === "1") return;

      sel.addEventListener("change", async () => {
        const v = sel.value || "current";
        cwlSelected = v;
        try{ localStorage.setItem(CWL_SELECTED_KEY, cwlSelected); }catch(e){}

        setText("cwl-season-label", (v === "current") ? "CURRENT" : v);

        if(v === "current"){
          cwlSelectedPayload = cwlCurrent;
          renderCwlContent();
        } else {
          await fetchCwlHistory(v);
        }
      });

      sel.dataset.bound = "1";
    }

    function ensureCwlMembersSortBound(){
      const sel = document.getElementById("cwlMembersSortSelect");
      if(!sel) return;

      sel.value = cwlMembersSortMode;

      if(sel.dataset.bound === "1") return;
      sel.addEventListener("change", () => {
        cwlMembersSortMode = sel.value || "rank";
        renderCwlContent();
      });
      sel.dataset.bound = "1";
    }

    function renderCwlSeasonSelect(){
      const sel = document.getElementById("cwlSeasonSelect");
      if(!sel) return;

      ensureCwlSelectBound();

      const seasons = Array.isArray(cwlIndex?.seasons) ? cwlIndex.seasons : [];
      const opts = [];
      opts.push({ value:"current", label:"Current" });

      for(const s of seasons){
        if(!s || typeof s !== "object") continue;
        const key = String(s.seasonKey || "").trim();
        const title = String(s.title || key || "").trim();
        if(!key) continue;
        opts.push({ value:key, label:title });
      }

      const seen = new Set();
      const finalOpts = [];
      for(const o of opts){
        if(seen.has(o.value)) continue;
        seen.add(o.value);
        finalOpts.push(o);
      }

      sel.innerHTML = finalOpts.map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join("");

      const wanted = cwlSelected || "current";
      const hasWanted = finalOpts.some(o => o.value === wanted);
      sel.value = hasWanted ? wanted : "current";

      setText("cwl-season-label", (sel.value === "current") ? "CURRENT" : sel.value);

      if(document.getElementById("cwl-title")){
        if(sel.value === "current"){
          cwlSelectedPayload = cwlCurrent;
          renderCwlContent();
        }
      }
    }

    function fmtNum(n, fallback="—"){
      if(n === null || n === undefined || n === "") return fallback;
      const x = Number(n);
      return isFinite(x) ? String(x) : fallback;
    }
    function fmt1(n, fallback="—"){
      if(n === null || n === undefined || n === "") return fallback;
      const x = Number(n);
      return isFinite(x) ? x.toFixed(1) : fallback;
    }

    function getStarsWithBonus(r){
      const sWB = pickNum(r, ["starsWithBonus","stars_plus_bonus","starsPlusBonus"]);
      if(sWB !== null) return sWB;

      const starsBase = pickNum(r, ["stars","starsNoBonus","stars_without_bonus","starsWithoutBonus"]);
      const wins = pickNum(r, ["wins"]) ?? 0;

      const bonus = pickNum(r, ["bonusStars","bonus","bonus_points","bonus_points_stars"]);
      if(starsBase !== null && bonus !== null) return starsBase + bonus;

      if(starsBase !== null) return starsBase + (wins * 10);
      return null;
    }

    // ✅ FIX #2 (Day alignment):
    // Prefer explicit day numbers IF they’re sane; otherwise ROTATE by where "Day 1" is; otherwise normalize by min day.
    function parseDayNumber(d){
      const candidates = [d?.day, d?.dayNumber, d?.round, d?.warDay, d?.matchDay, d?.dayIndex];
      for(const c of candidates){
        if(c === null || c === undefined || c === "") continue;
        const cleaned = String(c).trim();
        const n = Number(cleaned.replace(/[^\d-]/g,""));
        if(!isFinite(n)) continue;
        if(n >= 1 && n <= 7) return n;
        if(n >= 0 && n <= 6) return n + 1; // 0-based -> 1-based
      }
      return null;
    }

    function rotateArrayToIndex(arr, startIdx){
      const n = arr.length;
      if(n === 0) return arr;
      const k = ((startIdx % n) + n) % n;
      return arr.slice(k).concat(arr.slice(0, k));
    }

    function buildDayMap(days){
      const arr = Array.isArray(days) ? days.filter(Boolean).slice(0, 7) : [];
      const byDay = new Map();
      if(!arr.length) return byDay;

      const nums = arr.map(parseDayNumber);
      const valid = nums.filter(n => n && n >= 1 && n <= 7);

      // Case A: we have a clean unique mapping -> trust it
      if(valid.length === arr.length){
        const set = new Set(valid);
        if(set.size === valid.length){
          for(let i=0;i<arr.length;i++){
            const n = nums[i];
            if(n) byDay.set(n, arr[i]);
          }
          return byDay;
        }
      }

      // Case B: rotate so the entry whose day==1 becomes first (common “Day 1 shows under Day 4” bug)
      const idxDay1 = nums.findIndex(n => n === 1);
      if(idxDay1 !== -1){
        const rotated = rotateArrayToIndex(arr, idxDay1);
        for(let i=0;i<7;i++){
          const d = rotated[i] || null;
          if(d) byDay.set(i + 1, d);
        }
        return byDay;
      }

      // Case C: normalize by minimum numeric day (e.g., starts at 4) -> shift so min becomes Day 1
      const mins = valid.length ? Math.min(...valid) : null;
      if(mins !== null && isFinite(mins)){
        for(let i=0;i<arr.length;i++){
          const d = arr[i];
          const n = nums[i];
          if(!d || !n) continue;
          const shifted = (((n - mins) % 7) + 7) % 7; // 0..6
          byDay.set(shifted + 1, d);
        }
        // fill any missing by index order as fallback
        for(let i=0;i<7;i++){
          const dayNum = i + 1;
          if(!byDay.has(dayNum) && arr[i]) byDay.set(dayNum, arr[i]);
        }
        return byDay;
      }

      // Case D: absolute fallback: array order
      for(let i=0;i<7;i++){
        const d = arr[i] || null;
        if(d) byDay.set(i + 1, d);
      }
      return byDay;
    }

    function renderCwlContent(){
      if(!document.getElementById("cwl-title")) return;

      ensureCwlMembersSortBound();

      const payload = cwlSelectedPayload || (cwlSelected === "current" ? cwlCurrent : null);

      setText("cwl-title", payload?.title || "CWL");
      setText("cwl-league-name", payload?.leagueName || "—");

      const state = payload?.state || (cwlSelected === "current" ? "loading" : "—");
      const stateNice =
        state === "active" ? "ACTIVE" :
        state === "ended" ? "ENDED" :
        state === "notInCwl" ? "NOT IN CWL" :
        state === "error" ? "ERROR" :
        "LOADING";
      setText("cwl-state", stateNice);

      const leagueBody = document.getElementById("cwl-leagueoverview-body");
      if(leagueBody){
        const rows = Array.isArray(payload?.leagueOverview) ? payload.leagueOverview : [];
        if(!rows.length){
          leagueBody.innerHTML = `<tr><td colspan="5" style="opacity:.75; text-align:center; padding:12px;">No league data yet.</td></tr>`;
        } else {
          leagueBody.innerHTML = rows.map(r => {
            const rank = fmtNum(r.rank, "—");
            const name = escapeHtml(r.name || "—");
            const wins = pickNum(r, ["wins"]) ?? 0;

            const starsPlusBonus = getStarsWithBonus(r);

            const destr = pickNum(r, ["destructionTotal","destruction","destructionPct","destructionPercentage","destruction_total"]);
            const destrOut = (destr === null) ? "—" : fmt1(destr, "—");

            return `
              <tr>
                <td class="mono">${rank}</td>
                <td class="left" title="${name}">${name}</td>
                <td class="mono bold">${starsPlusBonus === null ? "—" : fmtNum(starsPlusBonus, "—")}</td>
                <td class="mono">${fmtNum(wins, "0")}</td>
                <td class="mono">${destrOut}</td>
              </tr>
            `;
          }).join("");
        }
      }

      const memberBody = document.getElementById("cwl-memberoverview-body");
      if(memberBody){
        const members = Array.isArray(payload?.memberOverview) ? payload.memberOverview : [];
        if(!members.length){
          const msg = (payload?.state === "notInCwl") ? "Not in CWL right now." : "No member data yet.";
          memberBody.innerHTML = `<tr><td colspan="28" style="opacity:.75; text-align:center; padding:12px;">${escapeHtml(msg)}</td></tr>`;
        } else {
          const sorted = members.slice().sort((a,b)=>{
            const ar = Number(a?.avgRankAttacked ?? a?.avgRank ?? a?.rank ?? 9999);
            const br = Number(b?.avgRankAttacked ?? b?.avgRank ?? b?.rank ?? 9999);

            const aTotalStars = Number(a?.totalStars ?? 0);
            const bTotalStars = Number(b?.totalStars ?? 0);

            const aTotalPct = Number(a?.totalDestruction ?? a?.totalPct ?? a?.totalPercent ?? 0);
            const bTotalPct = Number(b?.totalDestruction ?? b?.totalPct ?? b?.totalPercent ?? 0);

            const aAvgStars = Number(a?.avgStars ?? 0);
            const bAvgStars = Number(b?.avgStars ?? 0);

            const aAvgPct = Number(a?.avgDestruction ?? a?.avgPct ?? a?.avgPercent ?? 0);
            const bAvgPct = Number(b?.avgDestruction ?? b?.avgPct ?? b?.avgPercent ?? 0);

            if(cwlMembersSortMode === "rank"){
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return String(a?.name||"").localeCompare(String(b?.name||""));
            }
            if(cwlMembersSortMode === "totalStars"){
              if(bTotalStars !== aTotalStars) return bTotalStars - aTotalStars;
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return String(a?.name||"").localeCompare(String(b?.name||""));
            }
            if(cwlMembersSortMode === "totalPct"){
              if(bTotalPct !== aTotalPct) return bTotalPct - aTotalPct;
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return String(a?.name||"").localeCompare(String(b?.name||""));
            }
            if(cwlMembersSortMode === "avgStars"){
              if(bAvgStars !== aAvgStars) return bAvgStars - aAvgStars;
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return String(a?.name||"").localeCompare(String(b?.name||""));
            }
            if(cwlMembersSortMode === "avgPct"){
              if(bAvgPct !== aAvgPct) return bAvgPct - aAvgPct;
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return String(a?.name||"").localeCompare(String(b?.name||""));
            }

            if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
            return String(a?.name||"").localeCompare(String(b?.name||""));
          });

          memberBody.innerHTML = sorted.map(m => {
            const avgRkVal = pickNum(m, ["avgRankAttacked","avgRank","avg_rank_attacked","avg_rank"]);
            const avgRk = (avgRkVal === null) ? "—" : fmt1(avgRkVal, "—");

            const nm = escapeHtml(m.name || "—");

            const totStars = pickNum(m, ["totalStars","starsTotal","total_stars"]) ?? 0;
            const totDes = pickNum(m, ["totalDestruction","totalPct","totalPercent","total_destruction"]) ?? 0;

            const atkMade = pickNum(m, ["attacksMade","attacks","attacks_made"]) ?? 0;
            const atkFrac = `${fmtNum(atkMade,"0")}/7`;

            const avgStarsVal = pickNum(m, ["avgStars","avg_stars"]);
            const avgStars = (avgStarsVal === null) ? "—" : fmt1(avgStarsVal, "—");

            const avgDesVal = pickNum(m, ["avgDestruction","avgPct","avgPercent","avg_destruction"]);
            const avgDes = (avgDesVal === null) ? "—" : fmt1(avgDesVal, "—");

            const days = Array.isArray(m.days) ? m.days : [];
            const byDay = buildDayMap(days);

            const dayCells = [];
            for(let i=1;i<=7;i++){
              const d = byDay.get(i) || null;
              const opp = escapeHtml(d?.defender || d?.opponent || d?.target || "—");

              const sVal = (d?.stars === null || d?.stars === undefined) ? null : Number(d.stars);
              const pVal = (d?.destruction === null || d?.destruction === undefined) ? null : Number(d.destruction);

              const s = (sVal === null || !isFinite(sVal)) ? "—" : fmtNum(sVal, "—");
              const p = (pVal === null || !isFinite(pVal)) ? "—" : fmt1(pVal, "—");

              dayCells.push(`<td class="left mono cwl-day-start" title="${opp}">${opp}</td>`);
              dayCells.push(`<td class="mono">${s}</td>`);
              dayCells.push(`<td class="mono cwl-day-end">${p}</td>`);
            }

            return `
              <tr>
                <td class="sticky-1 mono">${avgRk}</td>
                <td class="sticky-2 left" title="${nm}">${nm}</td>
                <td class="mono bold">${fmtNum(totStars, "0")}</td>
                <td class="mono">${fmt1(totDes, "0.0")}</td>
                <td class="mono">${escapeHtml(atkFrac)}</td>
                <td class="mono">${avgStars}</td>
                <td class="mono cwl-general-sep">${avgDes}</td>
                ${dayCells.join("")}
              </tr>
            `;
          }).join("");
        }
      }

      enableDragScrollEverywhere();
    }

    // =========================
    // Loops per route
    // =========================
    function startCwlLoop(){
      clearIntervals(cwlIntervals);
      cwlMembersSortMode = "rank";

      fetchCwlIndex();
      fetchCwlCurrent();

      cwlIntervals.push(setInterval(fetchCwlCurrent, 5000));
      cwlIntervals.push(setInterval(fetchCwlIndex, 60000));

      if(cwlSelected && cwlSelected !== "current"){
        fetchCwlHistory(cwlSelected);
      } else {
        cwlSelectedPayload = cwlCurrent;
        renderCwlContent();
      }
    }

    // =========================
    // Router
    // =========================
    function setDocTitle(route){
      const map = {
        home:"B•A•S•E•D — Home",
        cwl:"B•A•S•E•D — CWL",
        war:"B•A•S•E•D — War",
        mystats:"B•A•S•E•D — My Stats",
        more:"B•A•S•E•D — More"
      };
      document.title = map[route] || "B•A•S•E•D";
    }

    function renderRoute(){
      const route = normalizeRoute(location.hash);

      setupNavUI();
      setActiveNav(route);
      applyPwaImageIconStates(route);
      setDocTitle(route);

      clearIntervals(homeIntervals);
      clearIntervals(warIntervals);
      clearIntervals(moreIntervals);
      clearIntervals(cwlIntervals);

      app.innerHTML = renderRouteContent(route);

      enableDragScrollEverywhere();

      if(route === "cwl") startCwlLoop();

      if(isPwaInstalled()) bindPwaTabbarAutoHide();
    }

    if(!location.hash) location.hash = "#/home";
    setupNavUI();

    renderRoute();

    window.addEventListener("hashchange", renderRoute);
    window.addEventListener("pageshow", renderRoute);
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible") renderRoute();
    });
  </script>
</body>
</html>
