<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî Home</title>

  <link rel="apple-touch-icon" href="icon-180.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="favicon.png">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --tabbar-h: 92px;
      --tabbar-bg: rgba(12,12,12,0.96);
      --tabbar-border: rgba(255,255,255,0.10);
      --m-emoji-col: 30px;
      --m-name-col: 102px;
      --cards-max: 680px;
    }

    html{ overflow-y: scroll; scrollbar-gutter: stable both-edges; }
    .topnav{ flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .topnav::-webkit-scrollbar{ display:none; }
    .topnav a{ flex: 0 0 auto; }
    .stage, #app{ min-height: 0; }

    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
      justify-content:flex-start;
      text-align:center;
      padding:24px 16px;
      box-sizing:border-box;
      overscroll-behavior-x: none;
    }

    .app-icon{ width:90px; height:90px; margin-bottom:12px; border-radius:20px; object-fit:contain; }
    .logo{ width:100%; max-width:225px; height:auto; margin-bottom:16px; object-fit:contain; }

    .clan-tag-link{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      font-size:14px;
      display:inline-block;
      margin:8px 0 10px;
    }
    .clan-tag-link:hover{ text-decoration:underline; opacity:1; }

    .topnav{
      width:100%;
      max-width:560px;
      display:flex;
      justify-content:center;
      gap:10px;
      padding:10px 8px 18px;
      box-sizing:border-box;
    }
    .topnav a{
      text-decoration:none;
      color:#fff;
      opacity:0.82;
      font-size:13px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      white-space:nowrap;
    }
    .topnav a.active{
      opacity:1;
      font-weight:700;
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.08);
    }

    .stage{ width:100%; max-width:560px; position:relative; flex:1; display:flex; justify-content:center; }
    #app{ width:100%; max-width:560px; display:flex; flex-direction:column; align-items:center; flex:1; touch-action:auto; }

    .cards{
      width:100%;
      max-width: min(var(--cards-max), 100%);
      margin-bottom:24px;
      padding:12px 16px;
      border-radius:12px;
      background:#0b1829;
      border:1px solid #2b3b55;
      box-sizing:border-box;
      text-align:left;
      display:flex;
      flex-direction:column;
    }
    .cards-title{ margin:0 0 6px; font-size:16px; text-align:center; }
    .section-title{
      margin:10px 0 6px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.75;
      text-align:center;
    }
    .divider{ height:1px; background:rgba(255,255,255,.12); margin:10px 0; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:14px; padding:2px 0; gap:12px; }
    .row-label{ font-weight:600; white-space:nowrap; }
    .row-value{ font-family:monospace; text-align:right; flex:1; }

    .clan-desc-block{ text-align:center; white-space: pre-line; line-height: 1.25; opacity: .95; padding: 2px 0 6px; }
    #rankings-block{ display:none; }

    .war-board{ text-align:center; margin-top:6px; }
    .war-timer{ font-family:monospace; font-weight:900; font-size:14px; margin:6px 0 10px; }
    .war-grid-3{ display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; }
    .war-vs{ font-weight:900; font-size:14px; opacity:.7; }
    .war-name{
      font-weight:800; font-size:13px; letter-spacing:.05em;
      text-transform:uppercase; margin-bottom:6px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .war-stat, .war-substat{
      font-family:monospace; font-weight:900; font-size:14px;
      display:flex; justify-content:center; align-items:center; gap:6px;
    }
    .war-stat{ margin-top:6px; }
    .war-substat{ margin-top:8px; opacity:.95; }
    .war-green{ color:#38d172; font-weight:900; }
    .record-green{ color:#38d172; font-weight:900; }

    /* ===== WAR CHART ===== */
    .war-chart-wrap{ margin-top: 12px; }
    .war-chart-title{
      margin: 10px 0 6px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.75;
      text-align:center;
    }

    .war-chart-block{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      border-radius: 10px;
      overflow: hidden;
      color:#fff; /* safety */
    }
    .war-chart-block + .war-chart-block{ margin-top: 10px; }

    .war-chart-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .war-chart-clan{
      display:flex;
      align-items:center;
      gap: 8px;
      font-weight: 900;
      letter-spacing: .03em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width: 0;
    }

    .war-dot{
      width:10px; height:10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.10);
      flex: 0 0 auto;
    }
    .war-dot.opp{
      background: rgba(255,215,0,0.9);
      box-shadow: 0 0 0 3px rgba(255,215,0,0.14);
    }

    .war-chart-sub{
      font-family: monospace;
      font-size: 12px;
      opacity: .75;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .war-sheet{ width:100%; display:block; } /* safety */

    .war-sheet-row{
      display:grid;
      grid-template-columns: 26px minmax(0, 1fr) minmax(0, 1fr) 40px 64px 36px;
      align-items: stretch;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      min-height: 38px; /* safety so rows can‚Äôt collapse */
    }
    .war-sheet-row:last-child{ border-bottom:none; }

    .war-sheet-row.head{
      background: rgba(0,0,0,0.18);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .war-cell{
      padding: 8px 8px;
      font-size: 12.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display:flex;
      align-items:center;
      gap:6px;
      border-right: none !important;
      color:#fff; /* safety */
    }

    .war-cell.mono{ font-family: monospace; }
    .war-cell.center{ justify-content:center; text-align:center; }
    .war-cell.right{ justify-content:flex-end; text-align:right; }
    .war-cell.bold{ font-weight: 900; }
    .war-cell.numcol{ padding-right: 6px; opacity: .95; }

    .war-player{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .war-player .name{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .war-player .role{ font-size:11px; opacity:.70; }

    .war-targetchips{ display:inline-flex; gap:4px; flex:0 0 auto; }
    .war-chip{
      font-family: monospace;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      opacity: .95;
    }

    .atk2{ display:flex; flex-direction:column; gap:4px; width:100%; min-width:0; }
    .atkline{
      display:flex;
      align-items:center;
      width:100%;
      font-family:monospace;
      font-size:11px;
      opacity:.95;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .war-cell.defender{ justify-content:flex-end; text-align:right; }
    .war-cell.defender .atk2{ align-items:flex-end; }
    .war-cell.defender .atkline{ justify-content:flex-end; text-align:right; }

    .stars{ display:flex; align-items:center; justify-content:center; gap:4px; font-variant-numeric: tabular-nums; }
    .star{
      font-size:13px; line-height:1;
      color: rgba(255,215,0,0.95);
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
    }
    .star.dim{ color: rgba(255,255,255,0.18); text-shadow:none; }
    .muted{ opacity:.65; }

    /* Members + more styles remain unchanged (kept) */
    .members-headerbar{
      background: transparent; border:none; border-radius:0;
      padding:0; margin:0 0 8px;
      display:grid;
      grid-template-columns: auto 1fr auto;
      grid-template-rows: auto auto;
      column-gap: 12px;
      row-gap: 6px;
      align-items:center;
    }
    .members-leaderline{ grid-column:1/2; grid-row:1/2; justify-self:start; }
    .members-elderline{ grid-column:1/2; grid-row:2/3; justify-self:start; }
    .members-keyline{ display:flex; align-items:center; gap:10px; white-space:nowrap; }
    .key-emoji{ font-size:14px; line-height:1; }
    .key-text{ font-size:12px; line-height:1.2; }
    .legend-underline{ text-decoration: underline; text-underline-offset: 2px; font-weight: 400; }
    .members-scroll-inline{
      grid-column:1/-1;
      grid-row:2/3;
      display:flex;
      justify-content:center;
      text-align:center;
      font-size:10px;
      letter-spacing:.03em;
      opacity:.78;
      white-space: nowrap;
      line-height: 1;
      pointer-events:none;
    }
    .members-sortbtn-wrap{ grid-column:3/4; grid-row:1/3; justify-self:end; align-self:center; }

    .sort-btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 58px;
      height: 36px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .sort-btn select{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .sort-btn select option{ background:#0b1829; color:#fff; }

    .members-wrap{
      width:100%;
      margin-top:2px;
      overflow-x:auto;
      overflow-y:visible;
      -webkit-overflow-scrolling: touch;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }
    .members-table{
      width:100%;
      min-width: 720px;
      border-collapse: separate;
      border-spacing: 0;
      font-size:13px;
      table-layout: fixed;
    }
    .members-table thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #0b1829;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding: 10px 10px;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space: nowrap;
    }
    .members-table th:nth-child(1),
    .members-table td:nth-child(1){
      position: sticky;
      left: 0;
      z-index: 7;
      background: #0b1829;
      border-right: none;
    }
    .members-table thead th:nth-child(1){ z-index: 9; }

    .members-table th:nth-child(2),
    .members-table td:nth-child(2){
      position: sticky;
      left: var(--m-emoji-col);
      z-index: 6;
      background: #0b1829;
      border-right: 1px solid rgba(255,255,255,0.10);
    }
    .members-table thead th:nth-child(2){ z-index: 8; }

    .members-table tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .members-table tbody tr:last-child td{ border-bottom:none; }
    .members-table td.m-emoji,
    .members-table th.m-emoji{
      overflow: visible !important;
      text-overflow: clip !important;
      white-space: nowrap !important;
    }
    .m-emoji{ text-align:right; font-size:14px; padding: 10px 6px 10px 10px; letter-spacing:0; }
    .m-user-name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .m-user-name.m-leader{ font-weight:400; text-decoration: underline; text-underline-offset: 2px; }
    .m-num{ font-family: monospace; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:clip; }

    .links{
      width:100%;
      max-width:280px;
      margin: 12px auto 0;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }
    .link-btn{
      width:100%;
      text-align:center;
      display:block;
      padding:12px;
      font-size:16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background-color:#fff;
      color:#000;
      text-decoration:none;
      box-sizing:border-box;
    }
    .install-btn{
      background-color:#ffcc00;
      color:#000;
      border:2px solid #000;
      padding:12px 20px;
      font-weight:700;
      border-radius:12px;
    }

    .page-footer{
      margin-top:auto;
      width:100%;
      padding:18px 0 0;
      font-size:14px;
      opacity:.7;
      text-align:center;
    }

    body.has-pwa-tabs{
      padding-bottom: calc(var(--tabbar-h) + var(--safe-bottom) + 10px);
    }
    .pwa-tabbar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--tabbar-h);
      padding-bottom: var(--safe-bottom);
      background: var(--tabbar-bg);
      border-top: 1px solid var(--tabbar-border);
      z-index: 9999;
      display: none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      will-change: transform;
      transform: translate3d(0,0,0);
      transition: transform 180ms cubic-bezier(.2,.8,.2,1);
    }
    .pwa-tabbar.is-hidden{
      transform: translate3d(0, calc(var(--tabbar-h) + var(--safe-bottom) + 6px), 0);
      pointer-events: none;
    }
    .pwa-tabbar .tabs{
      height: 100%;
      max-width: 560px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      align-items: center;
      padding: 10px 10px 12px;
      box-sizing: border-box;
      gap: 8px;
    }
    .pwa-tabbar a{
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      color:#fff;
      opacity: 0.78;
      border-radius: 16px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .tab-inner{
      width: 100%;
      height: 100%;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 10px 6px;
      box-sizing: border-box;
    }
    .pwa-tabbar a .icon{ width: 22px; height: 22px; display:block; transform: translateY(-3px); }
    .pwa-tabbar a .icon img{
      width: 22px;
      height: 22px;
      display:block;
      object-fit:contain;
      -webkit-user-drag:none;
      user-select:none;
      pointer-events:none;
    }
    .pwa-tabbar a .label{ font-size: 11px; line-height: 1; opacity: 0.95; transform: translateY(-2px); font-weight: 500; }
    .pwa-tabbar a.active{ opacity: 1; }
  </style>

  <script data-goatcounter="https://based.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>

<body>
  <img src="icontransparent.png" alt="B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D icon" class="app-icon" />
  <img src="logo.png" alt="B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D logo" class="logo" onerror="this.style.display='none';" />

  <a class="clan-tag-link"
     href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y"
     target="_blank" rel="noopener noreferrer">#2QQYJC08Y</a>

  <nav class="topnav" id="topNav" aria-label="Top navigation">
    <a href="#/home" data-route="home">Home</a>
    <a href="#/cwl" data-route="cwl">CWL</a>
    <a href="#/war" data-route="war">War</a>
    <a href="#/my-stats" data-route="mystats">My Stats</a>
    <a href="#/more" data-route="more">More</a>
  </nav>

  <div class="stage" id="stage">
    <div id="app" role="main" aria-live="polite"></div>
  </div>

  <nav class="pwa-tabbar" id="pwaTabbar" aria-label="Bottom navigation">
    <div class="tabs">
      <a href="#/home" data-route="home" data-img-key="home">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">Home</span>
        </div>
      </a>
      <a href="#/cwl" data-route="cwl" data-img-key="cwl">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">CWL</span>
        </div>
      </a>
      <a href="#/war" data-route="war" data-img-key="war">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">War</span>
        </div>
      </a>
      <a href="#/my-stats" data-route="mystats" data-img-key="my-stats">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">My Stats</span>
        </div>
      </a>
      <a href="#/more" data-route="more" data-img-key="more">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">More</span>
        </div>
      </a>
    </div>
  </nav>

  <script>
    function isPwaInstalled(){
      const standaloneDisplay = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const iosStandalone = (typeof navigator !== "undefined") && ("standalone" in navigator) && navigator.standalone;
      return !!(standaloneDisplay || iosStandalone);
    }

    function normalizeRoute(hash){
      const raw = (hash || "").replace(/^#\/?/, "").trim().toLowerCase();
      if(!raw || raw === "index.html") return "home";
      if(raw === "home") return "home";
      if(raw === "cwl") return "cwl";
      if(raw === "war") return "war";
      if(raw === "my-stats" || raw === "mystats") return "mystats";
      if(raw === "more") return "more";
      return "home";
    }

    function setActiveNav(route){
      document.querySelectorAll("[data-route]").forEach(a => {
        a.classList.toggle("active", (a.getAttribute("data-route") || "") === route);
      });
    }

    const ICON_VER = "v1";
    const ICON_FILES = [
      "home-active.png","home-inactive.png",
      "cwl-active.png","cwl-inactive.png",
      "war-active.png","war-inactive.png",
      "my-stats-active.png","my-stats-inactive.png",
      "more-active.png","more-inactive.png"
    ];
    (function preloadTabIcons(){
      ICON_FILES.forEach(src => { const i = new Image(); i.src = `${src}?v=${ICON_VER}`; });
    })();

    function applyPwaImageIconStates(route){
      if(!isPwaInstalled()) return;
      const tabbar = document.getElementById("pwaTabbar");
      if(!tabbar) return;

      tabbar.querySelectorAll("a[data-img-key]").forEach(a => {
        const key = a.getAttribute("data-img-key");
        const img = a.querySelector(".icon img");
        if(!key || !img) return;

        const isActive = (a.getAttribute("data-route") === route);
        const file = isActive ? `${key}-active.png` : `${key}-inactive.png`;

        img.src = `${file}?v=${ICON_VER}`;
        img.loading = "eager";
        img.decoding = "async";
      });
    }

    // ===== Templates =====
    const app = document.getElementById("app");
    function pageShellCards(title, subtitle){
      return `<div class="cards"><main class="page"><h1>${title}</h1><p>${subtitle}</p></main></div>`;
    }

    function renderMore(){ return `<div class="cards"><h2 class="cards-title">In-Game Events</h2><div class="row"><span class="row-label">Raid Weekend</span><span id="raid-timer" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">Clan Games</span><span id="clan-games-timer" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">Season End</span><span id="season-end-timer" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">League Reset</span><span id="league-reset-timer" class="row-value">Loading‚Ä¶</span></div><div class="divider"></div><div class="links"><a class="link-btn" href="changelog.html" target="_blank" rel="noopener noreferrer">Changelog</a><a class="link-btn" href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQJyBeqDwShAcLD0GMnIvNehs8P9eG3ApO6pltrMHe01bZVJn0k3bIxLobnjBpvqEQNDe_sFcRkZPE8/pubhtml" target="_blank" rel="noopener noreferrer">CWL Leaderboards</a><a class="link-btn" href="https://discord.gg/8P96687dPr" target="_blank" rel="noopener noreferrer">Clan Discord</a><a class="link-btn" href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y" target="_blank" rel="noopener noreferrer">Visit B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D</a><a class="link-btn" href="https://www.clashofstats.com/clans/based-2QQYJC08Y/summary" target="_blank" rel="noopener noreferrer">Clan Stats</a><a class="link-btn" href="https://store.supercell.com/" target="_blank" rel="noopener noreferrer">SuperCell Store</a><a class="link-btn install-btn" href="https://www.youtube.com/watch?v=gIC30U39zpA" target="_blank" rel="noopener noreferrer">How to install B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D App</a></div><div class="page-footer">EST DECEMBER 2023</div></div>`; }

    function renderHome(){ return `<div class="cards"><h2 class="cards-title">Clan Overview</h2><div id="rankings-block"><div class="section-title">Rankings</div><div class="row"><span class="row-label">Global Trophies</span><span id="rank-global-trophies" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">USA Trophies</span><span id="rank-usa-trophies" class="row-value">Loading‚Ä¶</span></div><div class="divider"></div></div><div id="clan-desc" class="clan-desc-block">Loading‚Ä¶</div><div class="divider"></div><div class="row"><span class="row-label">CWL League</span><span id="cwl-league" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">Last CWL Finish</span><span id="cwl-finish" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">War Record</span><span id="home-war-record" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">Last 10 Wars</span><span id="home-war-last10" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">Current Streak</span><span id="home-war-streak" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">Longest Streak</span><span id="home-war-longest" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">Capital Hall Level</span><span id="capital-hall-level" class="row-value">Loading‚Ä¶</span></div><div class="divider"></div><h2 class="cards-title" style="margin: 2px 0 10px;">Members</h2><div class="members-headerbar" aria-label="Members header controls"><div class="members-leaderline"><div class="members-keyline"><span class="key-emoji">&nbsp;&nbsp;üëë</span><span class="key-text"><span class="legend-underline">Leader</span> / Co</span></div></div><div></div><div></div><div class="members-elderline"><div class="members-keyline"><span class="key-emoji">&nbsp;&nbsp;üõ°Ô∏è</span><span class="key-text">Elder</span></div></div><div class="members-scroll-inline">‚Üê SCROLL ‚Üí</div><div class="members-sortbtn-wrap"><div class="sort-btn">SORT<select id="membersSortSelect" aria-label="Sort members"><option value="role">Role</option><option value="th">TH</option><option value="trophies">Trophies</option><option value="warStars">War Stars</option><option value="xp">XP</option><option value="donated">Donated</option><option value="received">Received</option></select></div></div></div><div class="members-wrap" aria-label="Clan members list"><table class="members-table"><colgroup><col style="width: var(--m-emoji-col);"><col style="width: var(--m-name-col);"><col style="width: 44px;"><col style="width: 84px;"><col style="width: 98px;"><col style="width: 58px;"><col style="width: 86px;"><col style="width: 96px;"></colgroup><thead><tr><th class="m-emoji" style="text-align:right;"></th><th style="text-align:left;"></th><th class="m-num">TH</th><th class="m-num">Trophies</th><th class="m-num">War Stars</th><th class="m-num">XP</th><th class="m-num">Donated</th><th class="m-num">Received</th></tr></thead><tbody id="members-body"><tr><td colspan="8" style="opacity:.75;">Loading‚Ä¶</td></tr></tbody></table></div></div>`; }

    function renderCwlPage(){ return `<div class="cards"><h2 class="cards-title">CWL</h2><div class="row"><span class="row-label">CWL League</span><span id="cwl-league-cwlpage" class="row-value">Loading‚Ä¶</span></div><div class="row"><span class="row-label">Last CWL Finish</span><span id="cwl-finish-cwlpage" class="row-value">Loading‚Ä¶</span></div><div class="divider"></div><div style="opacity:.75; font-size:13px; text-align:center; padding:6px 0 2px;">More CWL details coming soon.</div></div>`; }

    function renderWarPage(){
      return `
        <div class="cards">
          <div class="section-title">War</div>

          <div class="row"><span class="row-label">War Record</span><span id="war-record" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Last 10 Wars</span><span id="war-last10" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Last 25 Wars</span><span id="war-last25" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Last 50 Wars</span><span id="war-last50" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Current Streak</span><span id="war-streak" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Longest Streak</span><span id="war-longest" class="row-value">Loading‚Ä¶</span></div>

          <div class="divider"></div>

          <div class="section-title">Current War</div>
          <div class="war-board">
            <div id="war-timer" class="war-timer">Loading‚Ä¶</div>

            <div class="war-grid-3">
              <div>
                <div id="war-name-us" class="war-name">‚Äî</div>
                <div class="war-stat"><span id="war-stars-us">‚Äî</span> <span>‚≠ê</span></div>
                <div class="war-substat"><span id="war-destr-us">‚Äî</span> <span>üéØ</span></div>
                <div class="war-substat"><span id="war-attacks-us">‚Äî</span> <span>‚öîÔ∏è</span></div>
              </div>

              <div id="war-vs" class="war-vs">VS</div>

              <div>
                <div id="war-name-opp" class="war-name">‚Äî</div>
                <div class="war-stat"><span id="war-stars-opp">‚Äî</span> <span>‚≠ê</span></div>
                <div class="war-substat"><span id="war-destr-opp">‚Äî</span> <span>üéØ</span></div>
                <div class="war-substat"><span id="war-attacks-opp">‚Äî</span> <span>‚öîÔ∏è</span></div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div id="war-chart-mount" class="war-chart-wrap"></div>
        </div>
      `;
    }

    function renderRouteContent(route){
      if(route === "home") return renderHome();
      if(route === "cwl") return renderCwlPage();
      if(route === "war") return renderWarPage();
      if(route === "mystats") return pageShellCards("My Stats", "Coming Soon!");
      if(route === "more") return renderMore();
      return renderHome();
    }

    // ===== Data endpoints =====
    const RAW_WAR_URL_BASE        = "./war.json";
    const RAW_WAR_DETAIL_URL_BASE = "./war_detail.json";
    const RAW_CLAN_URL_BASE       = "./clan_stats.json";
    const RAW_MEMBERS_URL_BASE    = "./members.json";

    // ===== Interval buckets by route =====
    let homeIntervals = [];
    let warIntervals  = [];
    let moreIntervals = [];
    function clearIntervals(arr){ arr.forEach(id => clearInterval(id)); arr.length = 0; }

    let warData = null;
    let warFetched = false;

    let warDetail = null;
    let warDetailFetched = false;
    let warDetailMeta = { ok:false, status:0, err:"", ts:0, url:"" };

    const LAST_WAR_STORAGE_KEY = "based_last_war_snapshot";
    let lastWarSnapshot = null;

    let clanStats = null;
    let membersData = null;
    let membersSortMode = "role";

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function setText(id, text){ const el = document.getElementById(id); if(el) el.textContent = text; }
    function setClass(id, className, on){ const el = document.getElementById(id); if(el) el.classList.toggle(className, !!on); }

    function loadLastWarSnapshot(){
      try{
        const raw = localStorage.getItem(LAST_WAR_STORAGE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object" && obj.state && obj.state !== "notInWar") return obj;
      } catch(e){}
      return null;
    }
    function saveLastWarSnapshot(w){
      try{ localStorage.setItem(LAST_WAR_STORAGE_KEY, JSON.stringify(w)); } catch(e){}
    }
    lastWarSnapshot = loadLastWarSnapshot();

    async function fetchWarData(){
      try{
        const url = RAW_WAR_URL_BASE + "?cb=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        warData = res.ok ? await res.json() : null;

        if(warData && warData.state && warData.state !== "notInWar"){
          lastWarSnapshot = warData;
          saveLastWarSnapshot(warData);
        }
      } catch(e){
        warData = null;
      }
      warFetched = true;
      renderWarSection();
    }

    async function fetchWarDetail(){
      const url = RAW_WAR_DETAIL_URL_BASE + "?cb=" + Date.now();
      warDetailMeta = { ok:false, status:0, err:"", ts:Date.now(), url };

      try{
        const res = await fetch(url, { cache:"no-store" });
        warDetailMeta.status = res.status;

        const text = await res.text();
        if(!res.ok){
          warDetail = null;
          warDetailMeta.err = `HTTP ${res.status} ${res.statusText} (first 80: ${text.slice(0,80).replace(/\s+/g," ")})`;
        } else {
          try{
            warDetail = JSON.parse(text);
            warDetailMeta.ok = true;
          } catch(parseErr){
            warDetail = null;
            warDetailMeta.err = `JSON parse failed (first 80: ${text.slice(0,80).replace(/\s+/g," ")})`;
          }
        }
      } catch(e){
        warDetail = null;
        warDetailMeta.err = (e && e.message) ? e.message : String(e);
      }

      warDetailFetched = true;
      renderWarChart();
    }

    function renderWarSection(){
      if(!document.getElementById("war-timer")) return;
      if(!warFetched){ setText("war-timer","Loading‚Ä¶"); return; }

      let display = warData;
      if(display && display.state === "notInWar" && lastWarSnapshot) display = lastWarSnapshot;
      if(!display || !display.state){ setText("war-timer","Waiting‚Ä¶"); return; }

      if(display.state === "notInWar"){
        setText("war-timer","No war started");
        return;
      }

      setText("war-name-us",(display.ourName || "US"));
      setText("war-name-opp",(display.oppName || "OPPONENT"));
      setText("war-stars-us", String(display.ourStars ?? "‚Äî"));
      setText("war-stars-opp", String(display.oppStars ?? "‚Äî"));
      setText("war-destr-us", String(display.ourDestructionPercentage ?? display.ourDestruction ?? "‚Äî"));
      setText("war-destr-opp", String(display.oppDestructionPercentage ?? display.oppDestruction ?? "‚Äî"));
      setText("war-attacks-us", String(display.ourAttacksUsed ?? "‚Äî"));
      setText("war-attacks-opp", String(display.oppAttacksUsed ?? "‚Äî"));
    }

    function pickSides(detail){
      const our = detail?.our || {};
      const opp = detail?.opponent || {};
      const ourMembers = Array.isArray(our?.members) ? our.members : [];
      const oppMembers = Array.isArray(opp?.members) ? opp.members : [];
      return {
        our: { name: our.name || "Our Clan", tag: our.tag || "", members: ourMembers },
        opp: { name: opp.name || "Opponent", tag: opp.tag || "", members: oppMembers },
        debug: `our:our (${ourMembers.length}) | opp:opponent (${oppMembers.length})`
      };
    }

    function starsHTML(n){
      const s = Number(n || 0);
      return `
        <span class="star ${s>=1 ? "" : "dim"}">‚òÖ</span>
        <span class="star ${s>=2 ? "" : "dim"}">‚òÖ</span>
        <span class="star ${s>=3 ? "" : "dim"}">‚òÖ</span>
      `;
    }

    function renderWarChart(){
      const mount = document.getElementById("war-chart-mount");
      if(!mount) return;

      const stamp = new Date(warDetailMeta.ts || Date.now()).toLocaleTimeString();
      const keys = warDetail && typeof warDetail === "object" ? Object.keys(warDetail) : [];

      const debugTop = `
        <div style="font-family:monospace;font-size:11px;opacity:.75;text-align:center;margin:4px 0 8px;">
          war_detail.json: ${warDetailMeta.ok ? "OK" : "FAIL"} | ${warDetailMeta.status || "‚Äî"} | ${stamp}<br/>
          keys: ${escapeHtml(keys.join(", "))}<br/>
        </div>
      `;

      if(!warDetailFetched){
        mount.innerHTML = debugTop + `<div class="muted" style="text-align:center;">Loading war chart‚Ä¶</div>`;
        return;
      }

      if(!warDetail){
        mount.innerHTML = debugTop + `<div class="muted" style="text-align:center;">War chart unavailable</div>`;
        return;
      }

      const { our, opp, debug } = pickSides(warDetail);
      const ourMembers = Array.isArray(our.members) ? our.members.slice() : [];
      const oppMembers = Array.isArray(opp.members) ? opp.members.slice() : [];

      // EXTRA debug: first member keys
      const first = ourMembers[0] || {};
      const firstKeys = first && typeof first === "object" ? Object.keys(first).slice(0,18).join(", ") : "‚Äî";

      const debugMid = `
        <div style="font-family:monospace;font-size:11px;opacity:.85;text-align:center;margin:-4px 0 10px;">
          shape: ${escapeHtml(debug)}<br/>
          ROWS BUILT (our): ${ourMembers.length} | first member keys: ${escapeHtml(firstKeys)}
        </div>
      `;

      // A forced test row to prove visibility/layout
      const testRow = `
        <div class="war-chart-block">
          <div class="war-chart-head">
            <div class="war-chart-clan"><span class="war-dot"></span><span>VISIBILITY TEST</span></div>
            <div class="war-chart-sub">should show 1 row</div>
          </div>
          <div class="war-sheet">
            <div class="war-sheet-row head">
              <div class="war-cell right mono numcol">#</div>
              <div class="war-cell">Player</div>
              <div class="war-cell defender">Defender</div>
              <div class="war-cell center mono">%</div>
              <div class="war-cell center">Stars</div>
              <div class="war-cell center mono">Total</div>
            </div>
            <div class="war-sheet-row">
              <div class="war-cell right mono numcol">1.</div>
              <div class="war-cell">TEST PLAYER</div>
              <div class="war-cell defender">TEST DEF</div>
              <div class="war-cell center mono">99%</div>
              <div class="war-cell center"><span class="stars">${starsHTML(3)}</span></div>
              <div class="war-cell center mono bold">3‚òÖ</div>
            </div>
          </div>
        </div>
      `;

      function rowHTML(member){
        const name = member?.name || "‚Äî";
        const mp = member?.mapPosition ?? "‚Äî";
        const atks = Array.isArray(member?.attacks) ? member.attacks : [];
        const a1 = atks[0] || null;
        const a2 = atks[1] || null;

        return `
          <div class="war-sheet-row">
            <div class="war-cell right mono numcol">${escapeHtml(mp)}.</div>
            <div class="war-cell">${escapeHtml(name)}</div>
            <div class="war-cell defender">${a1 ? "‚Ä¶" : "‚Äî"}<br/>${a2 ? "‚Ä¶" : "‚Äî"}</div>
            <div class="war-cell center mono">${a1 ? (a1.destructionPercentage + "%") : "‚Äî"}<br/>${a2 ? (a2.destructionPercentage + "%") : "‚Äî"}</div>
            <div class="war-cell center"><div class="atk2"><div class="stars">${a1 ? starsHTML(a1.stars) : `<span class="muted">‚Äî</span>`}</div><div class="stars">${a2 ? starsHTML(a2.stars) : `<span class="muted">‚Äî</span>`}</div></div></div>
            <div class="war-cell center mono bold">${atks.reduce((s,a)=>s+(Number(a?.stars)||0),0)}‚òÖ</div>
          </div>
        `;
      }

      function blockHTML(title, tag, isOpp, members){
        return `
          <div class="war-chart-block">
            <div class="war-chart-head">
              <div class="war-chart-clan" title="${escapeHtml(title || "")}">
                <span class="war-dot ${isOpp ? "opp" : ""}"></span>
                <span>${escapeHtml(title || (isOpp ? "Opponent" : "Our Clan"))}</span>
              </div>
              <div class="war-chart-sub">${escapeHtml(tag || "")}</div>
            </div>

            <div class="war-sheet">
              <div class="war-sheet-row head">
                <div class="war-cell right mono numcol">#</div>
                <div class="war-cell">Player</div>
                <div class="war-cell defender">Defender</div>
                <div class="war-cell center mono">%</div>
                <div class="war-cell center">Stars</div>
                <div class="war-cell center mono">Total</div>
              </div>

              ${(members || []).map(m => rowHTML(m)).join("")}
            </div>
          </div>
        `;
      }

      mount.innerHTML =
        debugTop +
        debugMid +
        `<div class="war-chart-title">War Chart</div>` +
        testRow +
        blockHTML(our.name, our.tag, false, ourMembers) +
        blockHTML(opp.name, opp.tag, true,  oppMembers);
    }

    // ===== Members fetching (kept minimal) =====
    async function fetchMembersData(){
      try{
        const url = RAW_MEMBERS_URL_BASE + "?cb=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        membersData = res.ok ? await res.json() : null;
      } catch(e){
        membersData = null;
      }
    }

    // ===== Clan stats fetching (kept minimal) =====
    async function fetchClanStats(){
      try{
        const url = RAW_CLAN_URL_BASE + "?cb=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        clanStats = res.ok ? await res.json() : null;
      } catch(e){
        clanStats = null;
      }
    }

    // ===== Router =====
    function setDocTitle(route){
      const map = { home:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî Home", cwl:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî CWL", war:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî War", mystats:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî My Stats", more:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî More" };
      document.title = map[route] || "B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D";
    }

    function setupNavUI(){
      const pwa = isPwaInstalled();
      const topNav = document.getElementById("topNav");
      const tabbar = document.getElementById("pwaTabbar");

      if(pwa){
        if(topNav) topNav.style.display = "none";
        if(tabbar) tabbar.style.display = "block";
        document.body.classList.add("has-pwa-tabs");
      } else {
        if(topNav) topNav.style.display = "flex";
        if(tabbar) tabbar.style.display = "none";
        document.body.classList.remove("has-pwa-tabs");
      }
    }

    function renderRoute(){
      const route = normalizeRoute(location.hash);

      setupNavUI();
      setActiveNav(route);
      applyPwaImageIconStates(route);
      setDocTitle(route);

      clearIntervals(homeIntervals);
      clearIntervals(warIntervals);
      clearIntervals(moreIntervals);

      app.innerHTML = renderRouteContent(route);

      if(route === "war"){
        fetchClanStats();
        fetchMembersData();
        fetchWarData();
        fetchWarDetail();

        warIntervals.push(setInterval(fetchWarData, 5000));
        warIntervals.push(setInterval(fetchWarDetail, 5000));
      } else if(route === "home"){
        fetchClanStats();
        fetchMembersData();
      }
    }

    if(!location.hash) location.hash = "#/home";
    setupNavUI();
    renderRoute();

    window.addEventListener("hashchange", renderRoute);
    window.addEventListener("pageshow", renderRoute);
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible") renderRoute();
    });
  </script>
</body>
</html>
