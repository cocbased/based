<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî Home</title>

  <link rel="apple-touch-icon" href="icon-180.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Disable pinch-zoom (best-effort; iOS may still allow in some cases) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      /* Reddit-ish PWA tab bar */
      --tabbar-h: 92px;
      --tabbar-bg: rgba(12,12,12,0.96);
      --tabbar-border: rgba(255,255,255,0.10);

      /* Members column sizing (keep key aligned with table) */
      --m-emoji-col: 30px;
      --m-name-col: 102px;

      /* Card width cap = 200% of old 340px */
      --cards-max: 680px;
    }

    /* ============================================================
       Desktop/Web stability fixes (NO impact to PWA behavior)
       ============================================================ */
    html{
      overflow-y: scroll;
      scrollbar-gutter: stable both-edges;
    }
    .topnav{
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .topnav::-webkit-scrollbar{ display:none; }
    .topnav a{ flex: 0 0 auto; }
    .stage, #app{ min-height: 0; }

    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
      justify-content:flex-start;
      text-align:center;
      padding:24px 16px;
      box-sizing:border-box;
      overscroll-behavior-x: none;
    }

    /* Header */
    .app-icon{
      width:90px;
      height:90px;
      margin-bottom:12px;
      border-radius:20px;
      object-fit:contain;
    }
    .logo{
      width:100%;
      max-width:225px;
      height:auto;
      margin-bottom:16px;
      object-fit:contain;
    }

    /* Clan tag */
    .clan-tag-link{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      font-size:14px;
      display:inline-block;
      margin:8px 0 10px;
    }
    .clan-tag-link:hover{ text-decoration:underline; opacity:1; }

    /* Top nav (non-PWA only) */
    .topnav{
      width:100%;
      max-width:560px;
      display:flex;
      justify-content:center;
      gap:10px;
      padding:10px 8px 18px;
      box-sizing:border-box;
    }
    .topnav a{
      text-decoration:none;
      color:#fff;
      opacity:0.82;
      font-size:13px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      white-space:nowrap;
    }
    .topnav a.active{
      opacity:1;
      font-weight:700;
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.08);
    }

    /* Stage + app mount */
    .stage{
      width:100%;
      max-width:560px;
      position:relative;
      flex:1;
      display:flex;
      justify-content:center;
    }

    #app{
      width:100%;
      max-width:560px;
      display:flex;
      flex-direction:column;
      align-items:center;
      flex:1;
      touch-action: auto;
    }

    /* Card + rows */
    .cards{
      width:100%;
      max-width: min(var(--cards-max), 100%);
      margin-bottom:24px;
      padding:12px 16px;
      border-radius:12px;
      background:#0b1829;
      border:1px solid #2b3b55;
      box-sizing:border-box;
      text-align:left;
      display:flex;
      flex-direction:column;
    }
    .cards-title{ margin:0 0 6px; font-size:16px; text-align:center; }
    .section-title{
      margin:10px 0 6px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.75;
      text-align:center;
    }
    .divider{ height:1px; background:rgba(255,255,255,.12); margin:10px 0; }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:14px;
      padding:2px 0;
      gap:12px;
    }
    .row-label{ font-weight:600; white-space:nowrap; }
    .row-value{ font-family:monospace; text-align:right; flex:1; }

    #rankings-block{ display:none; }

    /* Current War */
    .war-board{ text-align:center; margin-top:6px; }
    .war-timer{
      font-family:monospace;
      font-weight:900;
      font-size:14px;
      margin:6px 0 10px;
    }
    .war-grid-3{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:10px;
      align-items:center;
    }
    .war-vs{ font-weight:900; font-size:14px; opacity:.7; }
    .war-name{
      font-weight:800;
      font-size:13px;
      letter-spacing:.05em;
      text-transform:uppercase;
      margin-bottom:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .war-stat, .war-substat{
      font-family:monospace;
      font-weight:900;
      font-size:14px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:6px;
    }
    .war-stat{ margin-top:6px; }
    .war-substat{ margin-top:8px; opacity:.95; }
    .war-green{ color:#38d172; font-weight:900; }
    .record-green{ color:#38d172; font-weight:900; }

    /* =========================
       MEMBERS (sticky header + sticky left columns)
       ========================= */

    /* Key + Sort (NO BOX) */
    .members-controls{
      font-size:12px;
      opacity:.9;
      margin:2px 0 8px;
      line-height:1.35;

      display:flex;
      justify-content:space-between;
      align-items:center;     /* ‚úÖ vertically centered vs filter */
      gap:12px;

      text-align:left;
    }

    /* Key line aligned to table's emoji + username columns */
    .members-keyline{
      display:grid;
      grid-template-columns: var(--m-emoji-col) auto;
      align-items:center;
      column-gap: 10px;
      white-space: nowrap;
    }
    .legend-underline{
      text-decoration: underline;     /* underline only */
      text-underline-offset: 2px;
      font-weight: 400;              /* NOT bold */
    }
    .key-emoji{
      width: var(--m-emoji-col);
      text-align:right;
      font-size:14px;
      line-height: 1;
    }
    .key-text{
      font-size:12px;
      line-height: 1.2;
    }

    /* filter box 70% size + centered options */
    .members-sort{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      width:70%;
      max-width:160px;
      min-width:120px;
    }
    .members-sort label{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.70;
      text-align:center;
      width:100%;
    }
    .members-sort select{
      width:100%;
      background: rgba(255,255,255,0.06);
      color:#fff;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      outline:none;
      appearance:none;
      -webkit-appearance:none;
      text-align:center;
      text-align-last:center;
    }
    .members-sort select option{
      background:#0b1829;
      color:#fff;
    }

    .members-wrap{
      width:100%;
      margin-top:8px;

      overflow-x:auto;
      overflow-y:visible;
      -webkit-overflow-scrolling: touch;

      border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }

    .members-table{
      width:100%;
      min-width: 720px;
      border-collapse: separate;
      border-spacing: 0;
      font-size:13px;
      table-layout: fixed;
    }

    .members-table thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #0b1829;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding: 10px 10px;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space: nowrap;
    }

    /* ‚úÖ Meta row in header (Elder + Scroll hint) */
    .members-table thead tr.members-meta-row th{
      padding: 8px 10px;
      font-size:10px;
      letter-spacing:.03em;
      text-transform:none;
      opacity:.80;
    }
    .members-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:100%;
    }
    /* Elder line aligned to emoji+username columns (flush left like names) */
    .elder-label{
      display:grid;
      grid-template-columns: var(--m-emoji-col) auto;
      align-items:center;
      column-gap:10px;
      white-space:nowrap;
    }
    .elder-label .e-emoji{
      width: var(--m-emoji-col);
      text-align:right;
      font-size:14px;
      line-height: 1;
    }
    .elder-label .e-text{
      font-size:12px;
      line-height:1.1;
      text-transform:none;
      letter-spacing:0;
      opacity:.95;
    }
    .scroll-hint-inline{
      font-size:10px;
      letter-spacing:.03em;
      opacity:.75;
      white-space:nowrap;
    }

    /* Sticky left columns */
    .members-table th:nth-child(1),
    .members-table td:nth-child(1){
      position: sticky;
      left: 0;
      z-index: 7;
      background: #0b1829;
      border-right: none;
    }
    .members-table thead th:nth-child(1){ z-index: 9; }

    .members-table th:nth-child(2),
    .members-table td:nth-child(2){
      position: sticky;
      left: var(--m-emoji-col);
      z-index: 6;
      background: #0b1829;
      border-right: 1px solid rgba(255,255,255,0.10);
    }
    .members-table thead th:nth-child(2){ z-index: 8; }

    .members-table tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .members-table tbody tr:last-child td{ border-bottom:none; }

    /* Emoji column: NEVER ellipsize */
    .members-table td.m-emoji,
    .members-table th.m-emoji{
      overflow: visible !important;
      text-overflow: clip !important;
      white-space: nowrap !important;
    }

    .m-emoji{
      text-align:right;
      font-size:14px;
      padding: 10px 6px 10px 10px;
      letter-spacing: 0;
    }

    .m-user-name{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Leader row underline ONLY (no bold) */
    .m-user-name.m-leader{
      font-weight:400;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    /* center all numeric columns */
    .m-num{
      font-family: monospace;
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:clip;
    }

    /* More links */
    .links{
      width:100%;
      max-width:280px;
      margin: 12px auto 0;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }
    .link-btn{
      width:100%;
      text-align:center;
      display:block;
      padding:12px;
      font-size:16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background-color:#fff;
      color:#000;
      text-decoration:none;
      box-sizing:border-box;
    }
    .install-btn{
      background-color:#ffcc00;
      color:#000;
      border:2px solid #000;
      padding:12px 20px;
      font-weight:700;
      border-radius:12px;
    }

    .page-footer{
      margin-top:auto;
      width:100%;
      padding:18px 0 0;
      font-size:14px;
      opacity:.7;
      text-align:center;
    }

    /* =========================
       PWA Bottom Tabs
       ========================= */
    body.has-pwa-tabs{
      padding-bottom: calc(var(--tabbar-h) + var(--safe-bottom) + 10px);
    }

    .pwa-tabbar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--tabbar-h);
      padding-bottom: var(--safe-bottom);
      background: var(--tabbar-bg);
      border-top: 1px solid var(--tabbar-border);
      z-index: 9999;
      display: none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      will-change: transform;
      transform: translate3d(0,0,0);
      transition: transform 180ms cubic-bezier(.2,.8,.2,1);
    }

    .pwa-tabbar.is-scrolling{ transition: none; }

    .pwa-tabbar .tabs{
      height: 100%;
      max-width: 560px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      align-items: center;
      padding: 10px 10px 12px;
      box-sizing: border-box;
      gap: 8px;
    }

    .pwa-tabbar a{
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      color:#fff;
      opacity: 0.78;
      border-radius: 16px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .tab-inner{
      width: 100%;
      height: 100%;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 10px 6px;
      box-sizing: border-box;
    }

    .pwa-tabbar a .icon{
      width: 22px;
      height: 22px;
      display:block;
      transform: translateY(-3px);
    }

    .pwa-tabbar a .icon img{
      width: 22px;
      height: 22px;
      display:block;
      object-fit:contain;
      -webkit-user-drag:none;
      user-select:none;
      pointer-events:none;
    }

    .pwa-tabbar a .label{
      font-size: 11px;
      line-height: 1;
      opacity: 0.95;
      transform: translateY(-2px);
      font-weight: 500;
    }

    .pwa-tabbar a.active{ opacity: 1; }
  </style>

  <script data-goatcounter="https://based.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</head>

<body>
  <img src="icontransparent.png" alt="B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D icon" class="app-icon" />
  <img src="logo.png" alt="B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D logo" class="logo" onerror="this.style.display='none';" />

  <a class="clan-tag-link"
     href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y"
     target="_blank" rel="noopener noreferrer">#2QQYJC08Y</a>

  <!-- Top nav (only when NOT PWA) -->
  <nav class="topnav" id="topNav" aria-label="Top navigation">
    <a href="#/home" data-route="home">Home</a>
    <a href="#/cwl" data-route="cwl">CWL</a>
    <a href="#/war" data-route="war">WAR</a>
    <a href="#/my-stats" data-route="mystats">My Stats</a>
    <a href="#/more" data-route="more">More</a>
  </nav>

  <div class="stage" id="stage">
    <div id="app" role="main" aria-live="polite"></div>
  </div>

  <!-- PWA Bottom Nav -->
  <nav class="pwa-tabbar" id="pwaTabbar" aria-label="Bottom navigation">
    <div class="tabs">
      <a href="#/home" data-route="home" data-img-key="home">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">Home</span>
        </div>
      </a>

      <a href="#/cwl" data-route="cwl" data-img-key="cwl">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">CWL</span>
        </div>
      </a>

      <a href="#/war" data-route="war" data-img-key="war">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">War</span>
        </div>
      </a>

      <a href="#/my-stats" data-route="mystats" data-img-key="my-stats">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">My Stats</span>
        </div>
      </a>

      <a href="#/more" data-route="more" data-img-key="more">
        <div class="tab-inner">
          <span class="icon" aria-hidden="true"><img alt="" /></span>
          <span class="label">More</span>
        </div>
      </a>
    </div>
  </nav>

  <script>
    function isPwaInstalled(){
      const standaloneDisplay = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const iosStandalone = (typeof navigator !== "undefined") && ("standalone" in navigator) && navigator.standalone;
      return !!(standaloneDisplay || iosStandalone);
    }

    function normalizeRoute(hash){
      const raw = (hash || "").replace(/^#\/?/, "").trim().toLowerCase();
      if(!raw || raw === "index.html") return "home";
      if(raw === "home") return "home";
      if(raw === "cwl") return "cwl";
      if(raw === "war") return "war";
      if(raw === "my-stats" || raw === "mystats") return "mystats";
      if(raw === "more") return "more";
      return "home";
    }

    function setActiveNav(route){
      document.querySelectorAll("[data-route]").forEach(a => {
        a.classList.toggle("active", (a.getAttribute("data-route") || "") === route);
      });
    }

    // ===== Icon swapping (cached + preloaded) =====
    const ICON_VER = "v1";
    const ICON_FILES = [
      "home-active.png","home-inactive.png",
      "cwl-active.png","cwl-inactive.png",
      "war-active.png","war-inactive.png",
      "my-stats-active.png","my-stats-inactive.png",
      "more-active.png","more-inactive.png"
    ];
    (function preloadTabIcons(){
      ICON_FILES.forEach(src => { const i = new Image(); i.src = `${src}?v=${ICON_VER}`; });
    })();

    function applyPwaImageIconStates(route){
      if(!isPwaInstalled()) return;
      const tabbar = document.getElementById("pwaTabbar");
      if(!tabbar) return;

      tabbar.querySelectorAll("a[data-img-key]").forEach(a => {
        const key = a.getAttribute("data-img-key");
        const img = a.querySelector(".icon img");
        if(!key || !img) return;

        const isActive = (a.getAttribute("data-route") === route);
        const file = isActive ? `${key}-active.png` : `${key}-inactive.png`;

        img.src = `${file}?v=${ICON_VER}`;
        img.loading = "eager";
        img.decoding = "async";
      });
    }

    function setupNavUI(){
      const pwa = isPwaInstalled();
      const topNav = document.getElementById("topNav");
      const tabbar = document.getElementById("pwaTabbar");

      if(pwa){
        if(topNav) topNav.style.display = "none";
        if(tabbar) tabbar.style.display = "block";
        document.body.classList.add("has-pwa-tabs");
      } else {
        if(topNav) topNav.style.display = "flex";
        if(tabbar) tabbar.style.display = "none";
        document.body.classList.remove("has-pwa-tabs");
      }
    }

    // ===== Templates =====
    const app = document.getElementById("app");

    function wrapInCards(innerHtml){
      return `<div class="cards">${innerHtml}</div>`;
    }

    function pageShellCards(title, subtitle){
      return wrapInCards(`
        <main class="page">
          <h1>${title}</h1>
          <p>${subtitle}</p>
        </main>
      `);
    }

    // MORE: In-Game Events at top
    function renderMore(){
      return `
        <div class="cards">
          <main class="page" style="display:flex; flex-direction:column; align-items:center; flex:1; padding:12px 0 0;">
            <h2 style="margin: 8px 0 14px;">In-Game Events</h2>

            <div style="width:100%; max-width:280px;">
              <div class="row">
                <span class="row-label">Raid Weekend</span>
                <span id="raid-timer" class="row-value">Loading‚Ä¶</span>
              </div>
              <div class="row">
                <span class="row-label">Clan Games</span>
                <span id="clan-games-timer" class="row-value">Loading‚Ä¶</span>
              </div>
              <div class="row">
                <span class="row-label">Season End</span>
                <span id="season-end-timer" class="row-value">Loading‚Ä¶</span>
              </div>
              <div class="row">
                <span class="row-label">League Reset</span>
                <span id="league-reset-timer" class="row-value">Loading‚Ä¶</span>
              </div>

              <div class="divider"></div>
            </div>

            <div class="links">
              <a class="link-btn" href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQJyBeqDwShAcLD0GMnIvNehs8P9eG3ApO6pltrMHe01bZVJn0k3bIxLobnjBpvqEQNDe_sFcRkZPE8/pubhtml" target="_blank" rel="noopener noreferrer">CWL Leaderboards</a>
              <a class="link-btn" href="https://discord.gg/8P96687dPr" target="_blank" rel="noopener noreferrer">Clan Discord</a>
              <a class="link-btn" href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y" target="_blank" rel="noopener noreferrer">Visit B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D</a>
              <a class="link-btn" href="https://www.clashofstats.com/clans/based-2QQYJC08Y/summary" target="_blank" rel="noopener noreferrer">Clan Stats</a>
              <a class="link-btn" href="https://store.supercell.com/" target="_blank" rel="noopener noreferrer">SuperCell Store</a>
              <a class="link-btn install-btn" href="https://www.youtube.com/watch?v=gIC30U39zpA" target="_blank" rel="noopener noreferrer">How to install B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D App</a>
            </div>

            <div class="page-footer">EST DECEMBER 2023</div>
          </main>
        </div>
      `;
    }

    // HOME (War sections removed; Members kept here)
    function renderHome(){
      return `
        <div class="cards">
          <h2 class="cards-title">Clan Overview</h2>

          <div id="rankings-block">
            <div class="section-title">Rankings</div>
            <div class="row">
              <span class="row-label">Global Trophies</span>
              <span id="rank-global-trophies" class="row-value">Loading‚Ä¶</span>
            </div>
            <div class="row">
              <span class="row-label">USA Trophies</span>
              <span id="rank-usa-trophies" class="row-value">Loading‚Ä¶</span>
            </div>
            <div class="divider"></div>
          </div>

          <div class="section-title">CWL</div>
          <div class="row">
            <span class="row-label">CWL League</span>
            <span id="cwl-league" class="row-value">Loading‚Ä¶</span>
          </div>
          <div class="row">
            <span class="row-label">Last CWL Finish</span>
            <span id="cwl-finish" class="row-value">Loading‚Ä¶</span>
          </div>

          <div class="divider"></div>

          <div class="section-title">Members</div>

          <!-- ‚úÖ NO BOX. Leader/Co aligned to table emoji + username. Vertically centered to filter -->
          <div class="members-controls">
            <div class="members-keyline" aria-label="Members key">
              <span class="key-emoji">üëë</span>
              <span class="key-text"><span class="legend-underline">Leader</span> / Co</span>
            </div>

            <div class="members-sort">
              <label for="membersSortSelect">Sort by</label>
              <select id="membersSortSelect">
                <option value="role">Role</option>
                <option value="th">TH</option>
                <option value="trophies">Trophies</option>
                <option value="warStars">War Stars</option>
                <option value="xp">XP</option>
                <option value="donated">Donated</option>
                <option value="received">Received</option>
              </select>
            </div>
          </div>

          <div class="members-wrap" aria-label="Clan members list">
            <table class="members-table">
              <colgroup>
                <col style="width: var(--m-emoji-col);">   <!-- Emoji -->
                <col style="width: var(--m-name-col);">    <!-- Username -->
                <col style="width: 44px;">                 <!-- TH -->
                <col style="width: 84px;">                 <!-- Trophies -->
                <col style="width: 98px;">                 <!-- War Stars -->
                <col style="width: 58px;">                 <!-- XP -->
                <col style="width: 86px;">                 <!-- Donated -->
                <col style="width: 96px;">                 <!-- Received -->
              </colgroup>

              <thead>
                <!-- ‚úÖ Elder on same line as scroll text; row sits above emoji/username -->
                <tr class="members-meta-row">
                  <th colspan="2">
                    <div class="members-meta">
                      <div class="elder-label" aria-label="Elder key">
                        <span class="e-emoji">üõ°Ô∏è</span>
                        <span class="e-text">Elder</span>
                      </div>
                      <div class="scroll-hint-inline">‚Üê SCROLL / SWIPE ‚Üí</div>
                    </div>
                  </th>
                  <th colspan="6"></th>
                </tr>

                <tr>
                  <th class="m-emoji" style="text-align:right;"></th>
                  <th style="text-align:left;"></th>
                  <th class="m-num">TH</th>
                  <th class="m-num">Trophies</th>
                  <th class="m-num">War Stars</th>
                  <th class="m-num">XP</th>
                  <th class="m-num">Donated</th>
                  <th class="m-num">Received</th>
                </tr>
              </thead>

              <tbody id="members-body">
                <tr><td colspan="8" style="opacity:.75;">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // WAR page (moved "War" + "Current War" sections here; remove placeholder title)
    function renderWarPage(){
      return `
        <div class="cards">
          <div class="section-title">War</div>
          <div class="row">
            <span class="row-label">War Record</span>
            <span id="war-record" class="row-value">Loading‚Ä¶</span>
          </div>
          <div class="row">
            <span class="row-label">Last 10 Wars</span>
            <span id="war-last10" class="row-value">Loading‚Ä¶</span>
          </div>
          <div class="row">
            <span class="row-label">Last 25 Wars</span>
            <span id="war-last25" class="row-value">Loading‚Ä¶</span>
          </div>
          <div class="row">
            <span class="row-label">Last 50 Wars</span>
            <span id="war-last50" class="row-value">Loading‚Ä¶</span>
          </div>
          <div class="row">
            <span class="row-label">Current Streak</span>
            <span id="war-streak" class="row-value">Loading‚Ä¶</span>
          </div>
          <div class="row">
            <span class="row-label">Longest Streak</span>
            <span id="war-longest" class="row-value">Loading‚Ä¶</span>
          </div>

          <div class="divider"></div>

          <div class="section-title">Current War</div>
          <div class="war-board">
            <div id="war-timer" class="war-timer">Loading‚Ä¶</div>

            <div class="war-grid-3">
              <div>
                <div id="war-name-us" class="war-name">‚Äî</div>
                <div class="war-stat">
                  <span id="war-stars-us">‚Äî</span> <span>‚≠ê</span>
                </div>
                <div class="war-substat">
                  <span id="war-destr-us">‚Äî</span> <span>üéØ</span>
                </div>
                <div class="war-substat">
                  <span id="war-attacks-us">‚Äî</span> <span>‚öîÔ∏è</span>
                </div>
              </div>

              <div id="war-vs" class="war-vs">VS</div>

              <div>
                <div id="war-name-opp" class="war-name">‚Äî</div>
                <div class="war-stat">
                  <span id="war-stars-opp">‚Äî</span> <span>‚≠ê</span>
                </div>
                <div class="war-substat">
                  <span id="war-destr-opp">‚Äî</span> <span>üéØ</span>
                </div>
                <div class="war-substat">
                  <span id="war-attacks-opp">‚Äî</span> <span>‚öîÔ∏è</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderRouteContent(route){
      if(route === "home") return renderHome();
      if(route === "cwl") return pageShellCards("CWL", "Coming Soon!");
      if(route === "war") return renderWarPage();
      if(route === "mystats") return pageShellCards("My Stats", "Coming Soon!");
      if(route === "more") return renderMore();
      return renderHome();
    }

    // ===== Data endpoints =====
    const RAW_WAR_URL_BASE     = "./war.json";
    const RAW_CLAN_URL_BASE    = "./clan_stats.json";
    const RAW_MEMBERS_URL_BASE = "./members.json";

    // ===== Interval buckets by route =====
    let homeIntervals = [];
    let warIntervals  = [];
    let moreIntervals = [];

    function clearIntervals(arr){ arr.forEach(id => clearInterval(id)); arr.length = 0; }

    let warData = null;
    let warFetched = false;
    const LAST_WAR_STORAGE_KEY = "based_last_war_snapshot";
    let lastWarSnapshot = null;

    let clanStats = null;
    let membersData = null;

    // Members sort state
    let membersSortMode = "role";

    function pad(n){ return n.toString().padStart(2,"0"); }
    function formatCountdown(ms){
      if(ms<=0) return "Active now";
      const totalSeconds = Math.floor(ms/1000);
      const days = Math.floor(totalSeconds/86400);
      const hours = Math.floor((totalSeconds%86400)/3600);
      const minutes = Math.floor((totalSeconds%86400%3600)/60);
      const seconds = totalSeconds%60;
      return days+"d "+pad(hours)+"h "+pad(minutes)+"m "+pad(seconds)+"s";
    }
    function makeUTC(y,m,d,h,mi=0){ return new Date(Date.UTC(y,m,d,h,mi,0)); }
    function setText(id, text){ const el = document.getElementById(id); if(el) el.textContent = text; }

    function setRankingsVisibility(show){
      const block = document.getElementById("rankings-block");
      if(block) block.style.display = show ? "block" : "none";
    }
    function setWarVsVisibility(show){
      const vs = document.getElementById("war-vs");
      if(vs) vs.style.display = show ? "block" : "none";
    }
    function fmtTop200(v){ if(typeof v === "number") return "#" + v; return "Not in top 200"; }
    function fmtPct(v){
      if(typeof v !== "number" || !isFinite(v)) return "‚Äî";
      const rounded = Math.round(v * 10) / 10;
      return (rounded % 1 === 0) ? `${rounded.toFixed(0)}%` : `${rounded.toFixed(1)}%`;
    }
    function isFullStars(stars, teamSize){
      if(typeof stars !== "number" || typeof teamSize !== "number") return false;
      return stars === teamSize * 3;
    }
    function isFullDestruction(pct){
      if(typeof pct !== "number" || !isFinite(pct)) return false;
      return pct === 100;
    }
    function winPctFromWLT(w, l, t){
      const W=(w|0), L=(l|0), T=(t|0);
      const total=W+L+T;
      if(total<=0) return null;
      return (W + 0.5*T)/total;
    }
    function fmtPctDecimal(p){ if(typeof p !== "number" || !isFinite(p)) return ""; return ` (${p.toFixed(3)})`; }
    function fmtWLTWithPctObj(obj){
      if(!obj || typeof obj !== "object") return { text:"‚Äî", losses:null };
      const w=(typeof obj.wins==="number")?obj.wins:null;
      const l=(typeof obj.losses==="number")?obj.losses:null;
      const t=(typeof obj.ties==="number")?obj.ties:null;
      if(w===null||l===null||t===null) return { text:"‚Äî", losses:null };
      const pct=winPctFromWLT(w,l,t);
      return { text:`${w}-${l}-${t}${fmtPctDecimal(pct)}`, losses:l };
    }
    function fmtWLTWithPctNums(w,l,t){
      const pct=winPctFromWLT(w,l,t);
      return { text:`${w}-${l}-${t}${fmtPctDecimal(pct)}`, losses:(l|0) };
    }
    function hasNoLosses(losses){ return typeof losses==="number" && isFinite(losses) && losses===0; }

    function setClass(id, className, on){
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle(className, !!on);
    }
    function resetWarHighlights(){
      ["war-stars-us","war-stars-opp","war-destr-us","war-destr-opp"].forEach(id => setClass(id,"war-green",false));
    }

    function loadLastWarSnapshot(){
      try{
        const raw = localStorage.getItem(LAST_WAR_STORAGE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object" && obj.state && obj.state !== "notInWar") return obj;
      } catch(e){}
      return null;
    }
    function saveLastWarSnapshot(w){
      try{ localStorage.setItem(LAST_WAR_STORAGE_KEY, JSON.stringify(w)); } catch(e){}
    }
    lastWarSnapshot = loadLastWarSnapshot();

    async function fetchWarData(){
      try{
        const url = RAW_WAR_URL_BASE + "?cb=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        warData = res.ok ? await res.json() : null;
        if(warData && warData.state && warData.state !== "notInWar"){
          lastWarSnapshot = warData;
          saveLastWarSnapshot(warData);
        }
      } catch(e){ warData = null; }
      warFetched = true;
      renderWarSection();
    }

    function updateWarTimerOnly(isPrevious, displayOverride){
      const warElem = document.getElementById("war-timer");
      if(!warElem) return;
      const src = displayOverride || warData;
      if(!src || !src.state){ warElem.textContent="Waiting‚Ä¶"; return; }
      if(isPrevious){ warElem.textContent="Previous war ended"; return; }
      if(src.state==="notInWar" || !src.warEndIso){ warElem.textContent="No war started"; return; }
      const end = new Date(src.warEndIso);
      const now = new Date();
      if(isNaN(end.getTime())) warElem.textContent="No war started";
      else if(now >= end) warElem.textContent="War ended";
      else warElem.textContent = formatCountdown(end - now);
    }

    function renderWarSection(){
      if(!document.getElementById("war-timer")) return;

      resetWarHighlights();
      setWarVsVisibility(false);

      if(!warFetched){ setText("war-timer","Loading‚Ä¶"); return; }

      let display = warData;
      if(display && display.state === "notInWar" && lastWarSnapshot) display = lastWarSnapshot;

      if(!display || !display.state){ setText("war-timer","Waiting‚Ä¶"); return; }

      if(display.state === "notInWar"){
        setText("war-timer","No war started");
        setText("war-name-us","‚Äî"); setText("war-name-opp","‚Äî");
        setText("war-stars-us","‚Äî"); setText("war-stars-opp","‚Äî");
        setText("war-destr-us","‚Äî"); setText("war-destr-opp","‚Äî");
        setText("war-attacks-us","‚Äî"); setText("war-attacks-opp","‚Äî");
        return;
      }

      const showingPrevious = (warData && warData.state === "notInWar" && lastWarSnapshot);
      setWarVsVisibility(true);

      setText("war-name-us",(display.ourName || "US"));
      setText("war-name-opp",(display.oppName || "OPPONENT"));

      const teamSize = (typeof display.teamSize === "number") ? display.teamSize : null;
      const maxStars = teamSize ? teamSize * 3 : null;

      const ourStars = (typeof display.ourStars === "number") ? display.ourStars : 0;
      const oppStars = (typeof display.oppStars === "number") ? display.oppStars : 0;

      setText("war-stars-us", maxStars ? `${ourStars}/${maxStars}` : `${ourStars}`);
      setText("war-stars-opp", maxStars ? `${oppStars}/${maxStars}` : `${oppStars}`);

      const ourDestr =
        (typeof display.ourDestructionPercentage === "number") ? display.ourDestructionPercentage :
        (typeof display.ourDestruction === "number") ? display.ourDestruction : null;

      const oppDestr =
        (typeof display.oppDestructionPercentage === "number") ? display.oppDestructionPercentage :
        (typeof display.oppDestruction === "number") ? display.oppDestruction : null;

      setText("war-destr-us", fmtPct(ourDestr));
      setText("war-destr-opp", fmtPct(oppDestr));

      if(teamSize && typeof display.ourAttacksUsed === "number" && typeof display.oppAttacksUsed === "number"){
        const total = teamSize * 2;
        const ourUsed = Math.max(0, Math.min(total, display.ourAttacksUsed));
        const oppUsed = Math.max(0, Math.min(total, display.oppAttacksUsed));
        setText("war-attacks-us", `${ourUsed}/${total}`);
        setText("war-attacks-opp", `${oppUsed}/${total}`);
      } else {
        setText("war-attacks-us","Updating‚Ä¶");
        setText("war-attacks-opp","Updating‚Ä¶");
      }

      setClass("war-stars-us","war-green", isFullStars(ourStars, teamSize));
      setClass("war-stars-opp","war-green", isFullStars(oppStars, teamSize));
      setClass("war-destr-us","war-green", isFullDestruction(ourDestr));
      setClass("war-destr-opp","war-green", isFullDestruction(oppDestr));

      updateWarTimerOnly(showingPrevious, display);
    }

    async function fetchClanStats(){
      try{
        const url = RAW_CLAN_URL_BASE + "?cb=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        clanStats = res.ok ? await res.json() : null;
      } catch(e){ clanStats = null; }
      renderClanStats();
    }

    function renderClanStats(){
      // Rankings/CWL can render on Home (or anywhere those IDs exist)
      if(clanStats){
        const r = clanStats.rankings || {};
        const hasAnyRank = (typeof r.globalTrophies === "number") || (typeof r.usaTrophies === "number");
        setRankingsVisibility(hasAnyRank);

        if(hasAnyRank){
          setText("rank-global-trophies", fmtTop200(r.globalTrophies));
          setText("rank-usa-trophies", fmtTop200(r.usaTrophies));
        }

        setText("cwl-league", (clanStats.cwl && clanStats.cwl.currentLeague) ? clanStats.cwl.currentLeague : "‚Äî");
        setText("cwl-finish", (clanStats.cwl && clanStats.cwl.lastFinish) ? clanStats.cwl.lastFinish : "‚Äî");
      } else {
        setRankingsVisibility(false);
      }

      // War record elements live on WAR route
      if(!document.getElementById("war-record")) return;

      setClass("war-record","record-green", false);
      setClass("war-last10","record-green", false);
      setClass("war-last25","record-green", false);
      setClass("war-last50","record-green", false);

      if(!clanStats || !clanStats.war) return;

      const w = clanStats.war.wins ?? 0;
      const l = clanStats.war.losses ?? 0;
      const t = clanStats.war.ties ?? 0;

      const rec = fmtWLTWithPctNums(w,l,t);
      setText("war-record", rec.text);
      setClass("war-record", "record-green", hasNoLosses(rec.losses));

      setText("war-streak", `${clanStats.war.currentStreak ?? "‚Äî"}`);
      setText("war-longest", `${clanStats.war.longestStreak ?? "‚Äî"}`);

      const l10 = fmtWLTWithPctObj(clanStats.war.last10);
      const l25 = fmtWLTWithPctObj(clanStats.war.last25);
      const l50 = fmtWLTWithPctObj(clanStats.war.last50);

      setText("war-last10", l10.text);
      setText("war-last25", l25.text);
      setText("war-last50", l50.text);

      setClass("war-last10","record-green", hasNoLosses(l10.losses));
      setClass("war-last25","record-green", hasNoLosses(l25.losses));
      setClass("war-last50","record-green", hasNoLosses(l50.losses));
    }

    // ===== Members =====
    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function roleEmoji(role){
      const r = String(role || "").toLowerCase();
      if(r.includes("leader")) return "üëë";
      if(r === "elder") return "üõ°Ô∏è";
      return "";
    }

    function isLeaderOnly(role){
      return String(role || "").trim().toLowerCase() === "leader";
    }

    function readIntAny(obj, keys){
      for(const k of keys){
        const v = obj?.[k];
        if(v !== null && v !== undefined && v !== "") return (v|0);
      }
      return 0;
    }

    function getThLevel(m){
      let n = readIntAny(m, ["townHallLevel","th","thLevel","townHall","townhallLevel"]);
      if(n > 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["townHallLevel","th","thLevel","townHall","townhallLevel"]);
      return n > 0 ? n : 0;
    }

    function getWarStars(m){
      let n = readIntAny(m, ["warStars","totalWarStars","warStarCount","totalStars","stars"]);
      if(n >= 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["warStars","totalWarStars","warStarCount","totalStars","stars"]);
      return n >= 0 ? n : 0;
    }

    function getXP(m){
      let n = readIntAny(m, ["expLevel","xp","level"]);
      if(n > 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["expLevel","xp","level"]);
      return n > 0 ? n : 0;
    }

    function getTrophies(m){
      let n = readIntAny(m, ["trophies"]);
      if(n > 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["trophies"]);
      return n > 0 ? n : 0;
    }

    function getDonations(m){
      let n = readIntAny(m, ["donations","troopsDonated","donated"]);
      if(n >= 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["donations","troopsDonated","donated"]);
      return n >= 0 ? n : 0;
    }

    function getDonationsReceived(m){
      let n = readIntAny(m, ["donationsReceived","troopsReceived","received"]);
      if(n >= 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["donationsReceived","troopsReceived","received"]);
      return n >= 0 ? n : 0;
    }

    function roleRank(role){
      const r = String(role || "").toLowerCase();
      if(r.includes("leader")) return 1;
      if(r === "elder" || r === "admin") return 2;
      return 3;
    }

    function compareName(a,b){
      return String(a.name||"").localeCompare(String(b.name||""), undefined, { sensitivity:"base" });
    }

    function ensureSortDropdownBound(){
      const sel = document.getElementById("membersSortSelect");
      if(!sel) return;

      sel.value = membersSortMode;

      if(sel.dataset.bound === "1") return;
      sel.addEventListener("change", () => {
        membersSortMode = sel.value || "role";
        renderMembers();
      });
      sel.dataset.bound = "1";
    }

    function renderMembers(){
      const tbody = document.getElementById("members-body");
      if(!tbody) return;

      ensureSortDropdownBound();

      const list = (membersData && Array.isArray(membersData.members)) ? membersData.members : null;

      if(!list){
        tbody.innerHTML = `<tr><td colspan="8" style="opacity:.75;">Loading‚Ä¶</td></tr>`;
        return;
      }
      if(list.length === 0){
        tbody.innerHTML = `<tr><td colspan="8" style="opacity:.75;">No members found.</td></tr>`;
        return;
      }

      const sorted = list.slice().sort((a,b) => {
        const ta = getTrophies(a), tb = getTrophies(b);
        const xa = getXP(a), xb = getXP(b);
        const wa = getWarStars(a), wb = getWarStars(b);
        const ha = getThLevel(a), hb = getThLevel(b);
        const ra = roleRank(a.role), rb = roleRank(b.role);
        const da = getDonations(a), db = getDonations(b);
        const rxa = getDonationsReceived(a), rxb = getDonationsReceived(b);

        if(membersSortMode === "role"){
          if(ra !== rb) return ra - rb;
          if(tb !== ta) return tb - ta;
          if(xb !== xa) return xb - xa;
          return compareName(a,b);
        }

        if(membersSortMode === "th"){
          if(hb !== ha) return hb - ha;
          if(xb !== xa) return xb - xa;
          if(wb !== wa) return wb - wa;
          return compareName(a,b);
        }

        if(membersSortMode === "trophies"){
          if(tb !== ta) return tb - ta;
          if(xb !== xa) return xb - xa;
          return compareName(a,b);
        }

        if(membersSortMode === "warStars"){
          if(wb !== wa) return wb - wa;
          if(xb !== xa) return xb - xa;
          if(tb !== ta) return tb - ta;
          return compareName(a,b);
        }

        if(membersSortMode === "xp"){
          if(xb !== xa) return xb - xa;
          if(tb !== ta) return tb - ta;
          if(hb !== ha) return hb - ha;
          return compareName(a,b);
        }

        if(membersSortMode === "donated"){
          if(db !== da) return db - da;
          if(xb !== xa) return xb - xa;
          if(tb !== ta) return tb - ta;
          return compareName(a,b);
        }

        if(membersSortMode === "received"){
          if(rxb !== rxa) return rxb - rxa;
          if(xb !== xa) return xb - xa;
          if(tb !== ta) return tb - ta;
          return compareName(a,b);
        }

        if(tb !== ta) return tb - ta;
        if(xb !== xa) return xb - xa;
        return compareName(a,b);
      });

      tbody.innerHTML = sorted.map(m => {
        const badge = roleEmoji(m.role);
        const name = escapeHtml(m.name);
        const th = getThLevel(m);
        const trophies = getTrophies(m);
        const warStars = getWarStars(m);
        const xp = getXP(m);
        const donated = getDonations(m);
        const received = getDonationsReceived(m);

        const leaderClass = isLeaderOnly(m.role) ? "m-leader" : "";

        return `
          <tr>
            <td class="m-emoji">${badge || ""}</td>
            <td><span class="m-user-name ${leaderClass}">${name}</span></td>
            <td class="m-num">${th ? th : "‚Äî"}</td>
            <td class="m-num">${trophies ? trophies : 0}</td>
            <td class="m-num">${warStars ? warStars : 0}</td>
            <td class="m-num">${xp ? xp : 0}</td>
            <td class="m-num">${donated}</td>
            <td class="m-num">${received}</td>
          </tr>
        `;
      }).join("");
    }

    async function fetchMembersData(){
      try{
        const url = RAW_MEMBERS_URL_BASE + "?cb=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        membersData = res.ok ? await res.json() : null;
      } catch(e){
        membersData = null;
      }
      renderMembers();
    }

    // ===== Timers (More page) =====
    function getNextRaidWeekendEnd(now){
      const day = now.getUTCDay();
      const diffToFriday = (5 - day + 7) % 7;
      let fridayStart = makeUTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + diffToFriday, 7);
      let mondayEnd = new Date(fridayStart.getTime() + 3*24*60*60*1000);
      if(now >= fridayStart && now <= mondayEnd) return mondayEnd;
      if(now > mondayEnd){
        fridayStart = new Date(fridayStart.getTime() + 7*24*60*60*1000);
        mondayEnd = new Date(fridayStart.getTime() + 3*24*60*60*1000);
      }
      return mondayEnd;
    }
    function getNextClanGamesEnd(now){
      const y=now.getUTCFullYear(), m=now.getUTCMonth();
      const start = makeUTC(y,m,22,8);
      const end   = makeUTC(y,m,28,8);
      if(now < start) return end;
      if(now <= end) return end;
      const nextMonth = new Date(Date.UTC(y, m+1, 1));
      return makeUTC(nextMonth.getUTCFullYear(), nextMonth.getUTCMonth(), 28, 8);
    }
    function getNextSeasonEnd(now){ return makeUTC(now.getUTCFullYear(), now.getUTCMonth()+1, 1, 8); }
    function getNextLeagueReset(now){
      const y=now.getUTCFullYear(), m=now.getUTCMonth();
      let first = makeUTC(y,m,1,5);
      const diffToMonday = (1 - first.getUTCDay() + 7) % 7;
      let reset = makeUTC(y,m,1+diffToMonday,5);
      if(now > reset){
        const nm = new Date(Date.UTC(y, m+1, 1));
        let firstNext = makeUTC(nm.getUTCFullYear(), nm.getUTCMonth(), 1, 5);
        const diffNext = (1 - firstNext.getUTCDay() + 7) % 7;
        reset = makeUTC(nm.getUTCFullYear(), nm.getUTCMonth(), 1+diffNext, 5);
      }
      return reset;
    }
    function updateRecurringTimers(){
      if(!document.getElementById("raid-timer")) return;
      const now = new Date();
      setText("raid-timer", formatCountdown(getNextRaidWeekendEnd(now) - now));
      setText("clan-games-timer", formatCountdown(getNextClanGamesEnd(now) - now));
      setText("season-end-timer", formatCountdown(getNextSeasonEnd(now) - now));
      setText("league-reset-timer", formatCountdown(getNextLeagueReset(now) - now));
    }

    function startHomeDataLoop(){
      clearIntervals(homeIntervals);

      membersSortMode = "role";

      fetchClanStats();
      fetchMembersData();

      homeIntervals.push(setInterval(fetchClanStats, 5*1000));
      homeIntervals.push(setInterval(fetchMembersData, 10*1000));
    }

    function startWarDataLoop(){
      clearIntervals(warIntervals);
      warFetched = false;

      fetchWarData();
      fetchClanStats();

      warIntervals.push(setInterval(() => updateWarTimerOnly(false, null), 1000));
      warIntervals.push(setInterval(fetchWarData, 5*1000));
      warIntervals.push(setInterval(fetchClanStats, 5*1000));
    }

    function startMoreTimers(){
      clearIntervals(moreIntervals);
      updateRecurringTimers();
      moreIntervals.push(setInterval(updateRecurringTimers, 1000));
    }

    // ===== Router + tab UI =====
    function setDocTitle(route){
      const map = {
        home: "B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî Home",
        cwl: "B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî CWL",
        war: "B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî War",
        mystats: "B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî My Stats",
        more: "B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî More",
      };
      document.title = map[route] || "B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D";
    }

    function renderRoute(){
      const route = normalizeRoute(location.hash);

      setupNavUI();
      setActiveNav(route);
      applyPwaImageIconStates(route);
      setDocTitle(route);

      // stop old loops
      clearIntervals(homeIntervals);
      clearIntervals(warIntervals);
      clearIntervals(moreIntervals);

      app.innerHTML = renderRouteContent(route);

      if(route === "home") startHomeDataLoop();
      if(route === "war")  startWarDataLoop();
      if(route === "more") startMoreTimers();
      // CWL / My Stats placeholders: no loops needed
    }

    if(!location.hash) location.hash = "#/home";
    setupNavUI();
    renderRoute();

    window.addEventListener("hashchange", renderRoute);
    window.addEventListener("pageshow", renderRoute);
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible") renderRoute();
    });
  </script>
</body>
</html>
