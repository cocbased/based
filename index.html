<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî Home</title>

  <link rel="apple-touch-icon" href="icon-180.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="favicon.png">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <style>
    :root{
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --tabbar-h: 92px;
      --tabbar-bg: rgba(12,12,12,0.96);
      --tabbar-border: rgba(255,255,255,0.10);

      --m-emoji-col: 30px;
      --m-name-col: 102px;

      --cards-max: 680px;

      /* ‚úÖ UI colors used for scrollbar + dividers */
      --card-bg: #0b1829;
      --card-border: #2b3b55;
      --scroll-track: rgba(0,0,0,0.22);
      --scroll-thumb: var(--card-border);

      --sep-strong: rgba(255,255,255,0.16);
      --sep-soft: rgba(255,255,255,0.10);

      /* ‚úÖ CWL "War" column tint (dark grey) */
      --cwl-war-bg: rgba(22, 22, 22, 0.92);
      --cwl-war-bg-soft: rgba(18, 18, 18, 0.72);
      --rounds-gutter: 38px; /* space reserved for the carousel arrows */
    }

    html{ overflow-y: scroll; scrollbar-gutter: stable both-edges; }

    /* ‚úÖ Non-PWA scrollbar styling (safe to apply globally; mobile/PWA mostly ignores) */
    html, body{
      scrollbar-color: var(--scroll-thumb) var(--scroll-track);
      scrollbar-width: thin;
    }
    /* WebKit scrollbars */
    ::-webkit-scrollbar{ width: 10px; height: 10px; }
    ::-webkit-scrollbar-track{ background: var(--scroll-track); }
    ::-webkit-scrollbar-thumb{
      background: var(--scroll-thumb);
      border-radius: 999px;
      border: 2px solid var(--scroll-track);
    }
    ::-webkit-scrollbar-thumb:hover{ filter: brightness(1.08); }

    /* Scroll containers */
    .members-wrap::-webkit-scrollbar,
    .cwl-table-wrap::-webkit-scrollbar,
    .war-chart-wrap::-webkit-scrollbar,
    .dragscroll::-webkit-scrollbar{
      height: 10px;
    }
    .members-wrap::-webkit-scrollbar-track,
    .cwl-table-wrap::-webkit-scrollbar-track,
    .war-chart-wrap::-webkit-scrollbar-track,
    .dragscroll::-webkit-scrollbar-track{
      background: var(--scroll-track);
      border-radius: 999px;
    }
    .members-wrap::-webkit-scrollbar-thumb,
    .cwl-table-wrap::-webkit-scrollbar-thumb,
    .war-chart-wrap::-webkit-scrollbar-thumb,
    .dragscroll::-webkit-scrollbar-thumb{
      background: var(--scroll-thumb);
      border-radius: 999px;
      border: 2px solid var(--scroll-track);
    }

    .topnav{ flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .topnav::-webkit-scrollbar{ display:none; }
    .topnav a{ flex: 0 0 auto; }
    .stage, #app{ min-height: 0; }

    body, body *{
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    input, textarea, select, option, button{
      -webkit-user-select: text;
      user-select: text;
      -webkit-touch-callout: default;
    }

    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
      justify-content:flex-start;
      text-align:center;
      padding:24px 16px;
      box-sizing:border-box;
      overscroll-behavior-x: none;
    }

    .app-icon{ width:90px; height:90px; margin-bottom:12px; border-radius:20px; object-fit:contain; }
    .logo{ width:100%; max-width:225px; height:auto; margin-bottom:16px; object-fit:contain; }

    .clan-tag-link{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      font-size:14px;
      display:inline-block;
      margin:8px 0 10px;
    }
    .clan-tag-link:hover{ text-decoration:underline; opacity:1; }

    .topnav{
      width:100%;
      max-width:560px;
      display:flex;
      justify-content:center;
      gap:10px;
      padding:10px 8px 18px;
      box-sizing:border-box;
    }
    .topnav a{
      text-decoration:none;
      color:#fff;
      opacity:0.82;
      font-size:13px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      white-space:nowrap;
    }
    .topnav a.active{
      opacity:1;
      font-weight:700;
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.08);
    }

    .stage{ width:100%; max-width:560px; position:relative; flex:1; display:flex; justify-content:center; }
    #app{ width:100%; max-width:560px; display:flex; flex-direction:column; align-items:center; flex:1; touch-action:auto; }

    .cards{
      width:100%;
      max-width: min(var(--cards-max), 100%);
      margin-bottom:24px;
      padding:12px 16px;
      border-radius:12px;
      background: var(--card-bg);
      border:1px solid var(--card-border);
      box-sizing:border-box;
      text-align:left;
      display:flex;
      flex-direction:column;
    }
    .cards-title{ margin:0 0 6px; font-size:16px; text-align:center; font-weight:700; }
    .section-title{
      margin:10px 0 6px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.75;
      text-align:center;
    }
    .divider{ height:1px; background:rgba(255,255,255,.12); margin:10px 0; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:14px; padding:2px 0; gap:12px; }
    .row-label{ font-weight:600; white-space:nowrap; }
    .row-value{ font-family:monospace; text-align:right; flex:1; }

    .clan-desc-block{ text-align:center; white-space: pre-line; line-height: 1.25; opacity: .95; padding: 2px 0 6px; }
    #rankings-block{ display:none; }

    .war-board{ text-align:center; margin-top:6px; }
    .war-timer{ font-family:monospace; font-weight:900; font-size:14px; margin:6px 0 10px; }
    .war-grid-3{ display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; }
    .war-vs{ font-weight:900; font-size:14px; opacity:.7; }
    .war-name{
      font-weight:800; font-size:13px; letter-spacing:.05em;
      text-transform:uppercase; margin-bottom:6px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .war-stat, .war-substat{
      font-family:monospace; font-weight:900; font-size:14px;
      display:flex; justify-content:center; align-items:center; gap:6px;
    }
    .war-stat{ margin-top:6px; }
    .war-substat{ margin-top:8px; opacity:.95; }
    .war-green{ color:#38d172; font-weight:900; }
    .record-green{ color:#38d172; font-weight:900; }

    .dragscroll{
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      cursor: grab;
    }
    .dragscroll.is-dragging{ cursor: grabbing; }
    .dragscroll, .dragscroll *{
      -webkit-user-select: none;
      user-select: none;
    }

    .war-chart-wrap{ margin-top: 12px; }
    .war-mode-title{
      margin: 10px 0 10px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.75;
      text-align:center;
    }

    .war-chart-block{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      border-radius: 10px;
      overflow: hidden;
      color:#fff;
    }
    .war-chart-block + .war-chart-block{ margin-top: 10px; }

    .war-chart-head{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .war-chart-clan{
      display:flex;
      align-items:center;
      gap: 8px;
      font-weight: 900;
      letter-spacing: .03em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width: 0;
      justify-content:center;
    }

    .war-sheet{ width:100%; display:block; }

    .war-sheet-row{
      display:grid;
      grid-template-columns: 26px minmax(0, 1fr) minmax(0, 1fr) 40px 64px 36px;
      align-items: stretch;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      min-height: 38px;
    }
    .war-sheet-row:last-child{ border-bottom:none; }

    .war-cell{
      padding: 8px 8px;
      font-size: 12.5px;
      overflow: hidden;
      text-overflow: ellipsis;
      display:flex;
      align-items:center;
      gap:6px;
      border-right: none !important;
      color:#fff;
      min-width: 0;
    }

    .war-cell.stack { white-space: normal; }
    .war-cell.mono{ font-family: monospace; white-space:nowrap; }
    .war-cell.center{ justify-content:center; text-align:center; }
    .war-cell.right{ justify-content:flex-end; text-align:right; }
    .war-cell.bold{ font-weight: 900; }
    .war-cell.numcol{ padding-right: 6px; opacity: .95; }

    .war-player{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .war-player .name{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .war-player .role{
      font-size:11px;
      opacity:.70;
      white-space:nowrap;
    }
    .war-name-role{
      font-size:11px;
      opacity:.70;
      font-weight:600;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .war-leader-underline{
      text-decoration: underline;
      text-underline-offset: 2px;
      font-weight: 900;
    }

    .war-role-emoji{
      font-size:14px;
      line-height:1;
      transform: translateY(1px);
      flex: 0 0 auto;
      opacity: .95;
    }

    .atk2{ display:flex; flex-direction:column; gap:4px; width:100%; min-width:0; }
    .atkline{
      display:flex;
      align-items:center;
      width:100%;
      font-family:monospace;
      font-size:11px;
      opacity:.95;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    .war-cell.defender{ justify-content:flex-end; text-align:right; }
    .war-cell.defender .atk2{ align-items:flex-end; }
    .war-cell.defender .atkline{ justify-content:flex-end; text-align:right; }

    .stars{ display:flex; align-items:center; justify-content:center; gap:4px; font-variant-numeric: tabular-nums; }
    .star{
      font-size:13px; line-height:1;
      color: rgba(255,215,0,0.95);
      text-shadow: 0 1px 0 rgba(0,0,0,0.35);
    }
    .star.dim{ color: rgba(255,255,255,0.18); text-shadow:none; }
    .muted{ opacity:.65; }

    .tiny-status{
      text-align:center;
      font-family:monospace;
      font-size:11px;
      opacity:.70;
      margin-top: 8px;
    }

    @media (max-width: 420px){
      .war-cell.defender{ justify-content: flex-start; text-align: left; }
      .war-cell.defender .atk2{ align-items: flex-start; }
      .war-cell.defender .atkline{
        justify-content: flex-start;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    
      :root{ --rounds-gutter: 22px; }
    }


    /* =========================
       Members (Home)
       ========================= */
    .members-headerbar{
      background: transparent; border:none; border-radius:0;
      padding:0; margin:0 0 8px;

      /* ‚úÖ center SCROLL perfectly via a true center column */
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      grid-template-rows: auto auto;
      column-gap: 12px;
      row-gap: 6px;
      align-items:center;
    }
    .members-leaderline{ grid-column:1/2; grid-row:1/2; justify-self:start; }
    .members-elderline{ grid-column:1/2; grid-row:2/3; justify-self:start; }

    .members-keyline{ display:flex; align-items:center; gap:10px; white-space:nowrap; }
    .key-emoji{ font-size:14px; line-height:1; }
    .key-text{ font-size:12px; line-height:1.2; }
    .legend-underline{ text-decoration: underline; text-underline-offset: 2px; font-weight: 400; }

    /* ‚úÖ perfectly centered */
    .members-scroll-inline{
      grid-column:2/3;
      grid-row:2/3;
      display:flex;
      justify-content:center;
      text-align:center;
      font-size:10px;
      letter-spacing:.03em;
      opacity:.78;
      white-space: nowrap;
      line-height: 1;
      pointer-events:none;
      justify-self:center;
    }
    .members-sortbtn-wrap{ grid-column:3/4; grid-row:1/3; justify-self:end; align-self:center; }

    .sort-btn{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 58px;
      height: 36px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .sort-btn select{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .sort-btn select option{ background:#0b1829; color:#fff; }

    .members-wrap{
      width:100%;
      margin-top:2px;
      overflow-x:auto;
      overflow-y:visible;
      -webkit-overflow-scrolling: touch;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }
    .members-table{
      width:100%;
      min-width: 720px;
      border-collapse: separate;
      border-spacing: 0;
      font-size:13px;
      table-layout: fixed;
    }
    .members-table thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #0b1829;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding: 10px 10px;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space: nowrap;
    }
    .members-table th:nth-child(1),
    .members-table td:nth-child(1){
      position: sticky;
      left: 0;
      z-index: 7;
      background: #0b1829;
      border-right: none;
    }
    .members-table thead th:nth-child(1){ z-index: 9; }

    .members-table th:nth-child(2),
    .members-table td:nth-child(2){
      position: sticky;
      left: var(--m-emoji-col);
      z-index: 6;
      background: #0b1829;
      border-right: 1px solid rgba(255,255,255,0.10);
    }
    .members-table thead th:nth-child(2){ z-index: 8; }

    .members-table tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .members-table tbody tr:last-child td{ border-bottom:none; }
    .members-table td.m-emoji,
    .members-table th.m-emoji{
      overflow: visible !important;
      text-overflow: clip !important;
      white-space: nowrap !important;
    }
    .m-emoji{ text-align:right; font-size:14px; padding: 10px 6px 10px 10px; letter-spacing:0; }
    .m-user-name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .m-user-name.m-leader{ font-weight:400; text-decoration: underline; text-underline-offset: 2px; }
    .m-num{ font-family: monospace; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:clip; }

    .links{
      width:100%;
      max-width:280px;
      margin: 12px auto 0;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }
    .link-btn{
      width:100%;
      text-align:center;
      display:block;
      padding:12px;
      font-size:16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background-color:#fff;
      color:#000;
      text-decoration:none;
      box-sizing:border-box;
    }
    .install-btn{
      background-color:#ffcc00;
      color:#000;
      border:2px solid #000;
      padding:12px 20px;
      font-weight:700;
      border-radius:12px;
    }

    .page-footer{
      margin-top:auto;
      width:100%;
      padding:18px 0 0;
      font-size:14px;
      opacity:.7;
      text-align:center;
    }

    body.has-pwa-tabs{
      padding-bottom: calc(var(--tabbar-h) + var(--safe-bottom) + 10px);
    }
    .pwa-tabbar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--tabbar-h);
      padding-bottom: var(--safe-bottom);
      background: var(--tabbar-bg);
      border-top: 1px solid var(--tabbar-border);
      z-index: 9999;
      display: none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      will-change: transform;
      transform: translate3d(0,0,0);
      transition: transform 180ms cubic-bezier(.2,.8,.2,1);
    }
    .pwa-tabbar.is-hidden{
      transform: translate3d(0, calc(var(--tabbar-h) + var(--safe-bottom) + 6px), 0);
      pointer-events: none;
    }
    .pwa-tabbar .tabs{
      height: 100%;
      max-width: 560px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      align-items: center;
      padding: 10px 10px 12px;
      box-sizing: border-box;
      gap: 8px;
    }
    .pwa-tabbar a{
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      color:#fff;
      opacity: 0.78;
      border-radius: 16px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .tab-inner{
      width: 100%;
      height: 100%;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 10px 6px;
      box-sizing: border-box;
    }
    .pwa-tabbar a .icon{ width: 22px; height: 22px; display:block; transform: translateY(-3px); }
    .pwa-tabbar a .icon img{
      width: 22px;
      height: 22px;
      display:block;
      object-fit:contain;
      -webkit-user-drag:none;
      user-select:none;
      pointer-events:none;
    }
    .pwa-tabbar a .label{ font-size: 11px; line-height: 1; opacity: 0.95; transform: translateY(-2px); font-weight: 500; }
    .pwa-tabbar a.active{ opacity: 1; }

    /* =========================
       ‚úÖ CWL
       ========================= */
    .cwl-headerbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 6px;
    }
    .cwl-headerbar .left{
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space:nowrap;
    }
    .cwl-pill{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 140px;
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .06em;
      text-transform: uppercase;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .cwl-pill select{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .cwl-pill select option{ background:#0b1829; color:#fff; }

    /* =========================
       ‚úÖ CWL title dropdown (replaces Current pill)
       ========================= */
    .cwl-titlebar{
      display:flex;
      justify-content:center;
      align-items:center;
      margin: 0 0 10px;
    }
    
    .cwl-title-dd{
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    
      /* keep it looking like a title */
      font-size: 16px;
      font-weight: 700;
      text-align: center;
    }
    
    .cwl-title-dd .caret{
      font-size: 12px;
      opacity: 0.75;
      transform: translateY(1px);
    }
    
    /* invisible select overlay so the whole title acts as the dropdown */
    .cwl-title-dd select{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }
    .cwl-title-dd select option{ background:#0b1829; color:#fff; }

    
    .cwl-table-wrap{
      width:100%;
      overflow-x:auto;
      overflow-y:visible;
      -webkit-overflow-scrolling: touch;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }
    .cwl-table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size:12.5px;
      table-layout: fixed;
    }
    .cwl-table thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #0b1829;               /* solid */
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding: 10px 10px;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
    
      /* ‚úÖ instead of opacity (which makes background transparent), tint the text */
      color: rgba(255,255,255,0.85);
    
      white-space: nowrap;
      text-align:center;
    }

    .cwl-table tbody td{
      padding: 9px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align:center;
      font-family: monospace;
    }
    .cwl-table tbody tr:last-child td{ border-bottom:none; }

    .cwl-table .left{ text-align:left; font-family: inherit; }
    .cwl-table .right{ text-align:right; }
    .cwl-table .mono{ font-family: monospace; }
    .cwl-table .bold{ font-weight:900; }
    .cwl-table .muted{ opacity:.70; }
    /* ‚úÖ League Overview highlights */
    .cwl-league .rank-good td{ color: rgba(56, 209, 114, 0.95); font-weight: 800; }
    .cwl-league .rank-bad  td{ color: rgba(255, 92, 92, 0.92); font-weight: 800; }
    /* ‚úÖ Member Overview: perfect performance highlight
       ONLY color the "general" columns (Avg Rk ‚Üí Atk), NOT the war columns,
       and do NOT make anything bold. */
    .cwl-perfect td:nth-child(-n+8){
      color: rgba(56, 209, 114, 0.95) !important;
      font-weight: 400 !important;
    }


    .cwl-war-sword{
      display:inline-block;
      margin-right:6px;
    }
    
    /* appended opponent name; can ellipsis */
    .cwl-war-oppname{
      display:inline-block;
      max-width: 88px;          /* adjust if you want */
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      vertical-align:bottom;
      color: rgba(255,255,255,0.85);
    }
    
    .cwl-wide{ min-width: 1220px; }
    .cwl-league{ min-width: 700px; width: 100%; }

    /* ‚úÖ tighter League Overview columns (padding tighter only for this table) */
    .cwl-table.cwl-league thead th{ padding: 8px 6px; }
    .cwl-table.cwl-league tbody td{ padding: 8px 6px; }

    .cwl-table th.sticky-1,
    .cwl-table td.sticky-1{
      position: sticky;
      left: 0;
      z-index: 7;
      background: #0b1829;
      text-align:center;
      font-family: monospace;
    }
    
    .cwl-table th.sticky-2,
    .cwl-table td.sticky-2{
      position: sticky;
      left: 54px; /* üó°Ô∏è RK width */
      z-index: 6;
      background: #0b1829;
      text-align:center;
      font-family: monospace;
    }
    
    .cwl-table th.sticky-3,
    .cwl-table td.sticky-3{
      position: sticky;
      left: 108px; /* 54 + 54 */
      z-index: 5;
      background: #0b1829;
      text-align:left;
      font-family: inherit;
      border-right: 1px solid rgba(255,255,255,0.10);
    }
    
    .cwl-table thead th.sticky-1{ z-index: 9; }
    .cwl-table thead th.sticky-2{ z-index: 8; }
    .cwl-table thead th.sticky-3{ z-index: 7; }


    /* ‚úÖ War group headers + war column tint */
    .cwl-warhead{
      background: var(--cwl-war-bg) !important;
      border-left: 1px solid rgba(255,255,255,0.10);
      border-right: 1px solid rgba(255,255,255,0.10);
    }
    .cwl-warcell{
      background: var(--cwl-war-bg-soft);
    }
    
    .cwl-table.cwl-wide thead tr:nth-child(2) th.cwl-warcell{
      background: var(--cwl-war-bg) !important;
    }
    
    /* ‚úÖ header row 2: make the ‚öîÔ∏è header cells darker too */
    .cwl-table.cwl-wide thead tr:nth-child(2) th.cwl-day-start{
      background: rgba(10,10,10,0.92) !important;
    }

    .cwl-note{
      opacity:.75;
      font-size:13px;
      text-align:center;
      padding: 6px 0 2px;
    }

    /* ‚úÖ CWL: headerbar that centers scroll text perfectly */
    .cwl-subheaderbar{
      background: transparent; border:none; border-radius:0;
      padding:0; margin:0 0 8px;

      /* ‚úÖ center column ensures perfect centering even with a right-side sort button */
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      grid-template-rows: auto;
      column-gap: 12px;
      align-items:center;
    }
    .cwl-scroll-inline{
      grid-column:2/3;
      display:flex;
      justify-content:center;
      text-align:center;
      font-size:10px;
      letter-spacing:.03em;
      opacity:.78;
      white-space: nowrap;
      line-height: 1;
      pointer-events:none;
      padding: 2px 0 0;
      justify-self:center;
    }
    .cwl-sortbtn-wrap{
      grid-column:3/4;
      justify-self:end;
      align-self:center;
    }

    /* ‚úÖ CWL: visual separators */
    .cwl-general-sep{
      border-right: 1px solid var(--sep-strong) !important;
    }
    .cwl-day-start{
      border-left: 1px solid var(--sep-strong) !important;
    
      /* ‚úÖ darker start-of-war column */
      background: rgba(10,10,10,0.78);
    }

    .cwl-day-end{
      border-right: 1px solid var(--sep-strong) !important;
    }

    /* =========================
       FIX: Hide header borders only for the LEFT "general" section in CWL Member Overview
       ========================= */

    /* Remove vertical borders for the first 7 header cells only (Avg Rk..Atk), both header rows */
    .cwl-table.cwl-wide thead tr th:nth-child(-n+8){
      border-left: none !important;
      border-right: none !important;
    }

    /* Hide the horizontal divider between header row 1 & row 2 only on the blank (muted) left cells */
    .cwl-table.cwl-wide thead tr:first-child th.muted{
      border-bottom: none !important;
    }

    /* Ensure war group header borders still show (even with the rule above) */
    .cwl-table.cwl-wide thead tr:first-child th.cwl-warhead{
      border-left: 1px solid rgba(255,255,255,0.10) !important;
      border-right: 1px solid rgba(255,255,255,0.10) !important;
    }

     
    /* =========================
   ‚úÖ CWL ROUNDS (STACKED MATCHUPS)
   ========================= */
    .rounds-stats, .rounds-stat{
      color: rgba(255,255,255,0.92);
    }

    /* You already have <div id="cwl-rounds-mount" class="rounds-wrap"> */
    .rounds-wrap{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    
    /* one round "card" */
    .rounds-round{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      border-radius: 10px;
      overflow: hidden;
    }
    
    /* round header */
    .rounds-round-title{
      text-align:center;
      font-weight: 400;
      font-size: 12px;
      padding:8px 10px;
      background: rgba(255,255,255,0.04);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      letter-spacing:.02em;
      opacity: .90;
    }
    
    /* inside round: list of matchups */
    .rounds-table{
      width:100%;
      display:flex;
      flex-direction:column;
    
      /* ‚úÖ no ‚Äúgap boxes‚Äù look; clean list */
      gap: 0;
      padding: 0;
    
      box-sizing: border-box;
    }

    
    /* one matchup = STACKED block */
    .rounds-match{
      display:flex;
      flex-direction:column;
    
      /* ‚úÖ remove the box completely */
      border: none;
      border-radius: 0;
      overflow: visible;
    
      /* ‚úÖ consistent seating */
      box-sizing: border-box;
    }
    
    /* ‚úÖ horizontal separator between matchups */
    .rounds-match + .rounds-match{
      border-top: 1px solid rgba(255,255,255,0.10);
    }

    
    /* team rows */
    .rounds-side{
      display:flex;
      align-items:center;
      gap:10px;
    
      /* ‚úÖ more breathing room on the right */
      padding:8px 14px;
    
      min-width:0;
    }
    
    /* the "vs" divider row */
    .rounds-mid{
      display:flex;
      justify-content:flex-start; /* ‚úÖ left aligned */
      align-items:center;
    
      padding: 3px 14px;          /* ‚úÖ lines up with team rows */
      line-height: 1;
      font-size: 11px;            /* ‚úÖ hair bigger */
      opacity: .75;
    
      border: none;
      white-space: nowrap;
    }


    
    /* team name */
    .rounds-name{
      flex: 1 1 auto;
      font-weight: 400;
      font-size: 12px;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    
    /* stats cluster on the right */
    .rounds-stats{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
      font-family: monospace;
      font-size: 11px;
      font-variant-numeric: tabular-nums;
      flex: 0 0 auto;
      white-space: nowrap;
    }
    
    .rounds-stat{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-weight: 400;
    }
    
    /* colors */
    .rounds-win{ color: rgba(56, 209, 114, 0.95); font-weight:400; }
    .rounds-lose{ color: rgba(255, 92, 92, 0.92); font-weight:400; }
    .rounds-neutral{ color: rgba(255,255,255,0.92); font-weight:400; }
    
    /* =========================
       ‚úÖ CWL ROUNDS CAROUSEL
       ========================= */
    .rounds-carousel{
      position: relative;
      width: 100%;
    }
    
    /* The horizontal track you can swipe/drag */
    .rounds-track{
      display:flex;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
    
      scroll-snap-type: x mandatory;
      gap: 10px;
    
      /* gutter reserved for arrows */
      padding: 0 var(--rounds-gutter);
    
      /* ‚úÖ makes snap/centering behave at edges */
      scroll-padding-left: var(--rounds-gutter);
      scroll-padding-right: var(--rounds-gutter);
    
      border-radius: 10px;
      box-sizing: border-box;
    }
    
    /* ‚úÖ invisible spacers so first/last slide can truly center */
    .rounds-track::before,
    .rounds-track::after{
      content:"";
      flex: 0 0 var(--rounds-gutter);
    }

    
    /* ‚úÖ slide width fits inside the gutter so borders never clip */
    .rounds-slide{
      flex: 0 0 calc(100% - (var(--rounds-gutter) * 2));
      scroll-snap-align: center;
      box-sizing: border-box;
    }

    
    /* Arrow buttons */
    .rounds-arrow{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      height: 30px;
      border-radius: 999px;
    
      /* ‚úÖ opaque */
      background: #000;
      color: #fff;
      opacity: 1;
    
      border: 1px solid rgba(255,255,255,0.22);
    
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index: 50;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    
    .rounds-arrow:active{ transform: translateY(-50%) scale(0.98); }
    
    .rounds-arrow.left{ left: 3px; }
    .rounds-arrow.right{ right: 3px; }
    
    .rounds-arrow[disabled]{
      display:none;
    }
    /* ‚úÖ dim non-active slides */
    .rounds-slide{
      opacity: 0.35;
      filter: brightness(0.75);
      transition: opacity 60ms ease, filter 60ms ease;
    }
    
    .rounds-slide.is-active{
      opacity: 1;
      filter: none;
    }
    .cwl-league-under-title{
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      opacity: 0.92;
      margin: 4px 0 10px;
    }

    
  </style>

  <script data-goatcounter="https://based.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>

<body>
  <img src="icontransparent.png" alt="B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D icon" class="app-icon" />
  <img src="logo.png" alt="B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D logo" class="logo" onerror="this.style.display='none';" />

  <a class="clan-tag-link"
     href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y"
     target="_blank" rel="noopener noreferrer">#2QQYJC08Y</a>

  <nav class="topnav" id="topNav" aria-label="Top navigation">
    <a href="#/home" data-route="home">Home</a>
    <a href="#/cwl" data-route="cwl">CWL</a>
    <a href="#/war" data-route="war">War</a>
    <a href="#/my-stats" data-route="mystats">My Stats</a>
    <a href="#/more" data-route="more">More</a>
  </nav>

  <div class="stage" id="stage">
    <div id="app" role="main" aria-live="polite"></div>
  </div>

  <nav class="pwa-tabbar" id="pwaTabbar" aria-label="Bottom navigation">
    <div class="tabs">
      <a href="#/home" data-route="home" data-img-key="home"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">Home</span></div></a>
      <a href="#/cwl" data-route="cwl" data-img-key="cwl"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">CWL</span></div></a>
      <a href="#/war" data-route="war" data-img-key="war"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">War</span></div></a>
      <a href="#/my-stats" data-route="mystats" data-img-key="my-stats"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">My Stats</span></div></a>
      <a href="#/more" data-route="more" data-img-key="more"><div class="tab-inner"><span class="icon" aria-hidden="true"><img alt="" /></span><span class="label">More</span></div></a>
    </div>
  </nav>

  <script>
    // ============================================================
    // ‚úÖ REAL "never updates" fix:
    // ============================================================
    (async function purgePwaCachesOnce(){
      const KEY = "based_pwa_cache_purged_v3";
      try{
        if(localStorage.getItem(KEY) === "1") return;

        if("caches" in window){
          try{
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }catch(e){}
        }

        if("serviceWorker" in navigator){
          try{
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all((regs||[]).map(r => r.unregister().catch(()=>{})));
          }catch(e){}
        }

        localStorage.setItem(KEY, "1");
        location.reload();
      }catch(e){}
    })();

    // =========================
    // Core helpers
    // =========================
    function isPwaInstalled(){
      const standaloneDisplay = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const iosStandalone = (typeof navigator !== "undefined") && ("standalone" in navigator) && navigator.standalone;
      return !!(standaloneDisplay || iosStandalone);
    }

    function normalizeRoute(hash){
      const raw = (hash || "").replace(/^#\/?/, "").trim().toLowerCase();
      if(!raw || raw === "index.html") return "home";
      if(raw === "home") return "home";
      if(raw === "cwl") return "cwl";
      if(raw === "war") return "war";
      if(raw === "my-stats" || raw === "mystats") return "mystats";
      if(raw === "more") return "more";
      return "home";
    }

    function setActiveNav(route){
      document.querySelectorAll("[data-route]").forEach(a => {
        a.classList.toggle("active", (a.getAttribute("data-route") || "") === route);
      });
    }

    const ICON_VER = "v1";
    const ICON_FILES = [
      "home-active.png","home-inactive.png",
      "cwl-active.png","cwl-inactive.png",
      "war-active.png","war-inactive.png",
      "my-stats-active.png","my-stats-inactive.png",
      "more-active.png","more-inactive.png"
    ];
    (function preloadTabIcons(){
      ICON_FILES.forEach(src => { const i = new Image(); i.src = `${src}?v=${ICON_VER}`; });
    })();

    function applyPwaImageIconStates(route){
      if(!isPwaInstalled()) return;
      const tabbar = document.getElementById("pwaTabbar");
      if(!tabbar) return;

      tabbar.querySelectorAll("a[data-img-key]").forEach(a => {
        const key = a.getAttribute("data-img-key");
        const img = a.querySelector(".icon img");
        if(!key || !img) return;

        const isActive = (a.getAttribute("data-route") === route);
        const file = isActive ? `${key}-active.png` : `${key}-inactive.png`;

        img.src = `${file}?v=${ICON_VER}`;
        img.loading = "eager";
        img.decoding = "async";
      });
    }

    // =========================
    // PWA tabbar hide-on-scroll
    // =========================
    let _pwaScrollBound = false;
    let _lastScrollY = 0;
    let _rafPending = false;

    function getScrollTop(){
      const se = document.scrollingElement || document.documentElement;
      return (typeof window.scrollY === "number") ? window.scrollY : (se ? se.scrollTop : 0);
    }

    function showPwaTabbar(){
      const tabbar = document.getElementById("pwaTabbar");
      if(tabbar) tabbar.classList.remove("is-hidden");
    }

    function hidePwaTabbar(){
      const tabbar = document.getElementById("pwaTabbar");
      if(tabbar) tabbar.classList.add("is-hidden");
    }

    function bindPwaTabbarAutoHide(){
      if(_pwaScrollBound) return;
      if(!isPwaInstalled()) return;

      const tabbar = document.getElementById("pwaTabbar");
      if(!tabbar || getComputedStyle(tabbar).display === "none") return;

      _pwaScrollBound = true;
      _lastScrollY = getScrollTop();
      showPwaTabbar();

      const onScroll = () => {
        if(_rafPending) return;
        _rafPending = true;

        requestAnimationFrame(() => {
          _rafPending = false;

          const y = getScrollTop();
          const dy = y - _lastScrollY;

          if(Math.abs(dy) < 6){
            _lastScrollY = y;
            return;
          }

          if(y <= 8){
            showPwaTabbar();
            _lastScrollY = y;
            return;
          }

          if(dy > 0) hidePwaTabbar();
          else showPwaTabbar();

          _lastScrollY = y;
        });
      };

      window.__pwaTabbarScrollHandler = onScroll;
      window.addEventListener("scroll", onScroll, { passive:true });
    }

    function unbindPwaTabbarAutoHide(){
      const fn = window.__pwaTabbarScrollHandler;
      if(fn){
        window.removeEventListener("scroll", fn);
        window.__pwaTabbarScrollHandler = null;
      }
      _pwaScrollBound = false;
      _rafPending = false;
    }

    // =========================
    // Drag-to-scroll for any .dragscroll
    // =========================
    function enableDragScroll(el){
      if(!el || el.dataset.dragscroll === "1") return;
      el.dataset.dragscroll = "1";

      let isDown = false;
      let startX = 0;
      let startLeft = 0;
      let moved = false;

      const onDown = (e) => {
        if(e.button !== 0) return;
        isDown = true;
        moved = false;
        startX = e.pageX;
        startLeft = el.scrollLeft;
        el.classList.add("is-dragging");
        e.preventDefault();
      };

      const onMove = (e) => {
        if(!isDown) return;
        const dx = e.pageX - startX;
        if(Math.abs(dx) > 3) moved = true;
        el.scrollLeft = startLeft - dx;
      };

      const onUp = () => {
        if(!isDown) return;
        isDown = false;
        el.classList.remove("is-dragging");
      };

      const onClickCapture = (e) => {
        if(moved){
          e.preventDefault();
          e.stopPropagation();
          moved = false;
        }
      };

      el.addEventListener("mousedown", onDown);
      window.addEventListener("mousemove", onMove);
      window.addEventListener("mouseup", onUp);
      el.addEventListener("mouseleave", onUp);
      el.addEventListener("click", onClickCapture, true);
    }

    function enableDragScrollEverywhere(){
      document.querySelectorAll(".dragscroll").forEach(enableDragScroll);
    }

    function setScrollHintIfScrollable(wrapId, hintId){
      const wrap = document.getElementById(wrapId);
      const hint = document.getElementById(hintId);
      if(!wrap || !hint) return;
    
      const isScrollable = wrap.scrollWidth > (wrap.clientWidth + 2);
      hint.style.display = isScrollable ? "flex" : "none";
    }

    function setupNavUI(){
      const pwa = isPwaInstalled();
      const topNav = document.getElementById("topNav");
      const tabbar = document.getElementById("pwaTabbar");

      if(pwa){
        if(topNav) topNav.style.display = "none";
        if(tabbar) tabbar.style.display = "block";
        document.body.classList.add("has-pwa-tabs");

        unbindPwaTabbarAutoHide();
        bindPwaTabbarAutoHide();
      } else {
        if(topNav) topNav.style.display = "flex";
        if(tabbar) tabbar.style.display = "none";
        document.body.classList.remove("has-pwa-tabs");
        unbindPwaTabbarAutoHide();
      }
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function setText(id, text){ const el = document.getElementById(id); if(el) el.textContent = text; }
    function setTextAny(ids, text){
      for(const id of ids){
        const el = document.getElementById(id);
        if(el){ el.textContent = text; return true; }
      }
      return false;
    }

    // =========================
    // Templates
    // =========================
    const app = document.getElementById("app");

    function pageShellCards(title, subtitle){
      return `<div class="cards"><main class="page"><h1>${title}</h1><p>${subtitle}</p></main></div>`;
    }

    function renderMore(){
      return `
        <div class="cards">
          <h2 class="cards-title">In-Game Events</h2>

          <div class="row"><span class="row-label">Raid Weekend</span><span id="raid-timer" class="row-value">‚Äî</span></div>
          <div class="row"><span class="row-label">Clan Games</span><span id="clan-games-timer" class="row-value">‚Äî</span></div>
          <div class="row"><span class="row-label">Season End</span><span id="season-end-timer" class="row-value">‚Äî</span></div>
          <div class="row"><span class="row-label">League Reset</span><span id="league-reset-timer" class="row-value">‚Äî</span></div>

          <div class="divider"></div>

          <div class="links">
            <a class="link-btn" href="changelog.html" target="_blank" rel="noopener noreferrer">Changelog</a>
            <a class="link-btn" href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQJyBeqDwShAcLD0GMnIvNehs8P9eG3ApO6pltrMHe01bZVJn0k3bIxLobnjBpvqEQNDe_sFcRkZPE8/pubhtml" target="_blank" rel="noopener noreferrer">CWL Leaderboards</a>
            <a class="link-btn" href="https://discord.gg/8P96687dPr" target="_blank" rel="noopener noreferrer">Clan Discord</a>
            <a class="link-btn" href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y" target="_blank" rel="noopener noreferrer">Visit B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D</a>
            <a class="link-btn" href="https://www.clashofstats.com/clans/based-2QQYJC08Y/summary" target="_blank" rel="noopener noreferrer">Clan Stats</a>
            <a class="link-btn" href="https://store.supercell.com/" target="_blank" rel="noopener noreferrer">SuperCell Store</a>
            <a class="link-btn install-btn" href="https://www.youtube.com/watch?v=gIC30U39zpA" target="_blank" rel="noopener noreferrer">How to install B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D App</a>
          </div>

          <div class="page-footer">EST DECEMBER 2023</div>
        </div>
      `;
    }

    function renderHome(){
      return `
        <div class="cards">
          <h2 class="cards-title">Clan Overview</h2>

          <div id="rankings-block">
            <div class="section-title">Rankings</div>
            <div class="row"><span class="row-label">Global Trophies</span><span id="rank-global-trophies" class="row-value">Loading‚Ä¶</span></div>
            <div class="row"><span class="row-label">USA Trophies</span><span id="rank-usa-trophies" class="row-value">Loading‚Ä¶</span></div>
            <div class="divider"></div>
          </div>

          <div id="clan-desc" class="clan-desc-block">Loading‚Ä¶</div>
          <div class="divider"></div>

          <div class="row"><span class="row-label">CWL League</span><span id="cwl-league" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Last CWL Finish</span><span id="cwl-finish" class="row-value">Loading‚Ä¶</span></div>

          <div class="row"><span class="row-label">War Record</span><span id="home-war-record" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Last 10 Wars</span><span id="home-war-last10" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Current Streak</span><span id="home-war-streak" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Longest Streak</span><span id="home-war-longest" class="row-value">Loading‚Ä¶</span></div>

          <div class="row"><span class="row-label">Capital Hall Level</span><span id="capital-hall-level" class="row-value">Loading‚Ä¶</span></div>

          <div class="divider"></div>

          <h2 class="cards-title" style="margin: 2px 0 10px;">Members</h2>

          <div class="members-headerbar" aria-label="Members header controls">
            <div class="members-leaderline">
              <div class="members-keyline">
                <span class="key-emoji">&nbsp;&nbsp;üëë</span>
                <span class="key-text"><span class="legend-underline">Leader</span> / Co</span>
              </div>
            </div>

            <div class="members-elderline">
              <div class="members-keyline">
                <span class="key-emoji">&nbsp;&nbsp;üõ°Ô∏è</span>
                <span class="key-text">Elder</span>
              </div>
            </div>

            <div class="members-scroll-inline">‚Üê SCROLL ‚Üí</div>

            <div class="members-sortbtn-wrap">
              <div class="sort-btn">
                SORT
                <select id="membersSortSelect" aria-label="Sort members">
                  <option value="role">Role</option>
                  <option value="th">TH</option>
                  <option value="trophies">Trophies</option>
                  <option value="warStars">War Stars</option>
                  <option value="xp">XP</option>
                  <option value="donated">Donated</option>
                  <option value="received">Received</option>
                </select>
              </div>
            </div>
          </div>

          <div class="members-wrap dragscroll" aria-label="Clan members list">
            <table class="members-table">
              <colgroup>
                <col style="width: var(--m-emoji-col);">
                <col style="width: var(--m-name-col);">
                <col style="width: 44px;">
                <col style="width: 84px;">
                <col style="width: 98px;">
                <col style="width: 58px;">
                <col style="width: 86px;">
                <col style="width: 96px;">
              </colgroup>

              <thead>
                <tr>
                  <th class="m-emoji" style="text-align:right;"></th>
                  <th style="text-align:left;"></th>
                  <th class="m-num">TH</th>
                  <th class="m-num">Trophies</th>
                  <th class="m-num">War Stars</th>
                  <th class="m-num">XP</th>
                  <th class="m-num">Donated</th>
                  <th class="m-num">Received</th>
                </tr>
              </thead>

              <tbody id="members-body">
                <tr><td colspan="8" style="opacity:.75;">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <div id="clan-fetch-status" class="tiny-status">Clan stats fetch: ‚Äî</div>
          <div id="members-fetch-status" class="tiny-status">Members fetch: ‚Äî</div>
        </div>
      `;
    }

    function renderCwlPage(){
      return `
        <div class="cards">
          <div class="cwl-titlebar">
            <div class="cwl-title-dd" aria-label="Select CWL season">
              <span id="cwl-title-text">CWL</span>
              <span class="caret" aria-hidden="true">‚ñº</span>
          
              <select id="cwlSeasonSelect" aria-label="Select CWL season">
                <option value="current">Current</option>
              </select>
            </div>
          </div>
          
          <div id="cwl-league-name" class="cwl-league-under-title">Loading‚Ä¶</div>

          <div class="divider"></div>

          <div class="section-title">League Overview</div>

          <!-- ‚úÖ only shown when the table is actually scrollable -->
          <div class="cwl-subheaderbar" style="margin:0 0 8px;" aria-label="CWL league overview header">
            <div></div>
            <div class="cwl-scroll-inline" id="cwl-league-scroll-inline">‚Üê SCROLL ‚Üí</div>
            <div></div>
          </div>
          
          <div class="cwl-table-wrap dragscroll" id="cwl-league-wrap" aria-label="CWL league overview">

            <table class="cwl-table cwl-league">
            <colgroup>
              <col style="width:52px;">    <!-- Rank -->
              <col style="width:96px;">    <!-- Clan (was 240px) -->
              <col style="width:64px;">    <!-- Wins -->
              <col style="width:60px;">    <!-- total stars -->
              <col style="width:52px;">    <!-- % (total) -->
              <col style="width:78px;">    <!-- AVG ‚≠ê -->
              <col style="width:66px;">    <!-- AVG % (NEW) -->
              <col style="width:84px;">    <!-- AVG üõ°Ô∏è -->
            </colgroup>


              <thead>
                <tr>
                  <th class="sticky-1">Rank</th>
                  <th class="sticky-2 left">Clan</th>
                  <th>Wins</th>
                  <th>‚≠ê</th>
                  <th>%</th>
                  <th>AVG ‚≠ê</th>
                  <th>AVG %</th>
                  <th>AVG üõ°Ô∏è</th>
                </tr>
              </thead>

              <tbody id="cwl-leagueoverview-body">
                <tr><td colspan="8" style="opacity:.75; text-align:center; padding:12px;">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="section-title">Rounds</div>
          
          <div id="cwl-rounds-mount" class="rounds-wrap" aria-label="CWL rounds overview">
            <div style="opacity:.75; text-align:center; padding:12px;">Loading‚Ä¶</div>
          </div>                  
                    
          <div class="divider"></div>

          <div class="section-title">Member Overview</div>

          <!-- ‚úÖ perfectly centered SCROLL + sort -->
          <div class="cwl-subheaderbar" aria-label="CWL member overview header">
            <div></div>
            <div class="cwl-scroll-inline">‚Üê SCROLL ‚Üí</div>
            <div class="cwl-sortbtn-wrap">
              <div class="sort-btn">
                SORT
                <select id="cwlMembersSortSelect" aria-label="Sort CWL members">
                  <option value="rank">Rank</option>
                  <option value="totalStars">Total Stars</option>
                  <option value="totalPct">Total %</option>
                  <option value="avgStars">AVG Stars</option>
                  <option value="avgPct">Avg %</option>
                </select>
              </div>
            </div>
          </div>

          <div class="cwl-table-wrap dragscroll" aria-label="CWL member overview">
            <table class="cwl-table cwl-wide">
              <colgroup>
                <!-- üó°Ô∏è RK / üõ°Ô∏è RK should be as tight as possible -->
                <col style="width:54px;">  <!-- üó°Ô∏è RK -->
                <col style="width:54px;">  <!-- üõ°Ô∏è RK -->
                <col style="width:88px;">  <!-- Name -->
              
                <col style="width:86px;">
                <col style="width:110px;">
                <col style="width:92px;">
                <col style="width:92px;">
                <col style="width:96px;">
              
                <!-- War cols: Opp widest, Stars tight, % medium -->
                <col style="width:120px;"><col style="width:36px;"><col style="width:58px;">
                <col style="width:120px;"><col style="width:36px;"><col style="width:58px;">
                <col style="width:120px;"><col style="width:36px;"><col style="width:58px;">
                <col style="width:120px;"><col style="width:36px;"><col style="width:58px;">
                <col style="width:120px;"><col style="width:36px;"><col style="width:58px;">
                <col style="width:120px;"><col style="width:36px;"><col style="width:58px;">
                <col style="width:120px;"><col style="width:36px;"><col style="width:58px;">
              </colgroup>


            <thead id="cwl-members-head">
              <!-- Row 1: keep War group headers, but make the left side visually "blank" -->
              <tr>
                <th class="sticky-1 muted">&nbsp;</th>
                <th class="sticky-2 muted">&nbsp;</th>
                <th class="sticky-3 muted">&nbsp;</th>
            
                <th class="muted">&nbsp;</th>
                <th class="muted">&nbsp;</th>
                <th class="muted">&nbsp;</th>
                <th class="muted">&nbsp;</th>
                <th class="muted cwl-general-sep">&nbsp;</th>
            
                <th class="cwl-warhead" colspan="3">War 1</th>
                <th class="cwl-warhead" colspan="3">War 2</th>
                <th class="cwl-warhead" colspan="3">War 3</th>
                <th class="cwl-warhead" colspan="3">War 4</th>
                <th class="cwl-warhead" colspan="3">War 5</th>
                <th class="cwl-warhead" colspan="3">War 6</th>
                <th class="cwl-warhead" colspan="3">War 7</th>
              </tr>
            
              <!-- Row 2: ALL column headers live here -->
              <tr>
                <th class="sticky-1">üó°Ô∏èRK</th>
                <th class="sticky-2">üõ°Ô∏èRK</th>
                <th class="sticky-3">&nbsp;</th>
            
                <th>Total‚òÖ</th>
                <th>Total%</th>
                <th>Avg‚òÖ</th>
                <th>Avg%</th>
                <th class="cwl-general-sep">Atk</th>
            
                <!-- War subheaders: ‚öîÔ∏è / ‚≠ê / üéØ -->
                <th class="left cwl-warcell cwl-day-start"><span class="cwl-war-sword">‚öîÔ∏è</span><span class="cwl-war-oppname" id="cwl-war-oppname-1"></span></th><th class="cwl-warcell">‚≠ê</th><th class="cwl-warcell cwl-day-end">üéØ</th>
                <th class="left cwl-warcell cwl-day-start"><span class="cwl-war-sword">‚öîÔ∏è</span><span class="cwl-war-oppname" id="cwl-war-oppname-2"></span></th><th class="cwl-warcell">‚≠ê</th><th class="cwl-warcell cwl-day-end">üéØ</th>
                <th class="left cwl-warcell cwl-day-start"><span class="cwl-war-sword">‚öîÔ∏è</span><span class="cwl-war-oppname" id="cwl-war-oppname-3"></span></th><th class="cwl-warcell">‚≠ê</th><th class="cwl-warcell cwl-day-end">üéØ</th>
                <th class="left cwl-warcell cwl-day-start"><span class="cwl-war-sword">‚öîÔ∏è</span><span class="cwl-war-oppname" id="cwl-war-oppname-4"></span></th><th class="cwl-warcell">‚≠ê</th><th class="cwl-warcell cwl-day-end">üéØ</th>
                <th class="left cwl-warcell cwl-day-start"><span class="cwl-war-sword">‚öîÔ∏è</span><span class="cwl-war-oppname" id="cwl-war-oppname-5"></span></th><th class="cwl-warcell">‚≠ê</th><th class="cwl-warcell cwl-day-end">üéØ</th>
                <th class="left cwl-warcell cwl-day-start"><span class="cwl-war-sword">‚öîÔ∏è</span><span class="cwl-war-oppname" id="cwl-war-oppname-6"></span></th><th class="cwl-warcell">‚≠ê</th><th class="cwl-warcell cwl-day-end">üéØ</th>
                <th class="left cwl-warcell cwl-day-start"><span class="cwl-war-sword">‚öîÔ∏è</span><span class="cwl-war-oppname" id="cwl-war-oppname-7"></span></th><th class="cwl-warcell">‚≠ê</th><th class="cwl-warcell cwl-day-end">üéØ</th>
              </tr>
            </thead>


              <tbody id="cwl-memberoverview-body">
                <tr><td colspan="28" style="opacity:.75; text-align:center; padding:12px;">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <div id="cwl-fetch-status" class="tiny-status">CWL fetch: ‚Äî</div>
          <div id="cwl-index-status" class="tiny-status">CWL index fetch: ‚Äî</div>
          <div id="clan-fetch-status-cwl" class="tiny-status">Clan stats fetch: ‚Äî</div>
        </div>
      `;
    }

    function renderWarPage(){
      return `
        <div class="cards">
          <h2 class="cards-title">War</h2>

          <div class="row"><span class="row-label">War Record</span><span id="war-record" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Last 10 Wars</span><span id="war-last10" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Last 25 Wars</span><span id="war-last25" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Last 50 Wars</span><span id="war-last50" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Current Streak</span><span id="war-streak" class="row-value">Loading‚Ä¶</span></div>
          <div class="row"><span class="row-label">Longest Streak</span><span id="war-longest" class="row-value">Loading‚Ä¶</span></div>

          <div class="divider"></div>

          <h2 class="cards-title" style="margin-top:6px;">Current War</h2>
          <div id="war-size" class="war-mode-title" style="margin:6px 0 6px;">‚Äî</div>

          <div class="war-board">
            <div id="war-stage-label" class="war-mode-title" style="margin: 8px 0 4px;">Loading‚Ä¶</div>
            <div id="war-timer" class="war-timer">‚Äî</div>

            <div class="war-grid-3">
              <div>
                <div id="war-name-us" class="war-name">‚Äî</div>
                <div class="war-stat"><span id="war-stars-us">‚Äî</span> <span>‚≠ê</span></div>
                <div class="war-substat"><span id="war-destr-us">‚Äî</span> <span>üéØ</span></div>
                <div class="war-substat"><span id="war-attacks-us">‚Äî</span> <span>‚öîÔ∏è</span></div>
              </div>

              <div id="war-vs" class="war-vs">VS</div>

              <div>
                <div id="war-name-opp" class="war-name">‚Äî</div>
                <div class="war-stat"><span id="war-stars-opp">‚Äî</span> <span>‚≠ê</span></div>
                <div class="war-substat"><span id="war-destr-opp">‚Äî</span> <span>üéØ</span></div>
                <div class="war-substat"><span id="war-attacks-opp">‚Äî</span> <span>‚öîÔ∏è</span></div>
              </div>
            </div>

            <div id="war-fetch-status" class="tiny-status">Last fetch: ‚Äî</div>
            <div id="clan-fetch-status-war" class="tiny-status">Clan stats fetch: ‚Äî</div>
          </div>

          <div class="war-chart-wrap dragscroll">
            <div id="war-chart-mount"></div>
            <div id="war-chart-status" class="tiny-status">Chart fetch: ‚Äî</div>
          </div>
        </div>
      `;
    }

    function renderRouteContent(route){
      if(route === "home") return renderHome();
      if(route === "cwl") return renderCwlPage();
      if(route === "war") return renderWarPage();
      if(route === "mystats") return pageShellCards("My Stats", "Coming Soon!");
      if(route === "more") return renderMore();
      return renderHome();
    }

    // =========================
    // Data endpoints
    // =========================
    const RAW_WAR_URL_BASE        = "./war.json";
    const RAW_WAR_DETAIL_URL_BASE = "./war_detail.json";
    const RAW_CLAN_URL_BASE       = "./clan_stats.json";
    const RAW_MEMBERS_URL_BASE    = "./members.json";

    // CWL endpoints
    const RAW_CWL_CURRENT_URL_BASE = "./cwl_current.json";
    const RAW_CWL_INDEX_URL_BASE   = "./cwl_index.json";

    // Fallbacks
    const RAW_FALLBACK_BASE = "https://raw.githubusercontent.com/cocbased/based/main/";
    const RAW_WAR_FALLBACK         = RAW_FALLBACK_BASE + "war.json";
    const RAW_WAR_DETAIL_FALLBACK  = RAW_FALLBACK_BASE + "war_detail.json";
    const RAW_CLAN_FALLBACK        = RAW_FALLBACK_BASE + "clan_stats.json";
    const RAW_MEMBERS_FALLBACK     = RAW_FALLBACK_BASE + "members.json";
    const RAW_CWL_CURRENT_FALLBACK = RAW_FALLBACK_BASE + "cwl_current.json";
    const RAW_CWL_INDEX_FALLBACK   = RAW_FALLBACK_BASE + "cwl_index.json";

    // =========================
    // State + intervals
    // =========================
    let homeIntervals = [];
    let warIntervals  = [];
    let moreIntervals = [];
    let cwlIntervals  = [];
    function clearIntervals(arr){ arr.forEach(id => clearInterval(id)); arr.length = 0; }

    let warData = null;
    let warFetched = false;

    let warDetail = null;
    let warDetailFetched = false;

    const LAST_WAR_STORAGE_KEY = "based_last_war_snapshot";
    let lastWarSnapshot = null;

    let clanStats = null;
    let membersData = null;
    let membersSortMode = "role";

    // CWL state
    const CWL_SELECTED_KEY = "based_cwl_selected_season";
    let cwlIndex = null;
    let cwlCurrent = null;
    let cwlSelected = (localStorage.getItem(CWL_SELECTED_KEY) || "current");
    let cwlSelectedPayload = null;

    // ‚úÖ CWL Member Overview sort state (default: Rank ascending)
    let cwlMembersSortMode = "rank";

    // ‚úÖ Rounds carousel: preserve slide while data refreshes
    let cwlRoundsSavedIndex = null;     // what slide user is viewing (0-based)
    let cwlRoundsDidInitThisVisit = false; // only auto-jump on first mount per CWL visit
    let cwlRoundsRenderHash = null; // ‚úÖ prevents carousel flicker + scroll jumps
    
    // =========================
    // Utilities
    // =========================
    function pad(n){ return String(n).padStart(2,"0"); }
    function formatCountdown(ms){
      if(ms <= 0) return "0d 00h 00m 00s";
      const totalSeconds = Math.floor(ms/1000);
      const days = Math.floor(totalSeconds/86400);
      const hours = Math.floor((totalSeconds%86400)/3600);
      const minutes = Math.floor((totalSeconds%86400%3600)/60);
      const seconds = totalSeconds%60;
      return days+"d "+pad(hours)+"h "+pad(minutes)+"m "+pad(seconds)+"s";
    }

    function loadLastWarSnapshot(){
      try{
        const raw = localStorage.getItem(LAST_WAR_STORAGE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object" && obj.state && obj.state !== "notInWar") return obj;
      } catch(e){}
      return null;
    }
    function saveLastWarSnapshot(w){
      try{ localStorage.setItem(LAST_WAR_STORAGE_KEY, JSON.stringify(w)); } catch(e){}
    }
    lastWarSnapshot = loadLastWarSnapshot();

    function winPctFromWLT(w,l,t){
      const W=(w|0), L=(l|0), T=(t|0);
      const total=W+L+T;
      if(total<=0) return null;
      return (W + 0.5*T)/total;
    }
    function fmtPctDecimal(p){
      if(typeof p !== "number" || !isFinite(p)) return "";
      return ` (${p.toFixed(3)})`;
    }
    function fmtWLTWithPctNums(w,l,t){
      const pct=winPctFromWLT(w,l,t);
      return { text:`${w}-${l}-${t}${fmtPctDecimal(pct)}`, losses:(l|0) };
    }
    function fmtWLTWithPctObj(obj){
      if(!obj || typeof obj !== "object") return { text:"‚Äî", losses:null };
      const w=(typeof obj.wins==="number")?obj.wins:null;
      const l=(typeof obj.losses==="number")?obj.losses:null;
      const t=(typeof obj.ties==="number")?obj.ties:null;
      if(w===null||l===null||t===null) return { text:"‚Äî", losses:null };
      const pct=winPctFromWLT(w,l,t);
      return { text:`${w}-${l}-${t}${fmtPctDecimal(pct)}`, losses:l };
    }
    function hasNoLosses(losses){
      return typeof losses==="number" && isFinite(losses) && losses===0;
    }
    function setClass(id, className, on){
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle(className, !!on);
    }

    function roleEmoji(role){
      const r = String(role || "").toLowerCase();
      if(r.includes("leader")) return "üëë";
      if(r === "elder") return "üõ°Ô∏è";
      return "";
    }
    function isLeaderOnly(role){
      return String(role || "").trim().toLowerCase() === "leader";
    }

    // =========================
    // TIME PARSING (ISO + CoC formats)
    // =========================
    function parseWarTime(val){
      if(!val) return null;
      if(val instanceof Date) return isNaN(val.getTime()) ? null : val;

      const s = String(val).trim();
      if(!s) return null;

      const dIso = new Date(s);
      if(!isNaN(dIso.getTime())) return dIso;

      const m = s.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(?:\.(\d{3}))?Z$/);
      if(m){
        const [,Y,MO,DA,HH,MI,SS,MS] = m;
        const ms = MS ? +MS : 0;
        const d = new Date(Date.UTC(+Y, +MO-1, +DA, +HH, +MI, +SS, ms));
        return isNaN(d.getTime()) ? null : d;
      }
      return null;
    }

    function getWarTimes(display){
      const start =
        parseWarTime(display?.startTimeIso) ||
        parseWarTime(display?.startTime) ||
        parseWarTime(display?.start) ||
        parseWarTime(warDetail?.startTimeIso) ||
        parseWarTime(warDetail?.startTime) ||
        null;

      const end =
        parseWarTime(display?.endTimeIso) ||
        parseWarTime(display?.endTime) ||
        parseWarTime(display?.end) ||
        parseWarTime(warDetail?.endTimeIso) ||
        parseWarTime(warDetail?.endTime) ||
        null;

      return { start, end };
    }

    function stampTime(){
      const d = new Date();
      return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
    }

    // =========================
    // Robust JSON fetch + meta diagnostics
    // =========================
    const endpointState = new Map(); // key => { lastHash, unchangedStreak }

    function fnv1a32(str){
      let h = 0x811c9dc5;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
      }
      return h >>> 0;
    }

    async function fetchJsonWithMeta(url, stateKey){
      const key = stateKey || url;
      const cb = Date.now();
      const rnd = Math.random().toString(16).slice(2);
      const busted = `${url}${url.includes("?") ? "&" : "?"}cb=${cb}&r=${rnd}`;

      const started = performance.now();
      const res = await fetch(busted, {
        cache: "no-store",
        headers: {
          "Cache-Control": "no-cache, no-store, must-revalidate",
          "Pragma": "no-cache"
        }
      });

      const text = await res.text();
      if(!res.ok) throw new Error(`${url} HTTP ${res.status}`);

      const hash = fnv1a32(text).toString(16).padStart(8,"0");
      const bytes = text.length;

      const st = endpointState.get(key) || { lastHash:null, unchangedStreak:0 };
      const unchanged = (st.lastHash === hash);
      st.unchangedStreak = unchanged ? (st.unchangedStreak + 1) : 0;
      st.lastHash = hash;
      endpointState.set(key, st);

      let data;
      try{
        data = JSON.parse(text);
      }catch(e){
        throw new Error(`${url} JSON parse error`);
      }

      const ms = Math.round(performance.now() - started);
      const meta = {
        ok: true,
        url: busted,
        hash,
        bytes,
        ms,
        unchanged,
        unchangedStreak: st.unchangedStreak,
        lastModified: res.headers.get("Last-Modified") || "",
        etag: res.headers.get("ETag") || ""
      };
      return { data, meta };
    }

    async function fetchJsonSmart(pagesUrl, rawFallbackUrl, stateKey){
      const primary = await fetchJsonWithMeta(pagesUrl, stateKey || pagesUrl);

      if(rawFallbackUrl){
        const st = endpointState.get(stateKey || pagesUrl);
        const shouldTryFallback = primary.meta.unchanged && st && st.unchangedStreak >= 3;

        if(shouldTryFallback){
          try{
            const fb = await fetchJsonWithMeta(rawFallbackUrl, (stateKey || pagesUrl) + "::raw");
            if(fb.meta.hash !== primary.meta.hash){
              fb.meta.via = "raw";
              return fb;
            }
          }catch(e){}
        }
      }

      primary.meta.via = "pages";
      return primary;
    }

    function formatMetaLine(label, meta){
      if(!meta) return `${label}: ${stampTime()} ‚ùå`;
      const changedTxt = meta.unchanged ? "UNCHANGED" : "CHANGED";
      const lm = meta.lastModified ? ` ¬∑ LM ${meta.lastModified}` : "";
      const via = meta.via ? ` ¬∑ ${meta.via.toUpperCase()}` : "";
      return `${label}: ${stampTime()} ‚úÖ ${changedTxt} ¬∑ ${meta.bytes}B ¬∑ #${meta.hash}${via}${lm}`;
    }

    // =========================
    // Fetchers
    // =========================
    async function fetchWarData(){
      try{
        const { data, meta } = await fetchJsonSmart(RAW_WAR_URL_BASE, RAW_WAR_FALLBACK, "war.json");
        warData = data;

        if(warData && warData.state && warData.state !== "notInWar"){
          lastWarSnapshot = warData;
          saveLastWarSnapshot(warData);
        }

        setText("war-fetch-status", formatMetaLine("Last fetch", meta));
      } catch(e){
        warData = null;
        setText("war-fetch-status", `Last fetch: ${stampTime()} ‚ùå ${String(e.message || e)}`);
      }
      warFetched = true;
      renderWarSection();
    }

    async function fetchWarDetail(){
      try{
        const { data, meta } = await fetchJsonSmart(RAW_WAR_DETAIL_URL_BASE, RAW_WAR_DETAIL_FALLBACK, "war_detail.json");
        warDetail = data;
        setText("war-chart-status", formatMetaLine("Chart fetch", meta));
      } catch(e){
        warDetail = null;
        setText("war-chart-status", `Chart fetch: ${stampTime()} ‚ùå ${String(e.message || e)}`);
      }
      warDetailFetched = true;
      renderWarSection();
      renderWarChart();
    }

    // =========================
    // More tolerant schema helpers
    // =========================
    function pick(obj, keys){
      for(const k of keys){
        const v = obj?.[k];
        if(v !== undefined && v !== null && v !== "") return v;
      }
      return null;
    }
    function pickObj(obj, keys){
      const v = pick(obj, keys);
      return (v && typeof v === "object") ? v : null;
    }
    function pickNum(obj, keys){
      const v = pick(obj, keys);
      const n = (typeof v === "number") ? v : Number(v);
      return isFinite(n) ? n : null;
    }

    function normalizeClanStats(raw){
      if(!raw || typeof raw !== "object") return null;

      const description = pick(raw, ["description","desc","clanDescription","about"]) || "";

      const cwl = pickObj(raw, ["cwl","CWL","cwlInfo","cwl_info"]) || {};
      const cwlLeague =
        pick(cwl, ["currentLeague","league","name"]) ||
        pick(raw, ["cwlLeague","cwl_league","cwlLeagueName"]) ||
        "‚Äî";

      const cwlFinish =
        pick(cwl, ["lastFinish","finish","last_finish"]) ||
        pick(raw, ["cwlFinish","cwl_finish","lastCwlFinish"]) ||
        "‚Äî";

      const capital = pickObj(raw, ["clanCapital","capital","clan_capital"]) || {};
      const capitalHallLevel =
        pickNum(capital, ["capitalHallLevel","hallLevel","capital_hall_level"]) ??
        pickNum(raw, ["capitalHallLevel","capitalHall","capital_hall_level"]);

      const war =
        pickObj(raw, ["war","warStats","war_stats","warRecord","war_record"]) || {};

      const wins   = pickNum(war, ["wins"])   ?? pickNum(raw, ["warWins","wins","war_wins"]) ?? 0;
      const losses = pickNum(war, ["losses"]) ?? pickNum(raw, ["warLosses","losses","war_losses"]) ?? 0;
      const ties   = pickNum(war, ["ties"])   ?? pickNum(raw, ["warTies","ties","war_ties"]) ?? 0;

      const currentStreak =
        pickNum(war, ["currentStreak","streak","current_streak"]) ??
        pickNum(raw, ["currentStreak","current_streak","warStreak"]);

      const longestStreak =
        pickNum(war, ["longestStreak","bestStreak","longest_streak"]) ??
        pickNum(raw, ["longestStreak","longest_streak","bestWarStreak"]);

      const last10  = pickObj(war, ["last10","last_10","lastTen"])  || pickObj(raw, ["last10","last_10","lastTen"]);
      const last25  = pickObj(war, ["last25","last_25"])            || pickObj(raw, ["last25","last_25"]);
      const last50  = pickObj(war, ["last50","last_50"])            || pickObj(raw, ["last50","last_50"]);

      return {
        description,
        cwl: { currentLeague: cwlLeague, lastFinish: cwlFinish },
        clanCapital: { capitalHallLevel: (typeof capitalHallLevel === "number" ? capitalHallLevel : null) },
        war: {
          wins, losses, ties,
          currentStreak: (typeof currentStreak === "number" ? currentStreak : null),
          longestStreak: (typeof longestStreak === "number" ? longestStreak : null),
          last10, last25, last50
        },
        __raw: raw
      };
    }

    async function fetchMembersData(){
      try{
        const { data, meta } = await fetchJsonSmart(RAW_MEMBERS_URL_BASE, RAW_MEMBERS_FALLBACK, "members.json");
        membersData = data;
        setTextAny(["members-fetch-status"], formatMetaLine("Members fetch", meta));
      } catch(e){
        membersData = null;
        setTextAny(["members-fetch-status"], `Members fetch: ${stampTime()} ‚ùå ${String(e.message || e)}`);
      }
      renderMembers();
    }

    async function fetchClanStats(){
      try{
        const { data, meta } = await fetchJsonSmart(RAW_CLAN_URL_BASE, RAW_CLAN_FALLBACK, "clan_stats.json");
        clanStats = normalizeClanStats(data) || null;

        const line = formatMetaLine("Clan stats fetch", meta);
        setTextAny(["clan-fetch-status","clan-fetch-status-war","clan-fetch-status-cwl"], line);
      } catch(e){
        clanStats = null;
        const line = `Clan stats fetch: ${stampTime()} ‚ùå ${String(e.message || e)}`;
        setTextAny(["clan-fetch-status","clan-fetch-status-war","clan-fetch-status-cwl"], line);
      }
      renderClanStats();
    }

    // =========================
    // CWL fetchers
    // =========================
    async function fetchCwlIndex(){
      try{
        const { data, meta } = await fetchJsonSmart(RAW_CWL_INDEX_URL_BASE, RAW_CWL_INDEX_FALLBACK, "cwl_index.json");
        cwlIndex = data;
        setText("cwl-index-status", formatMetaLine("CWL index fetch", meta));
      }catch(e){
        cwlIndex = null;
        setText("cwl-index-status", `CWL index fetch: ${stampTime()} ‚ùå ${String(e.message || e)}`);
      }
      renderCwlSeasonSelect();
    }

    async function fetchCwlCurrent(){
      try{
        const { data, meta } = await fetchJsonSmart(RAW_CWL_CURRENT_URL_BASE, RAW_CWL_CURRENT_FALLBACK, "cwl_current.json");
        cwlCurrent = data;
        setText("cwl-fetch-status", formatMetaLine("CWL fetch", meta));
      }catch(e){
        cwlCurrent = null;
        setText("cwl-fetch-status", `CWL fetch: ${stampTime()} ‚ùå ${String(e.message || e)}`);
      }

      if(cwlSelected === "current"){
        cwlSelectedPayload = cwlCurrent;
        renderCwlContent();
      } else {
        renderCwlSeasonSelect();
      }
    }

    async function fetchCwlHistory(seasonKey){
      if(!seasonKey || seasonKey === "current") return;

      const pagesUrl = `./cwl_history/${encodeURIComponent(seasonKey)}.json`;
      const rawUrl   = `${RAW_FALLBACK_BASE}cwl_history/${encodeURIComponent(seasonKey)}.json`;

      try{
        const { data, meta } = await fetchJsonSmart(pagesUrl, rawUrl, `cwl_history:${seasonKey}`);
        cwlSelectedPayload = data;
        setText("cwl-fetch-status", formatMetaLine("CWL fetch", meta));
      }catch(e){
        cwlSelectedPayload = null;
        setText("cwl-fetch-status", `CWL fetch: ${stampTime()} ‚ùå ${String(e.message || e)}`);
      }
      renderCwlContent();
    }

    // =========================
    // Render: Current War section
    // =========================
    function renderWarSection(){
      if(!document.getElementById("war-timer")) return;

      let display = warData;
      if(display && display.state === "notInWar" && lastWarSnapshot) display = lastWarSnapshot;

      const stateRaw = String(display?.state || warDetail?.state || "");
      const state = stateRaw.trim().toLowerCase();

      const teamSize =
        Number(display?.teamSize || display?.size || 0) ||
        Number(warDetail?.teamSize || 0) ||
        null;
      setText("war-size", teamSize ? `${teamSize} v ${teamSize}` : "‚Äî");

      if(state === "notinwar" || stateRaw === "notInWar"){
        setText("war-stage-label","No War");
        setText("war-timer","");
        setText("war-name-us","‚Äî"); setText("war-name-opp","‚Äî");
        setText("war-stars-us","‚Äî"); setText("war-stars-opp","‚Äî");
        setText("war-destr-us","‚Äî"); setText("war-destr-opp","‚Äî");
        setText("war-attacks-us","‚Äî"); setText("war-attacks-opp","‚Äî");
        return;
      }

      const maxStars = teamSize ? (3 * teamSize) : null;
      const maxAttacks = teamSize ? (2 * teamSize) : null;

      const ourName = display?.ourName || warDetail?.clan?.name || warDetail?.our?.name || "US";
      const oppName = display?.oppName || warDetail?.opponent?.name || "OPPONENT";
      setText("war-name-us", ourName);
      setText("war-name-opp", oppName);

      const ourStars = (display?.ourStars ?? warDetail?.clan?.stars ?? warDetail?.our?.stars ?? null);
      const oppStars = (display?.oppStars ?? warDetail?.opponent?.stars ?? null);

      setText("war-stars-us", (ourStars == null) ? "‚Äî" : (maxStars ? `${ourStars}/${maxStars}` : String(ourStars)));
      setText("war-stars-opp",(oppStars == null) ? "‚Äî" : (maxStars ? `${oppStars}/${maxStars}` : String(oppStars)));

      const ourDes = (display?.ourDestructionPercentage ?? warDetail?.clan?.destructionPercentage ?? warDetail?.our?.destructionPercentage ?? null);
      const oppDes = (display?.oppDestructionPercentage ?? warDetail?.opponent?.destructionPercentage ?? null);

      setText("war-destr-us", (ourDes == null) ? "‚Äî" : `${Number(ourDes)}%`);
      setText("war-destr-opp", (oppDes == null) ? "‚Äî" : `${Number(oppDes)}%`);

      const ourAtkUsed = (display?.ourAttacksUsed ?? warDetail?.clan?.attacks ?? warDetail?.our?.attacks ?? null);
      const oppAtkUsed = (display?.oppAtkUsed ?? warDetail?.opponent?.attacks ?? null);

      setText("war-attacks-us", (ourAtkUsed == null) ? "‚Äî" : (maxAttacks ? `${ourAtkUsed}/${maxAttacks}` : String(ourAtkUsed)));
      setText("war-attacks-opp",(oppAtkUsed == null) ? "‚Äî" : (maxAttacks ? `${oppAtkUsed}/${maxAttacks}` : String(oppAtkUsed)));

      const now = new Date();
      const { start, end } = getWarTimes(display);
      const startOk = start && !isNaN(start.getTime());
      const endOk = end && !isNaN(end.getTime());

      if(endOk && now >= end){
        setText("war-stage-label","WAR ENDED");
        setText("war-timer","");
        return;
      }
      if(startOk && now < start){
        setText("war-stage-label","WAR STARTS IN:");
        setText("war-timer", formatCountdown(start - now));
        return;
      }
      if(endOk && now < end){
        setText("war-stage-label","WAR ENDS IN:");
        setText("war-timer", formatCountdown(end - now));
        return;
      }

      if(state === "preparation"){
        setText("war-stage-label","WAR STARTS IN:");
        setText("war-timer","‚Äî");
        return;
      }
      if(state === "inwar"){
        setText("war-stage-label","WAR ENDS IN:");
        setText("war-timer","‚Äî");
        return;
      }

      setText("war-stage-label","ACTIVE");
      setText("war-timer","‚Äî");
    }

    // =========================
    // War chart helpers
    // =========================
    function starsHTML(n){
      const s = Number(n || 0);
      return `
        <span class="star ${s>=1 ? "" : "dim"}">‚òÖ</span>
        <span class="star ${s>=2 ? "" : "dim"}">‚òÖ</span>
        <span class="star ${s>=3 ? "" : "dim"}">‚òÖ</span>
      `;
    }
    function totalStars(member){
      const atks = Array.isArray(member?.attacks) ? member.attacks : [];
      return atks.reduce((sum,a)=>sum + (Number(a?.stars)||0), 0);
    }
    function niceRole(role){
      const r = String(role || "").trim();
      if(!r) return "";
      const low = r.toLowerCase();
      if(low === "coleader" || low === "co-leader" || low === "coleader" || low === "coLeader") return "Co Leader";
      if(low === "leader") return "Leader";
      if(low === "elder") return "Elder";
      return r;
    }
    function readFirst(obj, keys){
      for(const k of keys){
        const v = obj?.[k];
        if(v !== undefined && v !== null && v !== "") return v;
      }
      return null;
    }
    function roleEmojiForWar(role){
      const r = String(role || "").toLowerCase();
      if(r.includes("leader")) return "üëë";
      if(r === "elder") return "üõ°Ô∏è";
      return "";
    }

    // ‚úÖ FIX #2: canonicalize positions so display is always 1..teamSize
    function canonicalizeWarPositions(members, teamSize){
      const list = (Array.isArray(members) ? members.slice() : []);
      const used = new Set();

      // pass 1: keep valid unique positions
      for(const m of list){
        const raw = m?.mapPosition;
        const pos = (raw === null || raw === undefined || raw === "") ? null : Number(raw);
        if(pos && isFinite(pos) && pos >= 1 && pos <= teamSize && !used.has(pos)){
          m.__pos = pos;
          used.add(pos);
        } else {
          m.__pos = null;
        }
      }

      // helper: next missing slot
      let next = 1;
      function nextSlot(){
        while(next <= teamSize && used.has(next)) next++;
        if(next <= teamSize){
          used.add(next);
          return next++;
        }
        return null;
      }

      // pass 2: fill gaps
      for(const m of list){
        if(m.__pos != null) continue;
        m.__pos = nextSlot();
      }

      // stable sort by canonical pos, then name
      list.sort((a,b)=>{
        const ap = (a.__pos == null ? 999999 : a.__pos);
        const bp = (b.__pos == null ? 999999 : b.__pos);
        if(ap !== bp) return ap - bp;
        return String(a?.name||"").localeCompare(String(b?.name||""));
      });

      return list;
    }

    // =========================
    // War chart render
    // =========================
    function renderWarChart(){
      const mount = document.getElementById("war-chart-mount");
      if(!mount) return;

      if(!warDetailFetched){
        mount.innerHTML = `<div class="muted" style="text-align:center;">Loading war chart‚Ä¶</div>`;
        enableDragScrollEverywhere();
        return;
      }
      if(!warDetail || typeof warDetail !== "object"){
        mount.innerHTML = `<div class="muted" style="text-align:center;">War chart unavailable</div>`;
        enableDragScrollEverywhere();
        return;
      }

      const our = warDetail.our || warDetail.clan || {};
      const opp = warDetail.opponent || {};

      const teamSize =
        Number(warDetail?.teamSize || our?.teamSize || opp?.teamSize || 0) ||
        (Array.isArray(our?.members) ? our.members.length : 0) ||
        0;

      const ourMembersRaw = Array.isArray(our?.members) ? our.members : [];
      const oppMembersRaw = Array.isArray(opp?.members) ? opp.members : [];

      const ourMembers = canonicalizeWarPositions(ourMembersRaw, teamSize || ourMembersRaw.length || 0);
      const oppMembers = canonicalizeWarPositions(oppMembersRaw, teamSize || oppMembersRaw.length || 0);

      function buildLookup(members){
        const byTag = new Map();
        const byPos = new Map(); // canonical pos (1..teamSize)
        for(const m of (members||[])){
          const tag = m?.tag ? String(m.tag) : "";
          const pos = (m?.__pos != null) ? Number(m.__pos) : null;
          if(tag) byTag.set(tag, m);
          if(pos != null && isFinite(pos)) byPos.set(pos, m);
        }
        return { byTag, byPos };
      }
      const ourLU = buildLookup(ourMembers);
      const oppLU = buildLookup(oppMembers);

      function formatDefenderFromAttack(a, defenderSideLU){
        if(!a) return "‚Äî";
        const dName = readFirst(a, ["defenderName","defender","targetName","defenderPlayerName","defender_name"]);
        const dTag  = readFirst(a, ["defenderTag","defender_tag","targetTag","defenderPlayerTag"]);
        const dPos  = readFirst(a, ["defenderMapPosition","defenderPosition","defenderPos","targetMapPosition","defender_mapPosition","targetPosition"]);

        if(dTag && defenderSideLU?.byTag?.has(String(dTag))){
          const m = defenderSideLU.byTag.get(String(dTag));
          const pos = (m?.__pos != null) ? m.__pos : (dPos != null ? dPos : "‚Äî");
          const nm  = m?.name || dName || "‚Äî";
          return `${pos}. ${nm}`;
        }

        const posNum = (dPos != null && dPos !== "") ? Number(dPos) : null;
        if(posNum != null && isFinite(posNum) && defenderSideLU?.byPos?.has(posNum)){
          const m = defenderSideLU.byPos.get(posNum);
          const nm = m?.name || dName || "‚Äî";
          return `${posNum}. ${nm}`;
        }

        if(dName) return String(dName);
        return "‚Äî";
      }

      function rowHTML(member, defenderSideLU){
        const name = member?.name || "‚Äî";
        const mp = (member?.__pos != null) ? member.__pos : "‚Äî";

        const atks = Array.isArray(member?.attacks) ? member.attacks : [];
        const a1 = atks[0] || null;
        const a2 = atks[1] || null;

        const a1Pct = (a1 && a1.destructionPercentage != null) ? `${a1.destructionPercentage}%` : "‚Äî";
        const a2Pct = (a2 && a2.destructionPercentage != null) ? `${a2.destructionPercentage}%` : "‚Äî";

        const a1Stars = a1 ? Number(a1.stars||0) : 0;
        const a2Stars = a2 ? Number(a2.stars||0) : 0;

        const a1Def = formatDefenderFromAttack(a1, defenderSideLU);
        const a2Def = formatDefenderFromAttack(a2, defenderSideLU);

        const roleLabel = niceRole(member?.role);
        const roleInline = roleLabel ? ` <span class="war-name-role">(${escapeHtml(roleLabel)})</span>` : "";

        const em = roleEmojiForWar(member?.role);
        const emHTML = em ? `<span class="war-role-emoji" aria-hidden="true">${em}</span>` : "";

        const nameClass = isLeaderOnly(member?.role) ? "war-leader-underline" : "";

        return `
          <div class="war-sheet-row">
            <div class="war-cell right mono numcol">${escapeHtml(mp)}.</div>

            <div class="war-cell">
              <div class="war-player">
                <div class="name" title="${escapeHtml(name)}">
                  <span class="${nameClass}" style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(name)}</span>
                  ${emHTML}
                  ${roleInline}
                </div>
                <div class="role">TH${member?.townhallLevel ?? member?.townHallLevel ?? "‚Äî"}</div>
              </div>
            </div>

            <div class="war-cell defender stack">
              <div class="atk2">
                <div class="atkline" title="${escapeHtml(a1Def)}">${escapeHtml(a1Def)}</div>
                <div class="atkline" title="${escapeHtml(a2Def)}">${escapeHtml(a2Def)}</div>
              </div>
            </div>

            <div class="war-cell center mono stack">
              <div class="atk2">
                <div class="atkline" style="justify-content:center;">${a1 ? escapeHtml(a1Pct) : "‚Äî"}</div>
                <div class="atkline" style="justify-content:center;">${a2 ? escapeHtml(a2Pct) : "‚Äî"}</div>
              </div>
            </div>

            <div class="war-cell center stack">
              <div class="atk2">
                <div class="stars">${a1 ? starsHTML(a1Stars) : `<span class="muted">‚Äî</span>`}</div>
                <div class="stars">${a2 ? starsHTML(a2Stars) : `<span class="muted">‚Äî</span>`}</div>
              </div>
            </div>

            <div class="war-cell center mono bold">${totalStars(member)}‚òÖ</div>
          </div>
        `;
      }

      function blockHTML(title, isOpp, members){
        const defenderLU = isOpp ? ourLU : oppLU;
        return `
          <div class="war-chart-block">
            <div class="war-chart-head">
              <div class="war-chart-clan" title="${escapeHtml(title || "")}">
                <span>${escapeHtml(title || (isOpp ? "Opponent" : "Our Clan"))}</span>
              </div>
            </div>

            <div class="war-sheet">
              ${(members || []).map(m => rowHTML(m, defenderLU)).join("")}
            </div>
          </div>
        `;
      }

      mount.innerHTML =
        blockHTML(our.name, false, ourMembers) +
        blockHTML(opp.name, true,  oppMembers);

      enableDragScrollEverywhere();
    }

    // =========================
    // Members + ClanStats
    // =========================
    function readIntAny(obj, keys){
      for(const k of keys){
        const v = obj?.[k];
        if(v !== null && v !== undefined && v !== "") return (v|0);
      }
      return 0;
    }
    function getThLevel(m){
      let n = readIntAny(m, ["townHallLevel","th","thLevel","townHall","townhallLevel"]);
      if(n > 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["townHallLevel","th","thLevel","townHall","townhallLevel"]);
      return n > 0 ? n : 0;
    }
    function getWarStars(m){
      let n = readIntAny(m, ["warStars","totalWarStars","warStarCount","totalStars","stars"]);
      if(n >= 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["warStars","totalWarStars","warStarCount","totalStars","stars"]);
      return n >= 0 ? n : 0;
    }
    function getXP(m){
      let n = readIntAny(m, ["expLevel","xp","level"]);
      if(n > 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["expLevel","xp","level"]);
      return n > 0 ? n : 0;
    }
    function getTrophies(m){
      let n = readIntAny(m, ["trophies"]);
      if(n > 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["trophies"]);
      return n > 0 ? n : 0;
    }
    function getDonations(m){
      let n = readIntAny(m, ["donations","troopsDonated","donated"]);
      if(n >= 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["donations","troopsDonated","donated"]);
      return n >= 0 ? n : 0;
    }
    function getDonationsReceived(m){
      let n = readIntAny(m, ["donationsReceived","troopsReceived","received"]);
      if(n >= 0) return n;
      const mm = m?.member || m?.player || m?.raw || null;
      n = readIntAny(mm, ["donationsReceived","troopsReceived","received"]);
      return n >= 0 ? n : 0;
    }
    function roleRank(role){
      const r = String(role || "").toLowerCase();
      if(r.includes("leader")) return 1;
      if(r === "elder" || r === "admin") return 2;
      return 3;
    }
    function compareName(a,b){
      return String(a.name||"").localeCompare(String(b.name||""), undefined, { sensitivity:"base" });
    }

    function ensureSortDropdownBound(){
      const sel = document.getElementById("membersSortSelect");
      if(!sel) return;

      sel.value = membersSortMode;

      if(sel.dataset.bound === "1") return;
      sel.addEventListener("change", () => {
        membersSortMode = sel.value || "role";
        renderMembers();
      });
      sel.dataset.bound = "1";
    }

    function renderMembers(){
      const tbody = document.getElementById("members-body");
      if(!tbody) return;

      ensureSortDropdownBound();

      let list = null;
      if(membersData){
        if(Array.isArray(membersData.members)) list = membersData.members;
        else if(Array.isArray(membersData.items)) list = membersData.items;
        else if(Array.isArray(membersData)) list = membersData;
      }

      if(!list){
        tbody.innerHTML = `<tr><td colspan="8" style="opacity:.75;">Loading‚Ä¶</td></tr>`;
        enableDragScrollEverywhere();
        return;
      }
      if(list.length === 0){
        tbody.innerHTML = `<tr><td colspan="8" style="opacity:.75;">No members found.</td></tr>`;
        enableDragScrollEverywhere();
        return;
      }

      const sorted = list.slice().sort((a,b) => {
        const ta = getTrophies(a), tb = getTrophies(b);
        const xa = getXP(a), xb = getXP(b);
        const wa = getWarStars(a), wb = getWarStars(b);
        const ha = getThLevel(a), hb = getThLevel(b);
        const ra = roleRank(a.role), rb = roleRank(b.role);
        const da = getDonations(a), db = getDonations(b);
        const rxa = getDonationsReceived(a), rxb = getDonationsReceived(b);

        if(membersSortMode === "role"){
          if(ra !== rb) return ra - rb;
          if(tb !== ta) return tb - ta;
          if(xb !== xa) return xb - xa;
          return compareName(a,b);
        }
        if(membersSortMode === "th"){
          if(hb !== ha) return hb - ha;
          if(xb !== xa) return xb - xa;
          if(wb !== wa) return wb - wa;
          return compareName(a,b);
        }
        if(membersSortMode === "trophies"){
          if(tb !== ta) return tb - ta;
          if(xb !== xa) return xb - xa;
          return compareName(a,b);
        }
        if(membersSortMode === "warStars"){
          if(wb !== wa) return wb - wa;
          if(xb !== xa) return xb - xa;
          if(tb !== ta) return tb - ta;
          return compareName(a,b);
        }
        if(membersSortMode === "xp"){
          if(xb !== xa) return xb - xa;
          if(tb !== ta) return tb - ta;
          if(hb !== ha) return hb - ha;
          return compareName(a,b);
        }
        if(membersSortMode === "donated"){
          if(db !== da) return db - da;
          if(xb !== xa) return xb - xa;
          if(tb !== ta) return tb - ta;
          return compareName(a,b);
        }
        if(membersSortMode === "received"){
          if(rxb !== rxa) return rxb - rxa;
          if(xb !== xa) return xb - xa;
          if(tb !== ta) return tb - ta;
          return compareName(a,b);
        }

        if(tb !== ta) return tb - ta;
        if(xb !== xa) return xb - xa;
        return compareName(a,b);
      });

      tbody.innerHTML = sorted.map(m => {
        const badge = roleEmoji(m.role);
        const name = escapeHtml(m.name);
        const th = getThLevel(m);
        const trophies = getTrophies(m);
        const warStars = getWarStars(m);
        const xp = getXP(m);
        const donated = getDonations(m);
        const received = getDonationsReceived(m);
        const leaderClass = isLeaderOnly(m.role) ? "m-leader" : "";

        return `
          <tr>
            <td class="m-emoji">${badge || ""}</td>
            <td><span class="m-user-name ${leaderClass}">${name}</span></td>
            <td class="m-num">${th ? th : "‚Äî"}</td>
            <td class="m-num">${trophies ? trophies : 0}</td>
            <td class="m-num">${warStars ? warStars : 0}</td>
            <td class="m-num">${xp ? xp : 0}</td>
            <td class="m-num">${donated}</td>
            <td class="m-num">${received}</td>
          </tr>
        `;
      }).join("");

      enableDragScrollEverywhere();
    }

    function renderClanStats(){
      const warObj = clanStats?.war || null;

      const descEl = document.getElementById("clan-desc");
      if(descEl){
        const desc = (typeof clanStats?.description === "string") ? clanStats.description.trim() : "";
        descEl.textContent = desc || "‚Äî";
      }

      const cwlLeague = clanStats?.cwl?.currentLeague || "‚Äî";
      const cwlFinish = clanStats?.cwl?.lastFinish || "‚Äî";
      setText("cwl-league", cwlLeague);
      setText("cwl-finish", cwlFinish);

      const hall = clanStats?.clanCapital?.capitalHallLevel;
      setText("capital-hall-level", (typeof hall === "number") ? String(hall) : "‚Äî");

      if(document.getElementById("war-record")){
        ["war-record","war-last10","war-last25","war-last50"].forEach(id => setClass(id,"record-green",false));

        if(warObj){
          const w = warObj.wins ?? 0;
          const l = warObj.losses ?? 0;
          const t = warObj.ties ?? 0;

          const rec = fmtWLTWithPctNums(w,l,t);
          setText("war-record", rec.text);
          setClass("war-record","record-green", hasNoLosses(rec.losses));

          setText("war-streak", `${warObj.currentStreak ?? "‚Äî"}`);
          setText("war-longest", `${warObj.longestStreak ?? "‚Äî"}`);

          const l10 = fmtWLTWithPctObj(warObj.last10);
          const l25 = fmtWLTWithPctObj(warObj.last25);
          const l50 = fmtWLTWithPctObj(warObj.last50);

          setText("war-last10", l10.text);
          setText("war-last25", l25.text);
          setText("war-last50", l50.text);

          setClass("war-last10","record-green", hasNoLosses(l10.losses));
          setClass("war-last25","record-green", hasNoLosses(l25.losses));
          setClass("war-last50","record-green", hasNoLosses(l50.losses));
        } else {
          setText("war-record","‚Äî");
          setText("war-last10","‚Äî");
          setText("war-last25","‚Äî");
          setText("war-last50","‚Äî");
          setText("war-streak","‚Äî");
          setText("war-longest","‚Äî");
        }
      }

      if(document.getElementById("home-war-record")){
        setClass("home-war-record","record-green", false);
        setClass("home-war-last10","record-green", false);

        if(warObj){
          const w = warObj.wins ?? 0;
          const l = warObj.losses ?? 0;
          const t = warObj.ties ?? 0;

          const rec = fmtWLTWithPctNums(w,l,t);
          setText("home-war-record", rec.text);
          setClass("home-war-record","record-green", hasNoLosses(rec.losses));

          const l10 = fmtWLTWithPctObj(warObj.last10);
          setText("home-war-last10", l10.text);
          setClass("home-war-last10","record-green", hasNoLosses(l10.losses));

          setText("home-war-streak", `${warObj.currentStreak ?? "‚Äî"}`);
          setText("home-war-longest", `${warObj.longestStreak ?? "‚Äî"}`);
        } else {
          setText("home-war-record","‚Äî");
          setText("home-war-last10","‚Äî");
          setText("home-war-streak","‚Äî");
          setText("home-war-longest","‚Äî");
        }
      }
    }

    // =========================
    // CWL render helpers
    // =========================
    function getWarsCompleted(payload){
      const warLimit = getActiveWarLimit(payload); // 1..7 or null
    
      // If CWL ended, all 7 wars are completed.
      if(String(payload?.state || "").toLowerCase() === "ended") return 7;
    
      // If we don't know the active war yet, assume none completed.
      if(!warLimit || !isFinite(warLimit)) return 0;
    
      // Exclude the active war day
      return Math.max(0, Math.floor(warLimit) - 1);
    }

    function ensureCwlSelectBound(){
      const sel = document.getElementById("cwlSeasonSelect");
      if(!sel) return;
      if(sel.dataset.bound === "1") return;

      sel.addEventListener("change", async () => {
        const v = sel.value || "current";
        cwlSelected = v;
        try{ localStorage.setItem(CWL_SELECTED_KEY, cwlSelected); }catch(e){}

    
        if(v === "current"){
          cwlSelectedPayload = cwlCurrent;
          renderCwlContent();
        } else {
          await fetchCwlHistory(v);
        }
      });

      sel.dataset.bound = "1";
    }

    function ensureCwlMembersSortBound(){
      const sel = document.getElementById("cwlMembersSortSelect");
      if(!sel) return;

      sel.value = cwlMembersSortMode;

      if(sel.dataset.bound === "1") return;
      sel.addEventListener("change", () => {
        cwlMembersSortMode = sel.value || "rank";
        renderCwlContent();
      });
      sel.dataset.bound = "1";
    }

    function renderCwlSeasonSelect(){
      const sel = document.getElementById("cwlSeasonSelect");
      if(!sel) return;

      ensureCwlSelectBound();

      const seasons = Array.isArray(cwlIndex?.seasons) ? cwlIndex.seasons : [];
      const opts = [];
      opts.push({ value:"current", label:"Current" });

      for(const s of seasons){
        if(!s || typeof s !== "object") continue;
        const key = String(s.seasonKey || "").trim();
        const title = String(s.title || key || "").trim();
        if(!key) continue;
        opts.push({ value:key, label:title });
      }

      const seen = new Set();
      const finalOpts = [];
      for(const o of opts){
        if(seen.has(o.value)) continue;
        seen.add(o.value);
        finalOpts.push(o);
      }

      sel.innerHTML = finalOpts.map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join("");

      const wanted = cwlSelected || "current";
      const hasWanted = finalOpts.some(o => o.value === wanted);
      sel.value = hasWanted ? wanted : "current";

      // Title text is driven by payload in renderCwlContent()
      // but if you want a quick placeholder when selecting history:
      if(sel.value !== "current"){
        setText("cwl-title-text", sel.value);
      }
      
      if(document.getElementById("cwl-title-text")){
        if(sel.value === "current"){
          cwlSelectedPayload = cwlCurrent;
          renderCwlContent();
        }
      }

    }

    function fmtNum(n, fallback="‚Äî"){
      if(n === null || n === undefined || n === "") return fallback;
      const x = Number(n);
      return isFinite(x) ? String(x) : fallback;
    }
    function fmt1(n, fallback="‚Äî"){
      if(n === null || n === undefined || n === "") return fallback;
      const x = Number(n);
      return isFinite(x) ? x.toFixed(1) : fallback;
    }
    
    function normCwlEntry(e, idx){
      if(!e || typeof e !== "object") return null;
    
      let warNum = (e.war != null) ? Number(e.war) : null;
      if((warNum == null || !isFinite(warNum)) && idx >= 0 && idx < 7) warNum = idx + 1;
      if(!isFinite(warNum) || warNum < 1 || warNum > 7) return null;
    
      const defName = (typeof e.defenderName === "string" ? e.defenderName.trim() : "") || "‚Äî";
      let oppRank = (e.defenderPos == null ? null : Number(e.defenderPos));
      oppRank = (oppRank != null && isFinite(oppRank)) ? Math.max(1, Math.round(oppRank)) : null;
    
      const stars = (e.stars === null || e.stars === undefined) ? null : Number(e.stars);
      const destruction = (e.destruction === null || e.destruction === undefined) ? null : Number(e.destruction);
    
      return {
        warNum,
        defName,
        oppRank,
        stars: (stars !== null && isFinite(stars)) ? stars : null,
        destruction: (destruction !== null && isFinite(destruction)) ? destruction : null
      };
    }
  
    
    function getStarsWithBonus(r){
      const sWB = pickNum(r, ["starsWithBonus","stars_plus_bonus","starsPlusBonus"]);
      if(sWB !== null) return sWB;

      const starsBase = pickNum(r, ["stars","starsNoBonus","stars_without_bonus","starsWithoutBonus"]);
      const wins = pickNum(r, ["wins"]) ?? 0;

      const bonus = pickNum(r, ["bonusStars","bonus","bonus_points","bonus_points_stars"]);
      if(starsBase !== null && bonus !== null) return starsBase + bonus;

      if(starsBase !== null) return starsBase + (wins * 10);
      return null;
    }

    function getOurCwlOppNames(payload){
      // returns ["", "", ...] length 7
      const out = Array(7).fill("");
    
      // Try common shapes
      const candidates =
        (Array.isArray(payload?.warDays) ? payload.warDays : null) ||
        (Array.isArray(payload?.days) ? payload.days : null) ||
        (Array.isArray(payload?.wars) ? payload.wars : null) ||
        (Array.isArray(payload?.rounds) ? payload.rounds : null) ||
        null;
    
      if(candidates){
        for(let i=0;i<Math.min(7, candidates.length);i++){
          const d = candidates[i];
          const nm =
            pick(d, ["opponentName","oppName","opponent","enemy","enemyClan","clanOpponent","vs"]) ||
            pick(d?.opponent, ["name"]) ||
            "";
          out[i] = String(nm || "").trim();
        }
      }
    
      // Also accept explicit array if you ever add it in python
      const explicit = Array.isArray(payload?.warOpponents) ? payload.warOpponents : null;
      if(explicit){
        for(let i=0;i<Math.min(7, explicit.length);i++){
          out[i] = String(explicit[i] || "").trim();
        }
      }
    
      return out;
    }

    function buildDefenseRankByWar(payload){
      // returns Map<warNum, Map<playerKey, defRank>>
      // playerKey can be tag if present, otherwise name
      const out = new Map();
    
      const days =
        (Array.isArray(payload?.warDays) ? payload.warDays : null) ||
        (Array.isArray(payload?.days) ? payload.days : null) ||
        (Array.isArray(payload?.wars) ? payload.wars : null) ||
        (Array.isArray(payload?.rounds) ? payload.rounds : null) ||
        [];
    
      for(let i=0;i<Math.min(7, days.length);i++){
        const d = days[i];
        const warNum = (pickNum(d, ["war","warNum","day","dayNum","round"]) ?? (i+1)) | 0;
        if(warNum < 1 || warNum > 7) continue;
    
        // Try common member list shapes
        const players =
          (Array.isArray(d?.clan?.members) ? d.clan.members : null) ||
          (Array.isArray(d?.clanMembers) ? d.clanMembers : null) ||
          (Array.isArray(d?.members) ? d.members : null) ||
          (Array.isArray(d?.players) ? d.players : null) ||
          [];
    
        if(!players.length) continue;
    
        const sorted = players.slice().sort((a,b)=>{
          const ap = pickNum(a, ["mapPosition","position","pos","__pos"]) ?? 999999;
          const bp = pickNum(b, ["mapPosition","position","pos","__pos"]) ?? 999999;
          return ap - bp;
        });
    
        const map = new Map();
        for(let idx=0; idx<sorted.length; idx++){
          const p = sorted[idx];
          const tag = pick(p, ["tag","playerTag"]) || "";
          const name = pick(p, ["name","playerName"]) || "";
          const key = (tag ? String(tag) : String(name)).trim();
          if(!key) continue;
          // ‚úÖ EXACT LOGIC: index in sorted list => rank (1-based)
          map.set(key, idx + 1);
        }
    
        out.set(warNum, map);
      }
    
      return out;
    }

    
    function getActiveWarLimit(payload){
      // 1) Try explicit keys first
      let n =
        pickNum(payload, ["activeWarDay","currentWarDay","warDay","day","round","currentRound","matchDay"]) ??
        pickNum(payload?.meta, ["activeWarDay","currentWarDay","warDay","day","round"]) ??
        null;
    
      let fromMeta = null;
      if(n !== null && isFinite(n)){
        // normalize 0-based to 1-based
        fromMeta = (n >= 0 && n <= 6) ? (n + 1) : n;
        fromMeta = Math.max(1, Math.min(7, Math.floor(fromMeta)));
      }

  // 2) Fallback: infer from whatever wars/days actually exist in memberOverview
  let observedMax = null;
  const members = Array.isArray(payload?.memberOverview) ? payload.memberOverview : [];

  function inferWarNum(e, idx){
    let warNum = (e && e.war != null) ? Number(e.war) : null;
    if((warNum == null || !isFinite(warNum)) && e && e.day != null) warNum = Number(e.day);
    if((warNum == null || !isFinite(warNum)) && idx >= 0 && idx < 7) warNum = idx + 1;
    if(!isFinite(warNum) || warNum < 1 || warNum > 7) return null;
    return Math.floor(warNum);
  }

  function isMeaningful(e){
    if(!e || typeof e !== "object") return false;
    const opp = String(
      e.defenderName ?? e.defender ?? e.opponentName ?? e.opponent ?? e.target ?? e.oppName ?? ""
    ).trim();
    const hasOpp = opp && opp !== "‚Äî" && opp !== "-" && opp.toLowerCase() !== "n/a";

    const stars = (e.stars === null || e.stars === undefined) ? null : Number(e.stars);
    const destr = (e.destruction === null || e.destruction === undefined) ? null : Number(e.destruction);

    const hasStars = (stars !== null && isFinite(stars));
    const hasDestr = (destr !== null && isFinite(destr));

    return hasOpp || hasStars || hasDestr;
  }

  for(const m of members){
    const raw = Array.isArray(m?.wars) ? m.wars : (Array.isArray(m?.days) ? m.days : []);
    for(let idx=0; idx<raw.length; idx++){
      const e = raw[idx];
      if(!isMeaningful(e)) continue;
      const wn = inferWarNum(e, idx);
      if(wn == null) continue;
      observedMax = (observedMax == null) ? wn : Math.max(observedMax, wn);
    }
  }

  // 3) Final: prefer the larger of (meta limit) vs (observed limit)
  if(fromMeta == null && observedMax == null) return null;
  if(fromMeta == null) return observedMax;
  if(observedMax == null) return fromMeta;
  return Math.max(fromMeta, observedMax);
}
    function renderCwlRounds(payload){
      const mount = document.getElementById("cwl-rounds-mount");
      if(!mount) return;
    
      const rounds = Array.isArray(payload?.roundsOverview) ? payload.roundsOverview : [];
        // ‚úÖ prevent flicker + prevent page jumping back to carousel on refresh
        const newHash = fnv1a32(JSON.stringify(rounds));
        const alreadyBuilt = !!mount.querySelector(".rounds-carousel");
        if(alreadyBuilt && cwlRoundsRenderHash === newHash){
          return;
        }
        cwlRoundsRenderHash = newHash;

      if(!rounds.length){
        mount.innerHTML = `<div class="cwl-note">No rounds data yet.</div>`;
        return;
      }
    
      function fmtAtk(used, total){
        const u = Number(used ?? 0);
        const t = Number(total ?? 0);
        if(!isFinite(u) || !isFinite(t)) return "‚Äî";
        return `${Math.floor(u)}/${Math.floor(t)}`;
      }
      function fmtPct(p){
        const x = Number(p);
        if(!isFinite(x)) return "‚Äî";
        return `${Math.round(x)}%`;
      }
      function fmtStars(s){
        const x = Number(s);
        if(!isFinite(x)) return "‚Äî";
        return `${Math.floor(x)}`;
      }
    
      function sideTint(w, side){
        const state = String(w?.state || "").toLowerCase();
        if(state !== "warended") return "rounds-neutral";
    
        const winner = String(w?.winner || "").toLowerCase();
        if(!winner || winner === "tie") return "rounds-neutral";
    
        const isWinner = (winner === side);
        return isWinner ? "rounds-win" : "rounds-lose";
      }
    
      function teamRowHtml(teamObj, tintClass){
        const name  = escapeHtml(teamObj?.name || "Team Name");
        const atk   = fmtAtk(teamObj?.attacksUsed, teamObj?.totalAttacks);
        const pct   = fmtPct(teamObj?.destruction);
        const stars = fmtStars(teamObj?.stars);
    
        return `
          <div class="rounds-side">
            <div class="rounds-name ${tintClass}" title="${name}">${name}</div>
        
            <div class="rounds-stats">
              <span class="rounds-stat">${escapeHtml(atk)} <span aria-hidden="true">‚öîÔ∏è</span></span>
              <span class="rounds-stat">${escapeHtml(pct)}</span>
              <span class="rounds-stat">${escapeHtml(stars)} <span aria-hidden="true">‚≠ê</span></span>
            </div>
          </div>
        `;

      }
    
      function matchupHtml(w){
        const L = w?.clan || {};
        const R = w?.opponent || {};
    
        const lTint = sideTint(w, "clan");
        const rTint = sideTint(w, "opponent");
    
        return `
          <div class="rounds-match">
            ${teamRowHtml(L, lTint)}
            <div class="rounds-mid">vs</div>
            ${teamRowHtml(R, rTint)}
          </div>
        `;
      }
    
      // Build slides
      const slidesHtml = rounds.map(r => {
        const roundNum = Number(r?.round || 0) || 0;
        const wars = Array.isArray(r?.wars) ? r.wars : [];
    
        const matchups = wars.length
          ? wars.map(matchupHtml).join("")
          : `<div class="cwl-note">No wars yet.</div>`;
    
        return `
          <div class="rounds-slide">
            <div class="rounds-round">
              <div class="rounds-round-title">Round ${roundNum || "‚Äî"}</div>
              <div class="rounds-table">
                ${matchups}
              </div>
            </div>
          </div>
        `;
      }).join("");
    
      mount.innerHTML = `
        <div class="rounds-carousel" aria-label="CWL rounds carousel">
          <button class="rounds-arrow left" id="roundsPrev" aria-label="Previous round">‚Äπ</button>
          <div class="rounds-track" id="cwl-rounds-track" aria-label="Rounds track">
            ${slidesHtml}
          </div>
          <button class="rounds-arrow right" id="roundsNext" aria-label="Next round">‚Ä∫</button>
        </div>
      `;
    
      // enable your mouse dragscroll behavior
      enableDragScrollEverywhere();
    
      // init on current war day, else round 1
      setupRoundsCarousel(payload);
    }

    function setupRoundsCarousel(payload){
      const track = document.getElementById("cwl-rounds-track");
      const prevBtn = document.getElementById("roundsPrev");
      const nextBtn = document.getElementById("roundsNext");
      if(!track) return;
    
      const slides = Array.from(track.querySelectorAll(".rounds-slide"));
      if(!slides.length) return;
    
      // ‚úÖ choose initial index:
      // - if user already scrolled/selected a round, STAY there
      // - otherwise, only once per CWL visit, jump to current war day
      let idx = 0;
      
      if(cwlRoundsSavedIndex !== null && isFinite(cwlRoundsSavedIndex)){
        idx = Math.max(0, Math.min(slides.length - 1, Math.floor(cwlRoundsSavedIndex)));
      } else if(!cwlRoundsDidInitThisVisit){
        const warLimit = getActiveWarLimit(payload); // 1..7 or null
        if(warLimit && isFinite(warLimit)){
          idx = Math.max(0, Math.min(slides.length - 1, Math.floor(warLimit) - 1));
        } else {
          idx = 0;
        }
        cwlRoundsDidInitThisVisit = true; // ‚úÖ only do this once
      } else {
        idx = 0;
      }

      function setActiveSlideClass(activeIdx){
        slides.forEach((s, i) => s.classList.toggle("is-active", i === activeIdx));
      }
    
      function scrollToIndex(i, behavior="smooth"){
        const clamped = Math.max(0, Math.min(slides.length - 1, i));
        const s = slides[clamped];
      
        // ‚úÖ Horizontal-only scroll ‚Äî will NOT move the page vertically
        const targetLeft = s.offsetLeft - (track.clientWidth/2) + (s.clientWidth/2);
      
        track.scrollTo({
          left: targetLeft,
          behavior: (behavior === "auto" ? "auto" : "smooth")
        });
      
        updateButtons(clamped);
        idx = clamped;
      
        // ‚úÖ remember what user is viewing
        cwlRoundsSavedIndex = clamped;
      
        // ‚úÖ update dimming
        setActiveSlideClass(clamped);
      }


    
      function getClosestIndex(){
        const center = track.scrollLeft + (track.clientWidth / 2);
        let best = 0;
        let bestDist = Infinity;
    
        for(let i=0;i<slides.length;i++){
          const s = slides[i];
          const sCenter = s.offsetLeft + (s.clientWidth / 2);
          const d = Math.abs(sCenter - center);
          if(d < bestDist){ bestDist = d; best = i; }
        }
        return best;
      }
    
      function updateButtons(current){
        if(!prevBtn || !nextBtn) return;
        prevBtn.disabled = (current <= 0);
        nextBtn.disabled = (current >= slides.length - 1);
      }
    
      // Button clicks
      if(prevBtn && prevBtn.dataset.bound !== "1"){
        prevBtn.addEventListener("click", () => scrollToIndex(getClosestIndex() - 1, "smooth"));
        prevBtn.dataset.bound = "1";
      }
      if(nextBtn && nextBtn.dataset.bound !== "1"){
        nextBtn.addEventListener("click", () => scrollToIndex(getClosestIndex() + 1, "smooth"));
        nextBtn.dataset.bound = "1";
      }
    
      // When user scrolls/swipes, keep buttons accurate
      let t = null;
      track.addEventListener("scroll", () => {
        clearTimeout(t);
        t = setTimeout(() => {
          const cur = getClosestIndex();
          updateButtons(cur);
      
          // ‚úÖ remember where user stopped
          cwlRoundsSavedIndex = cur;
      
          // ‚úÖ update dimming
          setActiveSlideClass(cur);
        }, 10);
      }, { passive:true });

    
      // Initial positioning (no animation)
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          scrollToIndex(idx, "auto");
        });
      });
    
      // Keep snap sane on resize
      window.addEventListener("resize", () => {
        scrollToIndex(getClosestIndex(), "auto");
      }, { passive:true });
    }


    // =========================
    // ‚úÖ CWL render
    // =========================
    function renderCwlContent(){
      if(!document.getElementById("cwl-title-text")) return;

      ensureCwlMembersSortBound();

      const payload = cwlSelectedPayload || (cwlSelected === "current" ? cwlCurrent : null);
      if(payload) renderCwlRounds(payload);

      const title = payload?.title || "CWL";
      setText("cwl-title-text", title);

      // ‚úÖ League name (fix stuck "Loading...")
      const leagueName =
        pick(payload, ["leagueName","league","cwlLeague","cwl_league"]) ||
        pick(payload?.meta, ["leagueName","league","cwlLeague"]) ||
        pick(payload?.league, ["name","leagueName"]) ||
        pick(payload?.group, ["league","leagueName"]) ||
        "‚Äî";
      
      setText("cwl-league-name", leagueName);

      
      // (Status row removed, so no need to set cwl-state anymore)

      // League overview
      const leagueBody = document.getElementById("cwl-leagueoverview-body");
      if(leagueBody){
      
        // ‚úÖ accept multiple schema shapes
        const rows =
          (Array.isArray(payload?.leagueOverview) ? payload.leagueOverview : null) ||
          (Array.isArray(payload?.league_overview) ? payload.league_overview : null) ||
          (Array.isArray(payload?.league?.clans) ? payload.league.clans : null) ||
          (Array.isArray(payload?.clans) ? payload.clans : null) ||
          [];
      
        function normLeagueRow(r){
          if(!r || typeof r !== "object") return { rank:null, name:"‚Äî", wins:0, stars:null, destr:null };
        
          const rank =
            pickNum(r, ["rank","position","place"]) ??
            pickNum(r?.clan, ["rank","position","place"]) ??
            null;
        
          const name =
            pick(r, ["name","clanName","clan_name"]) ||
            pick(r?.clan, ["name","clanName","clan_name"]) ||
            "‚Äî";
        
          const wins =
            pickNum(r, ["wins","warWins","matchWins","roundWins","won"]) ??
            pickNum(r?.stats, ["wins","warWins","matchWins"]) ??
            pickNum(r?.warStats, ["wins"]) ??
            pickNum(r?.clan?.stats, ["wins","warWins","matchWins"]) ??
            0;
        
          // Stars can be stored as total, with bonus, or nested
          let stars =
            pickNum(r, ["starsWithBonus","stars_plus_bonus","starsPlusBonus"]) ??
            pickNum(r?.stats, ["starsWithBonus","starsPlusBonus"]) ??
            pickNum(r?.warStats, ["starsWithBonus","starsPlusBonus"]) ??
          
            // common alternates
            pickNum(r, ["totalStars","starsTotal","stars","total_stars"]) ??
            pickNum(r?.stats, ["totalStars","starsTotal","stars"]) ??
            pickNum(r?.clan?.stats, ["totalStars","starsTotal","stars"]) ??
            null;

        
          // Destruction can be stored as a total (sum) or as pct
          const destr =
            pickNum(r, ["destructionTotal","destruction","destructionPct","destructionPercentage","destruction_total"]) ??
            pickNum(r?.stats, ["destructionTotal","destruction","destructionPercentage"]) ??
            pickNum(r?.warStats, ["destructionTotal","destruction","destructionPercentage"]) ??
            pickNum(r?.clan?.stats, ["destructionTotal","destruction","destructionPercentage"]) ??
            null;
        
          return { rank, name, wins, stars, destr };
        }

      
        if(!rows.length){
          leagueBody.innerHTML = `<tr><td colspan="7" style="opacity:.75; text-align:center; padding:12px;">No league data yet.</td></tr>`;
        } else {
          leagueBody.innerHTML = rows.map(rr => {
            const r = normLeagueRow(rr);
            // ‚úÖ warsCompleted (ENDED only): prefer Python meta, fallback to JS inference
            const warsCompleted =
              pickNum(payload?.meta, ["warsCompleted"]) ??
              getWarsCompleted(payload);
            
            // stars available per war (best-effort)
            const teamSize =
              pickNum(payload, ["teamSize","size"]) ??
              pickNum(payload?.meta, ["teamSize","size"]) ??
              15;
            const maxStarsPerWar = Math.max(0, (teamSize|0) * 3);
            
            // ‚úÖ ended-only totals (Python outputs these)
            const destrEnded =
              pickNum(rr, ["destructionEndedTotal","destruction_ended_total"]) ??
              pickNum(rr?.stats, ["destructionEndedTotal"]) ??
              pickNum(rr?.warStats, ["destructionEndedTotal"]) ??
              null;
            
            const starsEndedNoBonus =
              pickNum(rr, ["starsEndedTotal","stars_ended_total"]) ??
              pickNum(rr?.stats, ["starsEndedTotal"]) ??
              pickNum(rr?.warStats, ["starsEndedTotal"]) ??
              null;
            
            const starsAgainstEnded =
              pickNum(rr, ["starsAgainstEndedTotal","stars_against_ended_total"]) ??
              pickNum(rr?.stats, ["starsAgainstEndedTotal"]) ??
              pickNum(rr?.warStats, ["starsAgainstEndedTotal"]) ??
              null;
            
            // ‚úÖ AVG % (ENDED only)
            const avgPctVal = (warsCompleted > 0 && destrEnded !== null) ? (Number(destrEnded) / warsCompleted) : null;
            const avgPctOut =
              (avgPctVal === null || !isFinite(avgPctVal))
                ? "‚Äî"
                : avgPctVal.toFixed(1);
            
            // ‚úÖ AVG ‚≠ê (ENDED only)
            const avgStarsVal = (warsCompleted > 0 && starsEndedNoBonus !== null) ? (Number(starsEndedNoBonus) / warsCompleted) : null;
            const avgStarsOut =
              (avgStarsVal === null || !isFinite(avgStarsVal))
                ? "‚Äî"
                : `${avgStarsVal.toFixed(1)}/${maxStarsPerWar}`;
            
            // ‚úÖ AVG üõ°Ô∏è (ENDED only)
            const avgDefVal = (warsCompleted > 0 && starsAgainstEnded !== null) ? (Number(starsAgainstEnded) / warsCompleted) : null;
            const avgDefOut =
              (avgDefVal === null || !isFinite(avgDefVal))
                ? "‚Äî"
                : `${avgDefVal.toFixed(1)}/${maxStarsPerWar}`;


            const rankOut = (r.rank === null) ? "‚Äî" : fmtNum(r.rank, "‚Äî");
            const nameOut = escapeHtml(r.name || "‚Äî");
            const winsOut = `${fmtNum(r.wins, "0")}/${fmtNum(warsCompleted, "0")}`;
          
            // ‚úÖ use existing bonus logic if the row doesn't already provide starsWithBonus
            let starsOut = r.stars;
            if(starsOut === null){
              const fallbackStarsWithBonus = getStarsWithBonus(rr);
              starsOut = (fallbackStarsWithBonus === null ? null : fallbackStarsWithBonus);
            }
          
            const destrOut = (r.destr === null) ? "‚Äî" : fmt1(r.destr, "‚Äî");

            // ‚úÖ row color rules
            const rankNum = (r.rank === null) ? null : Number(r.rank);
            const rowClass =
              (rankNum === 1) ? "rank-good" :
              ((rankNum === 7 || rankNum === 8) ? "rank-bad" : "");
          
            return `
              <tr class="${rowClass}">
                <td class="sticky-1 mono">${rankOut}</td>
                <td class="sticky-2 left" title="${nameOut}">${nameOut}</td>
                <td class="mono">${winsOut}</td>
                <td class="mono bold">${starsOut === null ? "‚Äî" : fmtNum(starsOut, "‚Äî")}</td>
                <td class="mono">${destrOut}</td>
                <td class="mono">${avgStarsOut}</td>
                <td class="mono">${avgPctOut}</td>
                <td class="mono">${avgDefOut}</td>
              </tr>
            `;
            


          }).join("");

        }
      }


      // Member overview
      const memberBody = document.getElementById("cwl-memberoverview-body");
      if(memberBody){
        const members = Array.isArray(payload?.memberOverview) ? payload.memberOverview : [];
        if(!members.length){
          const msg = (payload?.state === "notInCwl") ? "Not in CWL right now." : "No member data yet.";
          memberBody.innerHTML = `<tr><td colspan="28" style="opacity:.75; text-align:center; padding:12px;">${escapeHtml(msg)}</td></tr>`;
        } else {
          const sorted = members.slice().sort((a,b)=>{
            const ar = Number(a?.avgRankAttacked ?? a?.avgRank ?? a?.rank ?? 9999);
            const br = Number(b?.avgRankAttacked ?? b?.avgRank ?? b?.rank ?? 9999);
          
            const aTotalStars = Number(a?.totalStars ?? 0);
            const bTotalStars = Number(b?.totalStars ?? 0);
          
            const aTotalPct = Number(a?.totalDestruction ?? a?.totalPct ?? a?.totalPercent ?? 0);
            const bTotalPct = Number(b?.totalDestruction ?? b?.totalPct ?? b?.totalPercent ?? 0);
          
            const aAvgStars = Number(a?.avgStars ?? 0);
            const bAvgStars = Number(b?.avgStars ?? 0);
          
            const aAvgPct = Number(a?.avgDestruction ?? a?.avgPct ?? a?.avgPercent ?? 0);
            const bAvgPct = Number(b?.avgDestruction ?? b?.avgPct ?? b?.avgPercent ?? 0);
          
            const nameCmp = String(a?.name||"").localeCompare(String(b?.name||""));
          
            // Rank: AVG RK > Total Stars > Total %
            if(cwlMembersSortMode === "rank"){
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              if(bTotalStars !== aTotalStars) return bTotalStars - aTotalStars;
              if(bTotalPct !== aTotalPct) return bTotalPct - aTotalPct;
              return nameCmp;
            }
          
            // Total Stars: Total Stars > Total % > AVG RK
            if(cwlMembersSortMode === "totalStars"){
              if(bTotalStars !== aTotalStars) return bTotalStars - aTotalStars;
              if(bTotalPct !== aTotalPct) return bTotalPct - aTotalPct;
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return nameCmp;
            }
          
            // Total %: Total % > Total Stars > AVG RK
            if(cwlMembersSortMode === "totalPct"){
              if(bTotalPct !== aTotalPct) return bTotalPct - aTotalPct;
              if(bTotalStars !== aTotalStars) return bTotalStars - aTotalStars;
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return nameCmp;
            }
          
            // AVG Stars: AVG Stars > AVG % > AVG RK
            if(cwlMembersSortMode === "avgStars"){
              if(bAvgStars !== aAvgStars) return bAvgStars - aAvgStars;
              if(bAvgPct !== aAvgPct) return bAvgPct - aAvgPct;
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return nameCmp;
            }
          
            // AVG %: AVG % > Total Stars > AVG RK
            if(cwlMembersSortMode === "avgPct"){
              if(bAvgPct !== aAvgPct) return bAvgPct - aAvgPct;
              if(bTotalStars !== aTotalStars) return bTotalStars - aTotalStars;
              if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
              return nameCmp;
            }
          
            // fallback
            if(isFinite(ar) && isFinite(br) && ar !== br) return ar - br;
            return nameCmp;
          });
            
          memberBody.innerHTML = sorted.map(m => {
             // Avg Rk (computed from repaired ranks for wars up to warLimit)
            let avgAtkRkVal = null; // üó°Ô∏è RK
            let avgAtkRk = "‚Äî";
            
            let avgDefRkVal = null; // üõ°Ô∏è RK
            let avgDefRk = "‚Äî";




            const nm = escapeHtml(m.name || "‚Äî");

            const totStars = pickNum(m, ["totalStars","starsTotal","total_stars"]) ?? 0;
            const totDes = pickNum(m, ["totalDestruction","totalPct","totalPercent","total_destruction"]) ?? 0;

            const avgStarsVal = pickNum(m, ["avgStars","avg_stars"]) ;
            const avgStars = (avgStarsVal === null) ? "‚Äî" : fmt1(avgStarsVal, "‚Äî");

            const avgDesVal = pickNum(m, ["avgDestruction","avgPct","avgPercent","avg_destruction"]);
            const isPerfect =
              (avgStarsVal !== null && isFinite(avgStarsVal) && avgStarsVal >= 3.0) ||
              (avgDesVal !== null && isFinite(avgDesVal) && avgDesVal >= 100.0);
            
            const rowClass = isPerfect ? "cwl-perfect" : "";

            const avgDes = (avgDesVal === null) ? "‚Äî" : fmt1(avgDesVal, "‚Äî");
        
            // ‚úÖ accept BOTH schemas:
            // - NEW: m.wars = [{war:1..7, opponentName/opponent/defender, stars, destruction, opponentRank, ...}]
            // - OLD: m.days = [{day:1..7, defender, stars, destruction}]
            const entriesRaw = Array.isArray(m.wars)
              ? m.wars
              : (Array.isArray(m.days) ? m.days : []);
                       

            const entries = [];
            for(let idx=0; idx<entriesRaw.length; idx++){
              const n = normCwlEntry(entriesRaw[idx], idx);
              if(n) entries.push(n);
            }

            // Build byWar (first entry wins)
            const byWar = new Map();
            for(const e of entries){
              if(!byWar.has(e.warNum)) byWar.set(e.warNum, e);
            }
           
            
            // ‚úÖ ATK denominator (BEST): trust warsInLineup if Python provides it
            const atkMade = pickNum(m, ["attacksMade","attacks","attacks_made"]) ?? 0;
            const warsInLineup = pickNum(m, ["warsInLineup","wars_in_lineup"]) ?? null;

            // ‚úÖ do NOT count future/prep wars in denominator
            const warLimit = getActiveWarLimit(payload); // 1..7 or null
            // ‚úÖ Avg Rk should use repaired ranks, and ONLY count wars up to warLimit (no prep)
            {
              const limit = warLimit || 0; // if null, treat as 0 (nothing active yet)
              const repairedRanks = [];
            
              for(let warNum=1; warNum<=7; warNum++){
                if(warNum > limit) continue;
            
                const e = byWar.get(warNum);
                if(!e) continue;
                
                // ‚úÖ only count rank if an attack actually happened
                const attacked =
                  (e.stars !== null && isFinite(e.stars)) ||
                  (e.destruction !== null && isFinite(e.destruction));
                if(!attacked) continue;
                
                let rk = (e.oppRank !== null && isFinite(e.oppRank)) ? Math.max(1, Math.round(e.oppRank)) : null;
                if(rk === null) continue;
                  
                repairedRanks.push(rk);

              }
            
              if(repairedRanks.length){
                const sum = repairedRanks.reduce((a,b)=>a+b,0);
                avgAtkRkVal = sum / repairedRanks.length;
                avgAtkRk = fmt1(avgAtkRkVal, "‚Äî");
              } else {
                avgAtkRk = "‚Äî";
              }

              // ‚úÖ üõ°Ô∏è RK: avg defensive map position
              // Build war->(playerKey->defRank) once per render
              // (we‚Äôll compute it lazily outside the map loop below if you prefer, but this works here too)
              const defRankByWar = buildDefenseRankByWar(payload);
              
              {
                const limit = warLimit || 0;
                const defRanks = [];
              
                // prefer tag if present on member; fallback to name
                const memberKey = String(m?.tag || m?.playerTag || m?.name || "").trim();
              
                for(let warNum=1; warNum<=7; warNum++){
                  if(warNum > limit) continue;
              
                  const map = defRankByWar.get(warNum);
                  if(!map) continue;
              
                  const r = map.get(memberKey);
                  if(r != null && isFinite(r)) defRanks.push(r);
                }
              
                // If tag not present in payload memberOverview, fallback to name matching
                if(!defRanks.length){
                  const nameKey = String(m?.name || "").trim();
                  for(let warNum=1; warNum<=7; warNum++){
                    if(warNum > limit) continue;
                    const map = defRankByWar.get(warNum);
                    if(!map) continue;
                    const r = map.get(nameKey);
                    if(r != null && isFinite(r)) defRanks.push(r);
                  }
                }
              
                // If python already provides it, accept it (but only if we couldn't compute)
                if(!defRanks.length){
                  const provided = pickNum(m, ["avgDefRank","avgDefenseRank","avgDefensiveRank","avg_def_rank","avg_defensive_rank"]);
                  if(provided !== null && isFinite(provided)){
                    avgDefRkVal = provided;
                    avgDefRk = fmt1(avgDefRkVal, "‚Äî");
                  } else {
                    avgDefRk = "‚Äî";
                  }
                } else {
                  const sum = defRanks.reduce((a,b)=>a+b,0);
                  avgDefRkVal = sum / defRanks.length;
                  avgDefRk = fmt1(avgDefRkVal, "‚Äî");
                }
              }

            }

            const byWarCountUpToLimit = (() => {
            // If there is no active war day yet, there should be NO denominator
            if(!warLimit) return 0;
          
            let c = 0;
            for(const k of byWar.keys()){
              if(k <= warLimit) c++;
            }
            return c;
          })();
            
            let denom;
            if(warsInLineup !== null && isFinite(warsInLineup) && warsInLineup >= 0){
              // if warsInLineup includes future war, clamp it too
              denom = warsInLineup;
              if(warLimit) denom = Math.min(denom, warLimit);
              denom = Math.max(denom, atkMade);
            } else {
              denom = Math.max(byWarCountUpToLimit, atkMade);
            }

            const atkFrac = `${fmtNum(atkMade,"0")}/${fmtNum(denom,"0")}`;
            
            // War cells
            const warCells = [];
            for(let i=1;i<=7;i++){
              const e = byWar.get(i) || null;
              const isActiveWarDay = (warLimit && i <= warLimit);
            
              let oppText = "‚Äî";
            
              const sVal = (e && e.stars !== null && isFinite(e.stars)) ? e.stars : null;
              const pVal = (e && e.destruction !== null && isFinite(e.destruction)) ? e.destruction : null;
            
              const attacked = (sVal !== null) || (pVal !== null);
            
              // ‚úÖ replacement block goes right here
              if (e && isActiveWarDay && attacked) {
                const rk =
                  (e.oppRank !== null && isFinite(e.oppRank))
                    ? Math.max(1, Math.round(e.oppRank))
                    : null;
            
                const nm = String(e.defName || "‚Äî").trim() || "‚Äî";
            
                if (rk !== null && nm !== "‚Äî") {
                  oppText = `${rk}. ${nm}`;
                }
              }
            
              const opp = escapeHtml(oppText);
              const s = (sVal === null) ? "‚Äî" : fmtNum(sVal, "‚Äî");
              const p = (pVal === null) ? "‚Äî" : fmt1(pVal, "‚Äî");
            
              warCells.push(`<td class="left mono cwl-warcell cwl-day-start" title="${opp}">${opp}</td>`);
              warCells.push(`<td class="mono cwl-warcell">${s}</td>`);
              warCells.push(`<td class="mono cwl-warcell cwl-day-end">${p}</td>`);
            }


            return `
              <tr class="${rowClass}">
                <td class="sticky-1 mono">${avgAtkRk}</td>
                <td class="sticky-2 mono">${avgDefRk}</td>
                <td class="sticky-3 left" title="${nm}">${nm}</td>
            
                <td class="mono bold">${fmtNum(totStars, "0")}</td>
                <td class="mono">${fmt1(totDes, "0.0")}</td>
                <td class="mono">${avgStars}</td>
                <td class="mono">${avgDes}</td>
                <td class="mono cwl-general-sep">${escapeHtml(atkFrac)}</td>
            
                ${warCells.join("")}
              </tr>
            `;

          }).join("");
        }
      }
      // ‚úÖ fill the ‚öîÔ∏è header opponent names
      {
        const oppNames = getOurCwlOppNames(payload);
        for(let i=1;i<=7;i++){
          const id = `cwl-war-oppname-${i}`;
          const nm = oppNames[i-1] || "";
          setText(id, nm);
        }
      }

      enableDragScrollEverywhere();

      // ‚úÖ show scroll hint only when League Overview overflows
      setScrollHintIfScrollable("cwl-league-wrap", "cwl-league-scroll-inline");

    }

    // =========================
    // Loops per route
    // =========================
    function startHomeLoop(){
      clearIntervals(homeIntervals);
      membersSortMode = "role";
      fetchClanStats();
      fetchMembersData();
      homeIntervals.push(setInterval(fetchClanStats, 5000));
      homeIntervals.push(setInterval(fetchMembersData, 10000));
    }

    function startWarLoop(){
      clearIntervals(warIntervals);
      warFetched = false;
      warDetailFetched = false;

      fetchClanStats();
      fetchWarData();
      fetchWarDetail();

      warIntervals.push(setInterval(fetchClanStats, 5000));
      warIntervals.push(setInterval(fetchWarData, 5000));
      warIntervals.push(setInterval(fetchWarDetail, 5000));
      warIntervals.push(setInterval(renderWarSection, 1000));
    }

    function startMoreLoop(){
      clearIntervals(moreIntervals);
      updateRecurringTimers();
      moreIntervals.push(setInterval(updateRecurringTimers, 1000));
    }

    function startCwlLoop(){
      clearIntervals(cwlIntervals);
    
      cwlMembersSortMode = "rank";
    
      // ‚úÖ reset carousel state ONLY when entering CWL page
      cwlRoundsSavedIndex = null;
      cwlRoundsDidInitThisVisit = false;
      cwlRoundsRenderHash = null; // ‚úÖ allow first build when entering CWL
    
      fetchClanStats();
      fetchCwlIndex();
      fetchCwlCurrent();


      cwlIntervals.push(setInterval(fetchClanStats, 15000));
      cwlIntervals.push(setInterval(fetchCwlCurrent, 5000));
      cwlIntervals.push(setInterval(fetchCwlIndex, 60000));

      if(cwlSelected && cwlSelected !== "current"){
        fetchCwlHistory(cwlSelected);
      } else {
        cwlSelectedPayload = cwlCurrent;
        renderCwlContent();
      }
    }

    // =========================
    // More page timers
    // =========================
    function makeUTC(y,m,d,h,mi=0){ return new Date(Date.UTC(y,m,d,h,mi,0)); }

    function getNextRaidWeekendEnd(now){
      const day = now.getUTCDay();
      const diffToFriday = (5 - day + 7) % 7;
      let fridayStart = makeUTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + diffToFriday, 7);
      let mondayEnd = new Date(fridayStart.getTime() + 3*24*60*60*1000);
      if(now >= fridayStart && now <= mondayEnd) return mondayEnd;
      if(now > mondayEnd){
        fridayStart = new Date(fridayStart.getTime() + 7*24*60*60*1000);
        mondayEnd = new Date(fridayStart.getTime() + 3*24*60*60*1000);
      }
      return mondayEnd;
    }
    function getNextClanGamesEnd(now){
      const y=now.getUTCFullYear(), m=now.getUTCMonth();
      const start = makeUTC(y,m,22,8);
      const end   = makeUTC(y,m,28,8);
      if(now < start) return end;
      if(now <= end) return end;
      const nextMonth = new Date(Date.UTC(y, m+1, 1));
      return makeUTC(nextMonth.getUTCFullYear(), nextMonth.getUTCMonth(), 28, 8);
    }
    function getNextSeasonEnd(now){ return makeUTC(now.getUTCFullYear(), now.getUTCMonth()+1, 1, 8); }
    function getNextLeagueReset(now){
      const y=now.getUTCFullYear(), m=now.getUTCMonth();
      let first = makeUTC(y,m,1,5);
      const diffToMonday = (1 - first.getUTCDay() + 7) % 7;
      let reset = makeUTC(y,m,1+diffToMonday,5);
      if(now > reset){
        const nm = new Date(Date.UTC(y, m+1, 1));
        let firstNext = makeUTC(nm.getUTCFullYear(), nm.getUTCMonth(), 1, 5);
        const diffNext = (1 - firstNext.getUTCDay() + 7) % 7;
        reset = makeUTC(nm.getUTCFullYear(), nm.getUTCMonth(), 1+diffNext, 5);
      }
      return reset;
    }
    function updateRecurringTimers(){
      if(!document.getElementById("raid-timer")) return;
      const now = new Date();
      setText("raid-timer", formatCountdown(getNextRaidWeekendEnd(now) - now));
      setText("clan-games-timer", formatCountdown(getNextClanGamesEnd(now) - now));
      setText("season-end-timer", formatCountdown(getNextSeasonEnd(now) - now));
      setText("league-reset-timer", formatCountdown(getNextLeagueReset(now) - now));
    }

    // =========================
    // Router
    // =========================
    function setDocTitle(route){
      const map = {
        home:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî Home",
        cwl:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî CWL",
        war:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî War",
        mystats:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî My Stats",
        more:"B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D ‚Äî More"
      };
      document.title = map[route] || "B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D";
    }

    function renderRoute(){
      const route = normalizeRoute(location.hash);

      setupNavUI();
      setActiveNav(route);
      applyPwaImageIconStates(route);
      setDocTitle(route);

      clearIntervals(homeIntervals);
      clearIntervals(warIntervals);
      clearIntervals(moreIntervals);
      clearIntervals(cwlIntervals);

      app.innerHTML = renderRouteContent(route);

      enableDragScrollEverywhere();

      if(route === "home") startHomeLoop();
      if(route === "war")  startWarLoop();
      if(route === "more") startMoreLoop();
      if(route === "cwl")  startCwlLoop();

      if(isPwaInstalled()) bindPwaTabbarAutoHide();
    }

    if(!location.hash) location.hash = "#/home";
    setupNavUI();
    renderRoute();

    window.addEventListener("hashchange", renderRoute);
    window.addEventListener("pageshow", renderRoute);
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible") renderRoute();
    });

    window.addEventListener("error", (e) => {
      const mount = document.getElementById("war-chart-mount");
      if(mount){
        mount.innerHTML = `<div class="muted" style="text-align:center;font-family:monospace;font-size:12px;">
          JS Error: ${escapeHtml(e.message || "unknown")}
        </div>`;
      }
    });
    window.addEventListener("unhandledrejection", (e) => {
      const mount = document.getElementById("war-chart-mount");
      if(mount){
        mount.innerHTML = `<div class="muted" style="text-align:center;font-family:monospace;font-size:12px;">
          Promise Error: ${escapeHtml(String(e.reason || "unknown"))}
        </div>`;
      }
    });
  </script>
</body>
</html>
