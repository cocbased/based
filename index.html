<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D</title>

  <link rel="apple-touch-icon" href="icon-180.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="/favicon.png">

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <style>
    /* =========================
       Base / Layout
    ========================= */
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
      justify-content:flex-start;
      text-align:center;
      padding:24px 16px;
      box-sizing:border-box;
    }

    /* =========================
       Header
       (smaller)
    ========================= */
    .app-icon{
      width:90px;
      height:90px;
      margin-bottom:12px;
      border-radius:20px;
      object-fit:contain;
    }

    .logo{
      width:100%;
      max-width:225px;
      height:auto;
      margin-bottom:16px;
      border-radius:0;
      object-fit:contain;
    }

    /* =========================
       Clan Tag Link
    ========================= */
    .clan-tag-link{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      font-size:14px;
      display:inline-block;
      margin:8px 0 24px;
    }
    .clan-tag-link:hover{
      text-decoration:underline;
      opacity:1;
    }

    /* =========================
       Card + Rows (generic)
    ========================= */
    .cards{
      width:100%;
      max-width:340px;
      margin-bottom:24px;
      padding:12px 16px;
      border-radius:12px;
      background:#0b1829;
      border:1px solid #2b3b55;
      box-sizing:border-box;
      text-align:left;
    }

    .cards-title{
      margin:0 0 6px;
      font-size:16px;
      text-align:center;
    }

    .section-title{
      margin:10px 0 6px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.75;
      text-align:center;
    }

    .divider{
      height:1px;
      background:rgba(255,255,255,.12);
      margin:10px 0;
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:14px;
      padding:2px 0;
      gap:12px;
    }

    .row-label{
      font-weight:600;
      white-space:nowrap;
    }

    .row-value{
      font-family:monospace;
      text-align:right;
      flex:1;
    }

    /* hide rankings by default */
    #rankings-block{ display:none; }

    /* =========================
       Current War board
    ========================= */
    .war-board{ text-align:center; margin-top:6px; }

    .war-timer{
      font-family:monospace;
      font-weight:900;
      font-size:14px;
      margin:6px 0 10px;
    }

    .war-grid-3{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:10px;
      align-items:center;
    }

    .war-vs{
      font-weight:900;
      font-size:14px;
      opacity:.7;
      text-align:center;
      padding:0 2px;
    }

    .war-name{
      font-weight:800;
      font-size:13px;
      letter-spacing:.05em;
      text-transform:uppercase;
      margin-bottom:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .war-stat{
      font-family:monospace;
      font-weight:900;
      font-size:14px;
      margin-top:6px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:6px;
    }

    .war-substat{
      font-family:monospace;
      font-weight:900;
      font-size:14px;
      margin-top:8px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:6px;
      opacity:.95;
    }

    .war-green{
      color:#38d172;
      font-weight:900;
    }

    .record-green{
      color:#38d172;
      font-weight:900;
    }

    /* =========================================================
       NAV UI (PWA bottom tabs + non-PWA hamburger/side drawer)
       ========================================================= */
    :root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }

    .pwa-tabbar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 10px calc(10px + var(--safe-bottom));
      background: rgba(11, 24, 41, 0.96);
      border-top: 1px solid rgba(43, 59, 85, 0.9);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
    }

    .pwa-tabbar .tabs{
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      max-width: 520px;
      margin: 0 auto;
    }

    .pwa-tabbar a{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:3px;
      padding:10px 6px;
      border-radius:12px;
      text-decoration:none;
      color:#fff;
      font-size:12px;
      opacity:0.9;
      border:1px solid rgba(255,255,255,0.10);
    }

    .pwa-tabbar a:active{ transform: scale(0.98); }
    .pwa-tabbar a.active{
      opacity:1;
      border-color: rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.08);
      font-weight:700;
    }

    body.has-pwa-tabs{
      padding-bottom: calc(80px + var(--safe-bottom));
    }

    .hamburger-btn{
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 10000;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(11,24,41,0.70);
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(8px);
    }
    .hamburger-btn span{ font-size:22px; line-height:1; }

    .drawer-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9998;
      display: none;
    }

    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: min(320px, 85vw);
      background: #0b1829;
      border-left: 1px solid rgba(43, 59, 85, 0.9);
      z-index: 9999;
      transform: translateX(100%);
      transition: transform 200ms ease;
      padding: 16px;
      box-sizing: border-box;
    }
    .drawer.open{ transform: translateX(0); }

    .drawer h3{
      margin: 6px 0 12px;
      font-size: 14px;
      opacity: 0.85;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .drawer a{
      display:block;
      padding:12px 12px;
      margin:6px 0;
      border-radius:12px;
      text-decoration:none;
      color:#fff;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .drawer a:hover{ background: rgba(255,255,255,0.07); }

    .drawer .close-row{
      display:flex;
      justify-content:flex-end;
      margin-bottom:8px;
    }

    .drawer .close-btn{
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.05);
      color: #fff;
      cursor: pointer;
    }
  </style>

  <script>
    function openLink(url){ window.location.href = url; }
  </script>
  <script data-goatcounter="https://based.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</head>

<body>
  <img src="icontransparent.png" alt="B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D icon" class="app-icon" />
  <img src="logo.png" alt="B‚Ä¢A‚Ä¢S‚Ä¢E‚Ä¢D logo" class="logo" onerror="this.style.display='none';" />

  <a
    class="clan-tag-link"
    href="https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y"
    target="_blank"
    rel="noopener noreferrer"
  >#2QQYJC08Y</a>

  <div class="cards">
    <h2 class="cards-title">Clan Overview</h2>

    <div id="rankings-block">
      <div class="section-title">Rankings</div>
      <div class="row">
        <span class="row-label">Global Trophies</span>
        <span id="rank-global-trophies" class="row-value">Loading‚Ä¶</span>
      </div>
      <div class="row">
        <span class="row-label">USA Trophies</span>
        <span id="rank-usa-trophies" class="row-value">Loading‚Ä¶</span>
      </div>
      <div class="divider"></div>
    </div>

    <div class="section-title">CWL</div>
    <div class="row">
      <span class="row-label">CWL League</span>
      <span id="cwl-league" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">Last CWL Finish</span>
      <span id="cwl-finish" class="row-value">Loading‚Ä¶</span>
    </div>

    <div class="divider"></div>

    <div class="section-title">War</div>
    <div class="row">
      <span class="row-label">War Record</span>
      <span id="war-record" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">Last 10 Wars</span>
      <span id="war-last10" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">Last 25 Wars</span>
      <span id="war-last25" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">Last 50 Wars</span>
      <span id="war-last50" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">Current Streak</span>
      <span id="war-streak" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">Longest Streak</span>
      <span id="war-longest" class="row-value">Loading‚Ä¶</span>
    </div>

    <div class="divider"></div>

    <div class="section-title">Current War</div>
    <div class="war-board">
      <div id="war-timer" class="war-timer">Loading‚Ä¶</div>

      <div class="war-grid-3">
        <div>
          <div id="war-name-us" class="war-name">‚Äî</div>
          <div class="war-stat">
            <span id="war-stars-us">‚Äî</span> <span>‚≠ê</span>
          </div>
          <div class="war-substat">
            <span id="war-destr-us">‚Äî</span> <span>üéØ</span>
          </div>
          <div class="war-substat">
            <span id="war-attacks-us">‚Äî</span> <span>‚öîÔ∏è</span>
          </div>
        </div>

        <div id="war-vs" class="war-vs">VS</div>

        <div>
          <div id="war-name-opp" class="war-name">‚Äî</div>
          <div class="war-stat">
            <span id="war-stars-opp">‚Äî</span> <span>‚≠ê</span>
          </div>
          <div class="war-substat">
            <span id="war-destr-opp">‚Äî</span> <span>üéØ</span>
          </div>
          <div class="war-substat">
            <span id="war-attacks-opp">‚Äî</span> <span>‚öîÔ∏è</span>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section-title">In-Game Events</div>
    <div class="row">
      <span class="row-label">Raid Weekend</span>
      <span id="raid-timer" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">Clan Games</span>
      <span id="clan-games-timer" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">Season End</span>
      <span id="season-end-timer" class="row-value">Loading‚Ä¶</span>
    </div>
    <div class="row">
      <span class="row-label">League Reset</span>
      <span id="league-reset-timer" class="row-value">Loading‚Ä¶</span>
    </div>
  </div>

  <!-- NAV UI -->
  <button class="hamburger-btn" id="hamburgerBtn" aria-label="Open menu">
    <span>‚ò∞</span>
  </button>

  <div class="drawer-overlay" id="drawerOverlay"></div>

  <nav class="drawer" id="drawer">
    <div class="close-row">
      <button class="close-btn" id="drawerCloseBtn" aria-label="Close menu">‚úï</button>
    </div>

    <h3>Menu</h3>
    <a href="index.html">Dashboard</a>
    <a href="cwl.html">CWL</a>
    <a href="war.html">WAR</a>
    <a href="my-stats.html">My Stats</a>
    <a href="more.html">More</a>
  </nav>

  <nav class="pwa-tabbar" id="pwaTabbar" aria-label="Bottom navigation">
    <div class="tabs">
      <a href="index.html" data-tab="dashboard">Dashboard</a>
      <a href="cwl.html" data-tab="cwl">CWL</a>
      <a href="war.html" data-tab="war">WAR</a>
      <a href="my-stats.html" data-tab="mystats">My Stats</a>
      <a href="more.html" data-tab="more">More</a>
    </div>
  </nav>

  <script>
    // ============================================================
    // NAV UI: PWA bottom tabs vs non-PWA drawer
    // ============================================================
    function isPwaInstalled(){
      const standaloneDisplay = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const iosStandalone = (typeof navigator !== "undefined") && ("standalone" in navigator) && navigator.standalone;
      return !!(standaloneDisplay || iosStandalone);
    }

    function setupNavUI(){
      const pwa = isPwaInstalled();

      const pwaTabbar = document.getElementById("pwaTabbar");
      const hamburgerBtn = document.getElementById("hamburgerBtn");
      const drawer = document.getElementById("drawer");
      const overlay = document.getElementById("drawerOverlay");
      const closeBtn = document.getElementById("drawerCloseBtn");

      if(pwa){
        if(pwaTabbar) pwaTabbar.style.display = "block";
        if(hamburgerBtn) hamburgerBtn.style.display = "none";
        if(overlay) overlay.style.display = "none";
        if(drawer) drawer.classList.remove("open");
        document.body.classList.add("has-pwa-tabs");

        const path = (location.pathname.split("/").pop() || "index.html").toLowerCase();
        const links = pwaTabbar ? pwaTabbar.querySelectorAll("a") : [];
        links.forEach(a => {
          const href = (a.getAttribute("href") || "").toLowerCase();
          a.classList.toggle("active", href === path);
        });
      } else {
        if(pwaTabbar) pwaTabbar.style.display = "none";
        if(hamburgerBtn) hamburgerBtn.style.display = "flex";
        document.body.classList.remove("has-pwa-tabs");

        const openDrawer = () => {
          if(overlay) overlay.style.display = "block";
          if(drawer) drawer.classList.add("open");
        };
        const closeDrawer = () => {
          if(drawer) drawer.classList.remove("open");
          if(overlay) overlay.style.display = "none";
        };

        if(hamburgerBtn) hamburgerBtn.onclick = openDrawer;
        if(overlay) overlay.onclick = closeDrawer;
        if(closeBtn) closeBtn.onclick = closeDrawer;

        document.addEventListener("keydown", (e) => {
          if(e.key === "Escape") closeDrawer();
        });
      }
    }

    setupNavUI();

    // ============================================================
    // Utilities
    // ============================================================
    function pad(n){ return n.toString().padStart(2,"0"); }

    function formatCountdown(ms){
      if(ms<=0) return "Active now";
      const totalSeconds = Math.floor(ms/1000);
      const days = Math.floor(totalSeconds/86400);
      const hours = Math.floor((totalSeconds%86400)/3600);
      const minutes = Math.floor((totalSeconds%3600)/60);
      const seconds = totalSeconds%60;
      return days+"d "+pad(hours)+"h "+pad(minutes)+"m "+pad(seconds)+"s";
    }

    function makeUTC(y,m,d,h,mi=0){ return new Date(Date.UTC(y,m,d,h,mi,0)); }

    function setText(id, text){
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    }

    function setClass(id, className, on){
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle(className, !!on);
    }

    function setRankingsVisibility(show){
      const block = document.getElementById("rankings-block");
      if(block) block.style.display = show ? "block" : "none";
    }

    function setWarVsVisibility(show){
      const vs = document.getElementById("war-vs");
      if(vs) vs.style.display = show ? "block" : "none";
    }

    // ============================================================
    // Formatting helpers
    // ============================================================
    function fmtTop200(v){
      if(typeof v === "number") return "#" + v;
      return "Not in top 200";
    }

    function fmtPct(v){
      if(typeof v !== "number" || !isFinite(v)) return "‚Äî";
      const rounded = Math.round(v * 10) / 10;
      return (rounded % 1 === 0) ? `${rounded.toFixed(0)}%` : `${rounded.toFixed(1)}%`;
    }

    function isFullStars(stars, teamSize){
      if(typeof stars !== "number" || typeof teamSize !== "number") return false;
      return stars === teamSize * 3;
    }

    function isFullDestruction(pct){
      if(typeof pct !== "number" || !isFinite(pct)) return false;
      return pct === 100;
    }

    function winPctFromWLT(w, l, t){
      const W = (w|0), L = (l|0), T = (t|0);
      const total = W + L + T;
      if(total <= 0) return null;
      return (W + 0.5*T) / total;
    }

    function fmtPctDecimal(p){
      if(typeof p !== "number" || !isFinite(p)) return "";
      return ` (${p.toFixed(3)})`;
    }

    function fmtWLTWithPctObj(obj){
      if(!obj || typeof obj !== "object") return { text: "‚Äî", pct: null, losses: null };
      const w = (typeof obj.wins === "number") ? obj.wins : null;
      const l = (typeof obj.losses === "number") ? obj.losses : null;
      const t = (typeof obj.ties === "number") ? obj.ties : null;
      if(w === null || l === null || t === null) return { text: "‚Äî", pct: null, losses: null };
      const pct = winPctFromWLT(w,l,t);
      return { text: `${w}-${l}-${t}${fmtPctDecimal(pct)}`, pct, losses: l };
    }

    function fmtWLTWithPctNums(w,l,t){
      const pct = winPctFromWLT(w,l,t);
      return { text: `${w}-${l}-${t}${fmtPctDecimal(pct)}`, pct, losses: (l|0) };
    }

    function hasNoLosses(losses){
      return typeof losses === "number" && isFinite(losses) && losses === 0;
    }

    function resetWarHighlights(){
      ["war-stars-us","war-stars-opp","war-destr-us","war-destr-opp"].forEach(id => {
        setClass(id, "war-green", false);
      });
    }

    // ============================================================
    // Data endpoints (RAW = no Pages caching)
    // ============================================================
    const RAW_WAR_URL_BASE  = "https://raw.githubusercontent.com/cocbased/based/main/war.json";
    const RAW_CLAN_URL_BASE = "https://raw.githubusercontent.com/cocbased/based/main/clan_stats.json";

    // ============================================================
    // War module
    // ============================================================
    let warData = null;
    let warFetched = false;

    const LAST_WAR_STORAGE_KEY = "based_last_war_snapshot";
    let lastWarSnapshot = null;

    function loadLastWarSnapshot(){
      try{
        const raw = localStorage.getItem(LAST_WAR_STORAGE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object" && obj.state && obj.state !== "notInWar") return obj;
      } catch(e){}
      return null;
    }

    function saveLastWarSnapshot(w){
      try{ localStorage.setItem(LAST_WAR_STORAGE_KEY, JSON.stringify(w)); } catch(e){}
    }

    lastWarSnapshot = loadLastWarSnapshot();

    async function fetchWarData(){
      try{
        const url = RAW_WAR_URL_BASE + "?cb=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        warData = res.ok ? await res.json() : null;

        if(warData && warData.state && warData.state !== "notInWar"){
          lastWarSnapshot = warData;
          saveLastWarSnapshot(warData);
        }
      } catch(e){
        warData = null;
      }
      warFetched = true;
      renderWarSection();
    }

    function renderWarSection(){
      resetWarHighlights();
      setWarVsVisibility(false);

      if(!warFetched){
        setText("war-timer","Loading‚Ä¶");
        setText("war-name-us","Loading‚Ä¶");
        setText("war-name-opp","Loading‚Ä¶");
        setText("war-stars-us","‚Äî");
        setText("war-stars-opp","‚Äî");
        setText("war-destr-us","‚Äî");
        setText("war-destr-opp","‚Äî");
        setText("war-attacks-us","‚Äî");
        setText("war-attacks-opp","‚Äî");
        return;
      }

      let display = warData;
      if(display && display.state === "notInWar" && lastWarSnapshot){
        display = lastWarSnapshot;
      }

      if(!display || !display.state){
        setText("war-timer","Waiting‚Ä¶");
        return;
      }

      if(display.state === "notInWar"){
        setText("war-timer","No war started");
        setText("war-name-us","‚Äî");
        setText("war-name-opp","‚Äî");
        setText("war-stars-us","‚Äî");
        setText("war-stars-opp","‚Äî");
        setText("war-destr-us","‚Äî");
        setText("war-destr-opp","‚Äî");
        setText("war-attacks-us","‚Äî");
        setText("war-attacks-opp","‚Äî");
        return;
      }

      const showingPrevious = (warData && warData.state === "notInWar" && lastWarSnapshot);

      setWarVsVisibility(true);

      setText("war-name-us",(display.ourName || "US"));
      setText("war-name-opp",(display.oppName || "OPPONENT"));

      const teamSize = (typeof display.teamSize === "number") ? display.teamSize : null;
      const maxStars = teamSize ? teamSize * 3 : null;

      const ourStars = (typeof display.ourStars === "number") ? display.ourStars : 0;
      const oppStars = (typeof display.oppStars === "number") ? display.oppStars : 0;

      setText("war-stars-us", maxStars ? `${ourStars}/${maxStars}` : `${ourStars}`);
      setText("war-stars-opp", maxStars ? `${oppStars}/${maxStars}` : `${oppStars}`);

      const ourDestr =
        (typeof display.ourDestructionPercentage === "number") ? display.ourDestructionPercentage :
        (typeof display.ourDestruction === "number") ? display.ourDestruction :
        null;

      const oppDestr =
        (typeof display.oppDestructionPercentage === "number") ? display.oppDestructionPercentage :
        (typeof display.oppDestruction === "number") ? display.oppDestruction :
        null;

      setText("war-destr-us", fmtPct(ourDestr));
      setText("war-destr-opp", fmtPct(oppDestr));

      if(teamSize && typeof display.ourAttacksUsed === "number" && typeof display.oppAttacksUsed === "number"){
        const total = teamSize * 2;
        const ourUsed = Math.max(0, Math.min(total, display.ourAttacksUsed));
        const oppUsed = Math.max(0, Math.min(total, display.oppAttacksUsed));
        setText("war-attacks-us", `${ourUsed}/${total}`);
        setText("war-attacks-opp", `${oppUsed}/${total}`);
      } else {
        setText("war-attacks-us","Updating‚Ä¶");
        setText("war-attacks-opp","Updating‚Ä¶");
      }

      setClass("war-stars-us","war-green", isFullStars(ourStars, teamSize));
      setClass("war-stars-opp","war-green", isFullStars(oppStars, teamSize));
      setClass("war-destr-us","war-green", isFullDestruction(ourDestr));
      setClass("war-destr-opp","war-green", isFullDestruction(oppDestr));

      updateWarTimerOnly(showingPrevious, display);
    }

    function updateWarTimerOnly(isPrevious, displayOverride){
      const warElem = document.getElementById("war-timer");
      if(!warElem) return;

      const src = displayOverride || warData;

      if(!src || !src.state){
        warElem.textContent = "Waiting‚Ä¶";
        return;
      }

      if(isPrevious){
        if(!src.warEndIso){
          warElem.textContent = "Previous war";
          return;
        }
        const end = new Date(src.warEndIso);
        if(isNaN(end.getTime())) warElem.textContent = "Previous war";
        else warElem.textContent = "Previous war ended";
        return;
      }

      if(src.state === "notInWar" || !src.warEndIso){
        warElem.textContent = "No war started";
        return;
      }

      const end = new Date(src.warEndIso);
      const now = new Date();
      if(isNaN(end.getTime())) warElem.textContent = "No war started";
      else if(now >= end) warElem.textContent = "War ended";
      else warElem.textContent = formatCountdown(end - now);
    }

    // ============================================================
    // Clan stats module
    // ============================================================
    let clanStats = null;

    async function fetchClanStats(){
      try{
        const url = RAW_CLAN_URL_BASE + "?cb=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        clanStats = res.ok ? await res.json() : null;
      } catch(e){
        clanStats = null;
      }
      renderClanStats();
    }

    function renderClanStats(){
      setClass("war-record","record-green", false);
      setClass("war-last10","record-green", false);
      setClass("war-last25","record-green", false);
      setClass("war-last50","record-green", false);

      if(!clanStats){
        setRankingsVisibility(false);
        setText("cwl-league","‚Äî");
        setText("cwl-finish","‚Äî");
        setText("war-record","‚Äî");
        setText("war-last10","‚Äî");
        setText("war-last25","‚Äî");
        setText("war-last50","‚Äî");
        setText("war-streak","‚Äî");
        setText("war-longest","‚Äî");
        return;
      }

      const r = clanStats.rankings || {};
      const hasAnyRank = (typeof r.globalTrophies === "number") || (typeof r.usaTrophies === "number");
      setRankingsVisibility(hasAnyRank);

      if(hasAnyRank){
        setText("rank-global-trophies", fmtTop200(r.globalTrophies));
        setText("rank-usa-trophies", fmtTop200(r.usaTrophies));
      }

      setText("cwl-league", (clanStats.cwl && clanStats.cwl.currentLeague) ? clanStats.cwl.currentLeague : "‚Äî");
      setText("cwl-finish", (clanStats.cwl && clanStats.cwl.lastFinish) ? clanStats.cwl.lastFinish : "‚Äî");

      if(clanStats.war){
        const w = clanStats.war.wins ?? 0;
        const l = clanStats.war.losses ?? 0;
        const t = clanStats.war.ties ?? 0;

        const rec = fmtWLTWithPctNums(w,l,t);
        setText("war-record", rec.text);
        setClass("war-record", "record-green", hasNoLosses(l));

        setText("war-streak", `${clanStats.war.currentStreak ?? "‚Äî"}`);
        setText("war-longest", `${clanStats.war.longestStreak ?? "‚Äî"}`);

        const last10Val = clanStats.war.last10;
        const last25Val = (clanStats.war.last25 !== undefined) ? clanStats.war.last25 : clanStats.war.last25Record;
        const last50Val = (clanStats.war.last50 !== undefined) ? clanStats.war.last50 : clanStats.war.last50Record;

        const l10 = fmtWLTWithPctObj(last10Val);
        const l25 = fmtWLTWithPctObj(last25Val);
        const l50 = fmtWLTWithPctObj(last50Val);

        setText("war-last10", l10.text);
        setText("war-last25", l25.text);
        setText("war-last50", l50.text);

        setClass("war-last10","record-green", hasNoLosses(l10.losses));
        setClass("war-last25","record-green", hasNoLosses(l25.losses));
        setClass("war-last50","record-green", hasNoLosses(l50.losses));
      } else {
        setRankingsVisibility(false);
        setText("war-record","‚Äî");
        setText("war-last10","‚Äî");
        setText("war-last25","‚Äî");
        setText("war-last50","‚Äî");
        setText("war-streak","‚Äî");
        setText("war-longest","‚Äî");
      }
    }

    // ============================================================
    // Recurring events module
    // ============================================================
    function getNextRaidWeekendEnd(now){
      const day = now.getUTCDay();
      const diffToFriday = (5 - day + 7) % 7;
      let fridayStart = makeUTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + diffToFriday, 7);
      let mondayEnd = new Date(fridayStart.getTime() + 3*24*60*60*1000);
      if(now >= fridayStart && now <= mondayEnd) return mondayEnd;
      if(now > mondayEnd){
        fridayStart = new Date(fridayStart.getTime() + 7*24*60*60*1000);
        mondayEnd = new Date(fridayStart.getTime() + 3*24*60*60*1000);
      }
      return mondayEnd;
    }

    function getNextClanGamesEnd(now){
      const y=now.getUTCFullYear(), m=now.getUTCMonth();
      const start = makeUTC(y,m,22,8);
      const end   = makeUTC(y,m,28,8);
      if(now < start) return end;
      if(now <= end) return end;
      const nextMonth = new Date(Date.UTC(y, m+1, 1));
      return makeUTC(nextMonth.getUTCFullYear(), nextMonth.getUTCMonth(), 28, 8);
    }

    function getNextSeasonEnd(now){
      return makeUTC(now.getUTCFullYear(), now.getUTCMonth()+1, 1, 8);
    }

    function getNextLeagueReset(now){
      const y=now.getUTCFullYear(), m=now.getUTCMonth();
      let first = makeUTC(y,m,1,5);
      const diffToMonday = (1 - first.getUTCDay() + 7) % 7;
      let reset = makeUTC(y,m,1+diffToMonday,5);
      if(now > reset){
        const nm = new Date(Date.UTC(y, m+1, 1));
        let firstNext = makeUTC(nm.getUTCFullYear(), nm.getUTCMonth(), 1, 5);
        const diffNext = (1 - firstNext.getUTCDay() + 7) % 7;
        reset = makeUTC(nm.getUTCFullYear(), nm.getUTCMonth(), 1+diffNext, 5);
      }
      return reset;
    }

    function updateRecurringTimers(){
      const now = new Date();
      setText("raid-timer", formatCountdown(getNextRaidWeekendEnd(now) - now));
      setText("clan-games-timer", formatCountdown(getNextClanGamesEnd(now) - now));
      setText("season-end-timer", formatCountdown(getNextSeasonEnd(now) - now));
      setText("league-reset-timer", formatCountdown(getNextLeagueReset(now) - now));
    }

    // ============================================================
    // Boot + intervals
    // ============================================================
    fetchWarData();
    fetchClanStats();
    updateRecurringTimers();

    setInterval(() => {
      updateRecurringTimers();
      updateWarTimerOnly(false, null);
    }, 1000);

    setInterval(fetchWarData, 5*1000);
    setInterval(fetchClanStats, 5*1000);

    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible"){
        fetchWarData();
        fetchClanStats();
        updateRecurringTimers();
      }
    });
  </script>
</body>
</html>
