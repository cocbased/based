<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>B•A•S•E•D</title>

  <link rel="apple-touch-icon" href="icon-180.png" />
  <link rel="manifest" href="manifest.json" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      justify-content: flex-start;
      text-align: center;
      padding: 24px 16px;
      box-sizing: border-box;
    }

    .app-icon {
      width: 120px;
      height: 120px;
      margin-bottom: 12px;
      border-radius: 24px;
      object-fit: contain;
    }

    .logo {
      width: 100%;
      max-width: 300px;
      height: auto;
      margin-bottom: 16px;
      border-radius: 0;
      object-fit: contain;
    }

    .subtitle {
      margin: 8px 0 24px;
      font-size: 14px;
      opacity: 0.7;
    }

    .timers {
      width: 100%;
      max-width: 340px;
      margin-bottom: 24px;
      padding: 12px 16px;
      border-radius: 12px;
      background: #0b1829;
      border: 1px solid #2b3b55;
      box-sizing: border-box;
      text-align: left;
    }

    .timers-title {
      margin: 0 0 6px;
      font-size: 16px;
      text-align: center;
    }

    .section-title {
      margin: 10px 0 6px;
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.75;
      text-align: center;
    }

    .divider {
      height: 1px;
      background: rgba(255,255,255,0.12);
      margin: 10px 0;
    }

    .timer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 2px 0;
      gap: 12px;
    }

    .timer-label {
      font-weight: 600;
      white-space: nowrap;
    }

    .timer-value {
      font-family: monospace;
      text-align: right;
      flex: 1;
    }

    /* ===== Current War board ===== */
    .war-board {
      text-align: center;
      margin-top: 6px;
    }

    .war-timer {
      font-family: monospace;
      font-weight: 900;
      font-size: 14px;
      margin: 6px 0 10px;
    }

    .war-grid-3 {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 10px;
      align-items: center;
    }

    .war-vs {
      font-weight: 900;
      font-size: 14px;
      opacity: 0.7;
      text-align: center;
      padding: 0 2px;
    }

    .war-name {
      font-weight: 800;
      font-size: 13px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .war-stat {
      font-family: monospace;
      font-weight: 900;
      font-size: 14px;
      margin-top: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }

    .war-substat {
      font-family: monospace;
      font-weight: 900;
      font-size: 14px;
      margin-top: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      opacity: 0.95;
    }

    /* Star progress bar */
    .starbar {
      width: 100%;
      max-width: 130px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      overflow: hidden;
      margin: 6px auto 0;
    }
    .starbar-fill {
      height: 100%;
      width: 0%;
      background: rgba(255,255,255,0.75);
      border-radius: 999px;
    }

    /* ============================ */

    .button-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 280px;
    }

    button {
      padding: 12px;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background-color: #ffffff;
      color: #000000;
    }

    .install-button {
      background-color: #ffcc00;
      color: #000;
      border: 2px solid #000;
      padding: 12px 20px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>

  <script>
    function openLink(url) { window.location.href = url; }
  </script>
</head>

<body>
  <img src="icontransparent.png" alt="B•A•S•E•D icon" class="app-icon" />
  <img src="logo.png" alt="B•A•S•E•D logo" class="logo" onerror="this.style.display='none';" />
  <p class="subtitle">EST DECEMBER 2023</p>

  <div class="timers">
    <h2 class="timers-title">Clan Overview</h2>

    <!-- Rankings (trophies only, hidden unless Top 200) -->
    <div id="rankings-block">
      <div class="section-title">Rankings</div>
      <div class="timer-row">
        <span class="timer-label">Global Trophies</span>
        <span id="rank-global-trophies" class="timer-value">Loading…</span>
      </div>
      <div class="timer-row">
        <span class="timer-label">USA Trophies</span>
        <span id="rank-usa-trophies" class="timer-value">Loading…</span>
      </div>
      <div class="divider"></div>
    </div>

    <div class="section-title">CWL</div>
    <div class="timer-row">
      <span class="timer-label">CWL League</span>
      <span id="cwl-league" class="timer-value">Loading…</span>
    </div>
    <div class="timer-row">
      <span class="timer-label">Last CWL Finish</span>
      <span id="cwl-finish" class="timer-value">Loading…</span>
    </div>

    <div class="divider"></div>

    <div class="section-title">War</div>
    <div class="timer-row">
      <span class="timer-label">War Record</span>
      <span id="war-record" class="timer-value">Loading…</span>
    </div>
    <div class="timer-row">
      <span class="timer-label">Current Streak</span>
      <span id="war-streak" class="timer-value">Loading…</span>
    </div>
    <div class="timer-row">
      <span class="timer-label">Longest Streak</span>
      <span id="war-longest" class="timer-value">Loading…</span>
    </div>

    <div class="divider"></div>

    <div class="section-title">Current War</div>

    <div class="war-board">
      <div id="war-timer" class="war-timer">Loading…</div>

      <div class="war-grid-3">
        <div>
          <div id="war-name-us" class="war-name">—</div>

          <div class="war-stat">
            <span id="war-stars-us">—</span> <span>⭐</span>
          </div>
          <div class="starbar">
            <div id="starbar-us" class="starbar-fill"></div>
          </div>

          <!-- ✅ NEW: Avg Destruction row -->
          <div class="war-substat">
            <span id="war-destr-us">—</span> <span>％️⃣</span>
          </div>

          <div class="war-substat">
            <span id="war-attacks-us">—</span> <span>⚔️</span>
          </div>
        </div>

        <div id="war-vs" class="war-vs">VS</div>

        <div>
          <div id="war-name-opp" class="war-name">—</div>

          <div class="war-stat">
            <span id="war-stars-opp">—</span> <span>⭐</span>
          </div>
          <div class="starbar">
            <div id="starbar-opp" class="starbar-fill"></div>
          </div>

          <!-- ✅ NEW: Avg Destruction row -->
          <div class="war-substat">
            <span id="war-destr-opp">—</span> <span>％️⃣</span>
          </div>

          <div class="war-substat">
            <span id="war-attacks-opp">—</span> <span>⚔️</span>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section-title">In-Game Events</div>
    <div class="timer-row">
      <span class="timer-label">Raid Weekend</span>
      <span id="raid-timer" class="timer-value">Loading…</span>
    </div>
    <div class="timer-row">
      <span class="timer-label">Clan Games</span>
      <span id="clan-games-timer" class="timer-value">Loading…</span>
    </div>
    <div class="timer-row">
      <span class="timer-label">Season End</span>
      <span id="season-end-timer" class="timer-value">Loading…</span>
    </div>
    <div class="timer-row">
      <span class="timer-label">League Reset</span>
      <span id="league-reset-timer" class="timer-value">Loading…</span>
    </div>

    <!-- LAST ROW in the board -->
    <div class="timer-row">
      <span class="timer-label">Last Update</span>
      <span id="last-update-board" class="timer-value">Loading…</span>
    </div>
  </div>

  <div class="button-container">
    <button onclick="openLink('https://docs.google.com/spreadsheets/d/e/2PACX-1vQJyBeqDwShAcLD0GMnIvNehs8P9eG3ApO6pltrMHe01bZVJn0k3bIxLobnjBpvqEQNDe_sFcRkZPE8/pubhtml')">CWL Leaderboards</button>
    <button onclick="openLink('https://discord.gg/8P96687dPr')">Clan Discord</button>
    <button onclick="openLink('https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2QQYJC08Y')">Visit B•A•S•E•D</button>
    <button onclick="openLink('https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2G89820YG')">Visit B•A•S•E•D 2</button>
    <button onclick="openLink('https://link.clashofclans.com/en/?action=OpenClanProfile&tag=2JL9VPYRU')">Visit B•A•S•E•D 3</button>
    <button onclick="openLink('https://www.clashofstats.com/clans/based-2QQYJC08Y/summary')">Clan Stats</button>
    <button onclick="openLink('https://store.supercell.com/')">SuperCell Store</button>
    <button class="install-button" onclick="openLink('https://www.youtube.com/watch?v=gIC30U39zpA')">How to install B•A•S•E•D App</button>
  </div>

  <script>
    function pad(n){ return n.toString().padStart(2,"0"); }

    function formatCountdown(ms){
      if(ms<=0) return "Active now";
      const totalSeconds = Math.floor(ms/1000);
      const days = Math.floor(totalSeconds/86400);
      const hours = Math.floor((totalSeconds%86400)/3600);
      const minutes = Math.floor((totalSeconds%3600)/60);
      const seconds = totalSeconds%60;
      return days+"d "+pad(hours)+"h "+pad(minutes)+"m "+pad(seconds)+"s";
    }

    function makeUTC(y,m,d,h,mi=0){ return new Date(Date.UTC(y,m,d,h,mi,0)); }

    function setText(id, text){
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    }

    function setRankingsVisibility(show){
      const block = document.getElementById("rankings-block");
      if(block) block.style.display = show ? "block" : "none";
    }

    function setWarVsVisibility(show){
      const vs = document.getElementById("war-vs");
      if(vs) vs.style.display = show ? "block" : "none";
    }

    function setBarWidth(id, pct){
      const el = document.getElementById(id);
      if(!el) return;
      const clamped = Math.max(0, Math.min(100, pct));
      el.style.width = clamped.toFixed(1) + "%";
    }

    // ===== live "Last update" inside board =====
    let lastUpdatedIso = null;

    function updateLastUpdateLine(){
      const el = document.getElementById("last-update-board");
      if(!el) return;

      if(!lastUpdatedIso){
        el.textContent = "Loading…";
        return;
      }

      const d = new Date(lastUpdatedIso);
      if(isNaN(d.getTime())){
        el.textContent = "—";
        return;
      }

      const now = new Date();
      const ageSec = Math.max(0, Math.floor((now - d) / 1000));
      el.textContent = `${d.toLocaleString()} (${ageSec}s ago)`;
    }

    function fmtTop200(v){
      if(typeof v === "number") return "#" + v;
      return "Not in top 200";
    }

    function fmtPct(v){
      if(typeof v !== "number" || !isFinite(v)) return "—";
      // show 1 decimal only if needed
      const rounded = Math.round(v * 10) / 10;
      return (rounded % 1 === 0) ? `${rounded.toFixed(0)}%` : `${rounded.toFixed(1)}%`;
    }

    // ---- war.json ----
    let warData = null;
    let warFetched = false;

    async function fetchWarData(){
      try{
        const res = await fetch("war.json?cb="+Date.now(), { cache:"no-store" });
        if(!res.ok) warData = null;
        else warData = await res.json();
      } catch(e){
        warData = null;
      }
      warFetched = true;
      renderWarSection();
    }

    function renderWarSection(){
      setWarVsVisibility(false);

      if(!warFetched){
        setText("war-timer", "Loading…");
        setText("war-name-us", "Loading…");
        setText("war-name-opp", "Loading…");
        setText("war-stars-us", "—");
        setText("war-stars-opp", "—");
        setText("war-destr-us", "—");
        setText("war-destr-opp", "—");
        setText("war-attacks-us", "—");
        setText("war-attacks-opp", "—");
        setBarWidth("starbar-us", 0);
        setBarWidth("starbar-opp", 0);
        return;
      }

      if(!warData || !warData.state){
        setText("war-timer", "Waiting…");
        setText("war-name-us", "—");
        setText("war-name-opp", "—");
        setText("war-stars-us", "—");
        setText("war-stars-opp", "—");
        setText("war-destr-us", "—");
        setText("war-destr-opp", "—");
        setText("war-attacks-us", "—");
        setText("war-attacks-opp", "—");
        setBarWidth("starbar-us", 0);
        setBarWidth("starbar-opp", 0);
        return;
      }

      if(warData.state === "notInWar"){
        setText("war-timer", "No war started");
        setText("war-name-us", "—");
        setText("war-name-opp", "—");
        setText("war-stars-us", "—");
        setText("war-stars-opp", "—");
        setText("war-destr-us", "—");
        setText("war-destr-opp", "—");
        setText("war-attacks-us", "—");
        setText("war-attacks-opp", "—");
        setBarWidth("starbar-us", 0);
        setBarWidth("starbar-opp", 0);
        return;
      }

      setWarVsVisibility(true);

      setText("war-name-us", (warData.ourName || "US"));
      setText("war-name-opp", (warData.oppName || "OPPONENT"));

      // stars fraction: stars / (teamSize*3)
      const teamSize = (typeof warData.teamSize === "number") ? warData.teamSize : null;
      const maxStars = (teamSize ? teamSize * 3 : null);

      const ourStars = (typeof warData.ourStars === "number") ? warData.ourStars : 0;
      const oppStars = (typeof warData.oppStars === "number") ? warData.oppStars : 0;

      setText("war-stars-us", maxStars ? `${ourStars}/${maxStars}` : `${ourStars}`);
      setText("war-stars-opp", maxStars ? `${oppStars}/${maxStars}` : `${oppStars}`);

      // star progress bars
      const ourStarPct = (maxStars ? (ourStars / maxStars) * 100 : 0);
      const oppStarPct = (maxStars ? (oppStars / maxStars) * 100 : 0);
      setBarWidth("starbar-us", ourStarPct);
      setBarWidth("starbar-opp", oppStarPct);

      // ✅ Avg destruction: supports either ourDestruction or ourDestructionPercentage
      const ourDestr =
        (typeof warData.ourDestruction === "number") ? warData.ourDestruction :
        (typeof warData.ourDestructionPercentage === "number") ? warData.ourDestructionPercentage :
        null;

      const oppDestr =
        (typeof warData.oppDestruction === "number") ? warData.oppDestruction :
        (typeof warData.oppDestructionPercentage === "number") ? warData.oppDestructionPercentage :
        null;

      setText("war-destr-us", fmtPct(ourDestr));
      setText("war-destr-opp", fmtPct(oppDestr));

      // Attacks USED / TOTAL (40 total in 20v20)
      const totalAttacks = (teamSize ? teamSize * 2 : null);

      const ourRemaining = (typeof warData.ourAttacksRemaining === "number") ? warData.ourAttacksRemaining : 0;
      const oppRemaining = (typeof warData.oppAttacksRemaining === "number") ? warData.oppAttacksRemaining : 0;

      const ourUsed = (totalAttacks !== null) ? Math.max(0, totalAttacks - ourRemaining) : 0;
      const oppUsed = (totalAttacks !== null) ? Math.max(0, totalAttacks - oppRemaining) : 0;

      setText("war-attacks-us", totalAttacks ? `${ourUsed}/${totalAttacks}` : `${ourUsed}`);
      setText("war-attacks-opp", totalAttacks ? `${oppUsed}/${totalAttacks}` : `${oppUsed}`);

      updateWarTimerOnly();
    }

    function updateWarTimerOnly(){
      const warElem = document.getElementById("war-timer");
      if(!warElem) return;

      if(!warFetched || !warData || !warData.state){
        warElem.textContent = "Waiting…";
        return;
      }
      if(warData.state === "notInWar" || !warData.warEndIso){
        warElem.textContent = "No war started";
        return;
      }

      const end = new Date(warData.warEndIso);
      const now = new Date();
      if(isNaN(end.getTime())) warElem.textContent = "No war started";
      else if(now >= end) warElem.textContent = "War ended";
      else warElem.textContent = formatCountdown(end - now);
    }

    // ---- clan_stats.json ----
    let clanStats = null;

    async function fetchClanStats(){
      try{
        const url = "clan_stats.json?cb="+Date.now();
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok){
          clanStats = null;
          lastUpdatedIso = null;
          renderClanStats();
          return;
        }
        clanStats = await res.json();
        lastUpdatedIso = (clanStats && clanStats.updatedAt) ? clanStats.updatedAt : null;
        renderClanStats();
      } catch(e){
        clanStats = null;
        lastUpdatedIso = null;
        renderClanStats();
      }
    }

    function renderClanStats(){
      if(!clanStats){
        setRankingsVisibility(false);
        setText("cwl-league", "—");
        setText("cwl-finish", "—");
        setText("war-record", "—");
        setText("war-streak", "—");
        setText("war-longest", "—");
        return;
      }

      const r = clanStats.rankings || {};
      const hasAnyRank =
        (typeof r.globalTrophies === "number") ||
        (typeof r.usaTrophies === "number");

      setRankingsVisibility(hasAnyRank);

      if(hasAnyRank){
        setText("rank-global-trophies", fmtTop200(r.globalTrophies));
        setText("rank-usa-trophies", fmtTop200(r.usaTrophies));
      }

      setText("cwl-league", (clanStats.cwl && clanStats.cwl.currentLeague) ? clanStats.cwl.currentLeague : "—");
      setText("cwl-finish", (clanStats.cwl && clanStats.cwl.lastFinish) ? clanStats.cwl.lastFinish : "—");

      if(clanStats.war){
        const w = clanStats.war.wins ?? 0;
        const l = clanStats.war.losses ?? 0;
        const t = clanStats.war.ties ?? 0;
        setText("war-record", `${w}-${l}-${t}`);
        setText("war-streak", `${clanStats.war.currentStreak ?? "—"}`);
        setText("war-longest", `${clanStats.war.longestStreak ?? "—"}`);
      } else {
        setText("war-record", "—");
        setText("war-streak", "—");
        setText("war-longest", "—");
      }
    }

    // ---- recurring timers ----
    function getNextRaidWeekendEnd(now){
      const day = now.getUTCDay();
      const diffToFriday = (5 - day + 7) % 7;
      let fridayStart = makeUTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + diffToFriday, 7);
      let mondayEnd = new Date(fridayStart.getTime() + 3*24*60*60*1000);
      if(now >= fridayStart && now <= mondayEnd) return mondayEnd;
      if(now > mondayEnd){
        fridayStart = new Date(fridayStart.getTime() + 7*24*60*60*1000);
        mondayEnd = new Date(fridayStart.getTime() + 3*24*60*60*1000);
      }
      return mondayEnd;
    }

    function getNextClanGamesEnd(now){
      const y=now.getUTCFullYear(), m=now.getUTCMonth();
      const start = makeUTC(y,m,22,8);
      const end   = makeUTC(y,m,28,8);
      if(now < start) return end;
      if(now <= end) return end;
      const nextMonth = new Date(Date.UTC(y, m+1, 1));
      return makeUTC(nextMonth.getUTCFullYear(), nextMonth.getUTCMonth(), 28, 8);
    }

    function getNextSeasonEnd(now){
      return makeUTC(now.getUTCFullYear(), now.getUTCMonth()+1, 1, 8);
    }

    function getNextLeagueReset(now){
      const y=now.getUTCFullYear(), m=now.getUTCMonth();
      let first = makeUTC(y,m,1,5);
      const diffToMonday = (1 - first.getUTCDay() + 7) % 7;
      let reset = makeUTC(y,m,1+diffToMonday,5);
      if(now > reset){
        const nm = new Date(Date.UTC(y, m+1, 1));
        let firstNext = makeUTC(nm.getUTCFullYear(), nm.getUTCMonth(), 1, 5);
        const diffNext = (1 - firstNext.getUTCDay() + 7) % 7;
        reset = makeUTC(nm.getUTCFullYear(), nm.getUTCMonth(), 1+diffNext, 5);
      }
      return reset;
    }

    function updateRecurringTimers(){
      const now = new Date();
      setText("raid-timer", formatCountdown(getNextRaidWeekendEnd(now) - now));
      setText("clan-games-timer", formatCountdown(getNextClanGamesEnd(now) - now));
      setText("season-end-timer", formatCountdown(getNextSeasonEnd(now) - now));
      setText("league-reset-timer", formatCountdown(getNextLeagueReset(now) - now));
    }

    // Initial load
    fetchWarData();
    fetchClanStats();
    updateRecurringTimers();
    updateLastUpdateLine();

    // tick every second for countdowns + live last update age
    setInterval(() => {
      updateRecurringTimers();
      updateWarTimerOnly();
      updateLastUpdateLine();
    }, 1000);

    // refetch JSON every 60s
    setInterval(fetchWarData, 60*1000);
    setInterval(fetchClanStats, 60*1000);

    // SNAP REFRESH when app/tab becomes visible again
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        fetchWarData();
        fetchClanStats();
        updateRecurringTimers();
        updateLastUpdateLine();
      }
    });
  </script>
</body>
</html>
